# Development Plan

## プロジェクト概要

AkiGura は、グラウンドや体育館などの空き枠を自動で監視し、希望する条件に合う枠が出た際に通知するサービス。ターゲットは草野球やサッカーなどのチーム、学校や自治体の施設管理者など、コードに詳しくない層を含むため、運用しやすく安定した SaaS を提供することが目的。

### 目的とゴール

- ユーザーごとの監視条件の実現: 曜日・時間帯・期間を自由に組み合わせ、ユーザーが登録した条件にマッチする枠だけを通知する
- 拡張性と安定性: 利用者が増えても安定稼働できるよう、スクレイピング部分とユーザー管理・通知部分を分離して開発する
- OSS としての公開: コア部分を OSS (Apache License 2.0) で公開し、地域コミュニティや自治体のコントリビューションを受け入れやすくする
- 商用サポート: SaaS として提供し、インフラ運用やアップデート、課金処理を提供することでビジネスを成立させる

---

## アーキテクチャ

### 現在のコンポーネント構成

```text
akigura/
├── control-plane/         … Go 製バックエンド API サーバー
│   ├── cmd/srv/           … メインエントリポイント
│   ├── srv/               … HTTP ハンドラ、テンプレート
│   ├── db/                … マイグレーション
│   ├── ent/               … O/Rマッパ (entgo.io)
│   └── billing/           … Stripe 課金統合
├── worker/                … Python スクレイパーラッパー + Go ワーカー
│   ├── scraper_wrapper.py … 各自治体スクレイパー呼び出し
│   ├── worker.go          … cron 駆動のスクレイピング実行
│   └── matcher.go         … 条件マッチング処理
├── docs/                  … 設計資料
└── .github/               … CI/CD 設定
```

### 対応自治体

| 自治体 | スクレイパー | ステータス |
|--------|--------------|------------|
| 横浜市 | yokohama | 稼働中 |
| 平塚市 | hiratsuka | 稼働中 |
| 神奈川県 | kanagawa | 稼働中 |
| 鎌倉市 | kamakura | 稼働中 |
| 綾瀬市 | ayase | 稼働中 |
| 藤沢市 | fujisawa | 接続不可（IP制限の可能性） |

### データモデル

| モデル | 説明 |
|--------|------|
| Team | ユーザー/チームを表し、メールアドレスや認証情報、課金プランを保持 |
| Municipality | 自治体を表し、スクレイパータイプと URL を保持 |
| Ground | 施設/グラウンドを表し、自治体との紐づけとコートパターンを保持 |
| WatchCondition | 監視条件。ground_id、days_of_week、time_from・time_to など |
| Slot | スクレイピング結果。施設 ID、日付、時間帯、コート名などを保持 |
| ScrapeJob | スクレイピング実行ログ。ステータス、診断情報を保持 |

---

## 完了済みフェーズ

### Phase 1: スクレイピングコアの整理 - 完了

- ground-reservation リポジトリのスクレイパーを worker/scraper_wrapper.py 経由で呼び出し
- 統一された JSON 形式で結果を返す
- 横浜、平塚、神奈川、鎌倉、綾瀬の 5 自治体に対応

### Phase 2: バックエンド API の MVP - 完了

- Go + ent O/R マッパで構築
- Turso (libSQL) をデータベースとして使用
- 認証 (Google OAuth + Basic Auth)
- 主要エンドポイント実装済み

### Phase 3: Worker の作成 - 完了

- Go 製 Worker が cron 駆動でスクレイピング実行
- Python スクレイパーを subprocess で呼び出し
- 結果を DB に保存

### Phase 4: 管理画面 UI - 完了

- HTMX + Alpine.js でインタラクティブな管理画面
- ダッシュボード、チーム管理、施設管理、スクレイピングログ
- カレンダービュー、狙い目分析機能
- レスポンシブデザイン対応

### Phase 5: 課金統合 - 進行中

- Stripe Checkout / Billing Portal の基本実装完了
- Webhook 署名検証実装済み
- 本番環境での動作検証が未完了

---

## 現在の課題

### 藤沢市スクレイパーの接続問題 - 2026-01-27

**問題**:
- 藤沢市の予約システム (`yoyaku.city.fujisawa.kanagawa.jp`) への接続が `Connection reset by peer` で失敗する
- 藤沢市の公式サイト (`www.city.fujisawa.kanagawa.jp`) には接続可能
- curl、Python requests、ブラウザすべてで同様のエラー

**推測される原因**:
- 藤沢市の予約システムが AWS IP (44.240.253.236) からの接続をブロックしている可能性
- ボット対策として特定 IP レンジを拒否している可能性

**対応案**:
1. 住宅 IP からのプロキシ経由でアクセスする
2. 藤沢市のシステム管理者に連絡して許可を得る
3. 一時的に藤沢市のスクレイピングを無効化する

---

## 今後の計画

### Phase 6: 通知機能の実装

**タスク**:
- [ ] SendGrid API 連携
- [ ] メール文面のテンプレート作成
- [ ] LINE/Slack 対応の抽象化

### Phase 7: OSS 公開準備

**タスク**:
- [ ] README.md 整備
- [ ] CONTRIBUTING.md 作成
- [ ] Issue/PR テンプレート作成

---

## 振り返り (Retrospective)

### Turso への移行 - 2026-01-17

- 問題: npm が入っておらず Turso CLI インストールに失敗した
- 根本原因: グローバル npm が環境に未導入だった
- 予防策: CLI インストール時には公式スクリプトやバイナリを直接使用する

### テーブル UI 改善 - 2026-01-25

- ソート、ページネーション、編集・削除機能を追加
- 施設管理の取得先を facilities API に切り替え
- make before-commit で lint/test/build を通過

### 藤沢市接続問題 - 2026-01-27

- 問題: 藤沢市予約システムへの接続がリセットされる
- 根本原因: おそらく藤沢市側の IP ベースのアクセス制限
- 対応: 調査中。プロキシ経由または藤沢市への連絡を検討
