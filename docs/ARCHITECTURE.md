# AkiGura アーキテクチャ設計書

## 概要

公共施設（グラウンド等）の空き情報を監視し、ユーザーに通知するサービス。

## 設計原則

### プライバシー重視

- **個人情報を持たない**: メールアドレス等は認証サービス（Clerk）側で管理
- **Cookie不使用**: トラッキングしない
- **アクセス解析なし**: Google Analytics等は入れない

### シンプルな構成

- ユーザーは初回設定後、基本的にシステムにアクセスしない
- 通知メールから直接予約サイトへ遷移

---

## システム構成

```
┌─────────────────────────────────────────────────────────┐
│                      ユーザー                            │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  Clerk（認証）                           │
│  - マジックリンク認証（パスワードレス）                    │
│  - メールアドレス管理                                    │
│  - チーム/組織機能                                       │
└─────────────────┬───────────────────────────────────────┘
                  │ ユーザーID（UUID）のみ
                  ▼
┌─────────────────────────────────────────────────────────┐
│                AkiGura サーバー                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  Web UI     │  │  Worker     │  │  Control    │     │
│  │  (設定画面) │  │ (スクレイパー)│  │  Plane     │     │
│  └─────────────┘  └──────┬──────┘  └─────────────┘     │
│                          │                              │
│  ┌───────────────────────┴────────────────────────┐    │
│  │              SQLite Database                    │    │
│  │  - ユーザーID（Clerk UUID）                      │    │
│  │  - 監視条件                                     │    │
│  │  - Stripe顧客ID                                 │    │
│  │  - 施設/自治体マスター                          │    │
│  │  ※メールアドレスは保存しない                    │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────┬───────────────────────────────────────┘
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
┌───────────────┐   ┌───────────────┐
│  Amazon SES   │   │    Stripe     │
│  (メール送信)  │   │   (課金)      │
└───────────────┘   └───────────────┘
```

---

## 認証フロー

```
1. ユーザーがメールアドレスを入力
2. Clerkがマジックリンクをメール送信
3. ユーザーがリンクをクリック
4. Clerkが認証、AkiGuraにユーザーID（UUID）を返す
5. AkiGuraはUUIDのみ保存（メアドは保存しない）
```

### なぜClerkか

- マジックリンク（パスワードレス）標準対応
- チーム/組織機能が無料枠で使える
- 10,000 MAUまで無料
- メールアドレス管理をClerkに委譲できる

---

## 通知フロー

```
1. Worker が定期的に自治体サイトをスクレイピング
2. 空き枠を検出
3. 監視条件にマッチするユーザーを特定
4. Clerk API でユーザーのメールアドレスを取得
5. Amazon SES でメール送信
6. メール内に予約サイトへの直リンクを含める
```

### メール送信サービス選定

| サービス | 料金 | 選定理由 |
|---------|------|----------|
| Amazon SES | $0.10/1,000通 | 圧倒的に安い、スケール可能 |
| Resend | 3,000通/月無料 | 開発しやすいが、スケール時にコスト増 |
| SendGrid | 100通/日無料 | 無料枠が少ない |

→ **Amazon SES** を採用

---

## 課金モデル

### プラン構成（案）

| プラン | 料金 | 内容 |
|-------|------|------|
| Free | ¥0 | 土曜午前のみ監視、1自治体 |
| Personal | ¥500/月 | 全時間帯監視、1自治体 |
| Team | ¥2,000/月 | 全時間帯、複数自治体、チーム共有 |

### 実装

- Stripe Checkout で決済
- Stripe顧客ID を AkiGura に保存
- Webhook で支払い状態を同期
- 決済情報（カード番号等）は Stripe 側で管理

---

## データモデル

### AkiGura が保存するデータ

```sql
-- ユーザー（個人情報なし）
users (
  id UUID PRIMARY KEY,        -- Clerk のユーザーID
  stripe_customer_id TEXT,    -- Stripe 顧客ID
  plan TEXT,                  -- free/personal/team
  created_at TIMESTAMP
)

-- チーム
teams (
  id UUID PRIMARY KEY,
  name TEXT,
  owner_id UUID REFERENCES users(id),
  created_at TIMESTAMP
)

-- 監視条件
watch_conditions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  team_id UUID REFERENCES teams(id),
  municipality_id UUID,
  ground_id UUID,
  day_of_week TEXT,           -- 'saturday', 'sunday', etc.
  time_from TEXT,
  time_to TEXT,
  enabled BOOLEAN,
  created_at TIMESTAMP
)
```

### AkiGura が保存しないデータ

- メールアドレス（Clerk が管理）
- パスワード（マジックリンク認証のため不要）
- 決済情報（Stripe が管理）
- アクセスログ

---

## スケーラビリティ

### 負荷の特性

| 要因 | スケール時の影響 |
|------|------------------|
| ユーザー数増加 | ほぼ影響なし（アクセス少ない） |
| 自治体数増加 | スクレイピング負荷増 |
| 通知数増加 | SES で処理（サーバー負荷小） |

### ボトルネック予測

1. **Clerk 10,000 MAU** - 最初に来る上限、超えたら $25/月〜
2. **スクレイピング並列度** - 自治体 100+ で要最適化
3. **SES 送信レート** - デフォルト 14通/秒、申請で引き上げ可

### 監視すべきメトリクス

- MAU（Clerk 上限）
- MRR（Monthly Recurring Revenue）
- メール送信数/成功率
- スクレイピング成功率

---

## セキュリティ

### 方針

- 個人情報を持たないことで漏洩リスクを最小化
- 認証・決済は専門サービスに委譲

### リスクと対策

| リスク | 対策 |
|--------|------|
| DB漏洩 | 個人情報がないため影響限定的 |
| 不正アクセス | Clerk の認証に依存 |
| スクレイピング検知 | レートリミット、User-Agent設定 |

---

## 法的考慮事項

### OK なこと

- 公開情報（空き状況）のスクレイピング
- 情報を集約して通知するサービスの提供
- 課金

### グレー/NG なこと

- 自動予約機能（利用規約違反の可能性、責任問題）
- robots.txt で Disallow されているページへのアクセス

### 利用規約に明記すべきこと

```
1. サービス内容
   - 公共施設の空き情報を収集し通知するサービス

2. 個人情報
   - 本サービスは個人情報を収集・保存しない
   - 認証情報は Clerk 社、決済情報は Stripe 社が管理

3. 免責事項
   - 空き情報の正確性は保証しない
   - 予約の成否について責任を負わない
   - 各自治体の利用規約に従うこと

4. 禁止事項
   - 転売目的での利用
   - サーバーへの過度な負荷
```

---

## 将来の拡張

### Phase 1（初回リリース）

- 空き情報の通知
- 基本的な課金

### Phase 2

- 対応自治体の拡大
- 施設種別の拡大（体育館等）

### Phase 3（要法的確認）

- 自動予約機能
- 自治体との API 連携

---

## 技術スタック

| 領域 | 技術 |
|------|------|
| バックエンド | Go |
| データベース | SQLite |
| 認証 | Clerk |
| 決済 | Stripe |
| メール送信 | Amazon SES |
| ホスティング | exe.dev VM |
| スクレイピング | Python (既存の ground-reservation) |
