name: scrape

permissions:
  contents: read

on:
  schedule:
    # 毎日朝6時(JST)に実行 = UTC 21:00 (前日)
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      municipality:
        description: 'Municipality to scrape (leave empty for all)'
        required: false
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    env:
      TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
      TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
    steps:
      - name: Check out the code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check out ground-reservation
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: susumutomita/ground-reservation
          path: ground-reservation

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: worker/go.mod
          cache-dependency-path: worker/go.sum

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r ground-reservation/requirements.txt
          pip install -e ground-reservation/

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Build worker
        run: |
          cd worker
          go build -o akigura-worker ./cmd/worker

      - name: Run scraper
        run: |
          cd worker
          ./akigura-worker -once -scraper ./scraper_wrapper.py

  notify:
    runs-on: ubuntu-latest
    needs: scrape
    env:
      TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
      TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
    steps:
      - name: Check out the code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: worker/go.mod
          cache-dependency-path: worker/go.sum

      - name: Build worker
        run: |
          cd worker
          go build -o akigura-worker ./cmd/worker

      - name: Send notifications
        run: |
          cd worker
          ./akigura-worker -notify-only
