<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç©ºãç›£è¦–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="userApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">âš¾ AkiGura</h1>
            <div x-show="team" class="text-sm">
                <span x-text="team?.name"></span>
                <span class="ml-2 px-2 py-1 bg-indigo-500 rounded text-xs" x-text="team?.plan"></span>
            </div>
        </div>
    </header>

    <!-- Login Form -->
    <div x-show="!team && !emailSent" x-cloak class="max-w-md mx-auto mt-20 p-6 bg-white rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
        <p class="text-sm text-gray-600 mb-4">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</p>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" x-model="loginEmail" @keyup.enter="login()" class="mt-1 block w-full border rounded px-3 py-2" placeholder="team@example.com">
            </div>
            <div x-show="isRegister">
                <label class="block text-sm font-medium text-gray-700">ãƒãƒ¼ãƒ åï¼ˆæ–°è¦ç™»éŒ²ã®å ´åˆï¼‰</label>
                <input type="text" x-model="loginName" class="mt-1 block w-full border rounded px-3 py-2" placeholder="æ±äº¬ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼ã‚º">
            </div>
            <button @click="login()" :disabled="loginLoading" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <span x-show="!loginLoading" x-text="isRegister ? 'ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡' : 'ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡'"></span>
                <span x-show="loginLoading">é€ä¿¡ä¸­...</span>
            </button>
            <p class="text-center text-sm text-gray-500">
                <a href="#" @click.prevent="isRegister = !isRegister" class="text-indigo-600 hover:underline" x-text="isRegister ? 'æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰'"></a>
            </p>
            <p x-show="loginError" class="text-red-500 text-sm" x-text="loginError"></p>
        </div>
    </div>

    <!-- Email Sent Message -->
    <div x-show="!team && emailSent" x-cloak class="max-w-md mx-auto mt-20 p-6 bg-white rounded-lg shadow text-center">
        <div class="text-5xl mb-4">ğŸ“§</div>
        <h2 class="text-xl font-bold mb-2">ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ</h2>
        <p class="text-gray-600 mb-4">
            <span class="font-medium" x-text="loginEmail"></span> å®›ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚
            ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </p>
        <p class="text-sm text-gray-500 mb-4">ãƒªãƒ³ã‚¯ã¯15åˆ†é–“æœ‰åŠ¹ã§ã™ã€‚</p>
        <button @click="emailSent = false" class="text-indigo-600 hover:underline text-sm">
            åˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§è©¦ã™
        </button>
        <!-- Debug link for development -->
        <div x-show="debugLink" class="mt-4 p-3 bg-yellow-50 rounded text-left">
            <p class="text-xs text-yellow-800 mb-1">é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: ç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³</p>
            <a :href="debugLink" class="text-xs text-indigo-600 break-all" x-text="debugLink"></a>
        </div>
    </div>

    <!-- Main Content -->
    <main x-show="team" x-cloak class="max-w-4xl mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="flex space-x-4 border-b mb-6 overflow-x-auto">
            <button @click="tab = 'slots'" :class="{'border-indigo-600 text-indigo-600': tab === 'slots'}" class="pb-2 px-1 border-b-2 border-transparent whitespace-nowrap">ç©ºãçŠ¶æ³</button>
            <button @click="tab = 'conditions'" :class="{'border-indigo-600 text-indigo-600': tab === 'conditions'}" class="pb-2 px-1 border-b-2 border-transparent whitespace-nowrap">ç›£è¦–æ¡ä»¶</button>
            <button @click="tab = 'notifications'" :class="{'border-indigo-600 text-indigo-600': tab === 'notifications'}" class="pb-2 px-1 border-b-2 border-transparent whitespace-nowrap">é€šçŸ¥å±¥æ­´</button>
            <button @click="tab = 'settings'" :class="{'border-indigo-600 text-indigo-600': tab === 'settings'}" class="pb-2 px-1 border-b-2 border-transparent whitespace-nowrap">è¨­å®š</button>
        </div>

        <!-- Available Slots (Calendar View) -->
        <div x-show="tab === 'slots'">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-lg font-bold">ç©ºãçŠ¶æ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select x-model="selectedMunicipality" @change="filterSlots()" class="border rounded px-3 py-2 text-sm">
                        <option value="">å…¨ã¦ã®è‡ªæ²»ä½“</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                    <select x-model="selectedGround" @change="filterSlots()" class="border rounded px-3 py-2 text-sm">
                        <option value="">å…¨ã¦ã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰</option>
                        <template x-for="g in filteredGrounds" :key="g.id">
                            <option :value="g.id" x-text="g.name"></option>
                        </template>
                    </select>
                    <button @click="loadSlots()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">æ›´æ–°</button>
                </div>
            </div>

            <!-- Calendar Navigation -->
            <div class="flex justify-between items-center mb-4">
                <button @click="prevMonth()" class="p-2 hover:bg-gray-100 rounded">&larr; å‰æœˆ</button>
                <h3 class="text-lg font-semibold" x-text="calendarYear + 'å¹´' + (calendarMonth + 1) + 'æœˆ'"></h3>
                <button @click="nextMonth()" class="p-2 hover:bg-gray-100 rounded">ç¿Œæœˆ &rarr;</button>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <!-- Week days header -->
                <div class="grid grid-cols-7 bg-gray-50 border-b">
                    <template x-for="day in ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']" :key="day">
                        <div class="py-2 text-center text-sm font-medium" :class="day === 'æ—¥' ? 'text-red-500' : day === 'åœŸ' ? 'text-blue-500' : 'text-gray-700'" x-text="day"></div>
                    </template>
                </div>
                <!-- Calendar days -->
                <div class="grid grid-cols-7">
                    <template x-for="(day, idx) in calendarDays" :key="idx">
                        <div
                            class="min-h-[80px] border-b border-r p-1 cursor-pointer transition-colors"
                            :class="{
                                'bg-gray-50': !day.currentMonth,
                                'hover:bg-indigo-50': day.currentMonth,
                                'bg-indigo-100': selectedDate === day.dateStr,
                                'border-l': idx % 7 === 0
                            }"
                            @click="day.currentMonth && selectDate(day.dateStr)"
                        >
                            <div class="flex justify-between items-start">
                                <span
                                    class="text-sm font-medium"
                                    :class="{
                                        'text-gray-400': !day.currentMonth,
                                        'text-red-500': day.currentMonth && day.dayOfWeek === 0,
                                        'text-blue-500': day.currentMonth && day.dayOfWeek === 6,
                                        'text-gray-900': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                    }"
                                    x-text="day.day"
                                ></span>
                                <template x-if="day.currentMonth && getSlotsForDate(day.dateStr).length > 0">
                                    <span class="px-1.5 py-0.5 text-xs font-bold rounded-full bg-green-500 text-white" x-text="getSlotsForDate(day.dateStr).length"></span>
                                </template>
                            </div>
                            <!-- Slot preview for large screens -->
                            <div class="hidden sm:block mt-1 space-y-0.5 overflow-hidden max-h-[50px]">
                                <template x-for="slot in getSlotsForDate(day.dateStr).slice(0, 2)" :key="slot.id">
                                    <div class="text-xs px-1 py-0.5 bg-green-100 text-green-800 rounded truncate" x-text="slot.time_from + ' ' + (slot.court_name || '').substring(0, 6)"></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Selected Date Detail -->
            <div x-show="selectedDate" class="mt-4 bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-lg" x-text="formatDateFull(selectedDate) + ' ã®ç©ºãæ '"></h4>
                    <span class="text-sm text-gray-500" x-text="getSlotsForDate(selectedDate).length + 'ä»¶'"></span>
                </div>
                <div class="space-y-2 max-h-[300px] overflow-y-auto">
                    <template x-for="slot in getSlotsForDate(selectedDate)" :key="slot.id">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div>
                                <p class="font-medium text-indigo-600" x-text="slot.court_name || slot.ground_name"></p>
                                <p class="text-sm text-gray-500" x-text="slot.municipality_name"></p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg" x-text="slot.time_from + ' - ' + slot.time_to"></p>
                            </div>
                        </div>
                    </template>
                    <p x-show="getSlotsForDate(selectedDate).length === 0" class="text-gray-500 text-center py-4">ã“ã®æ—¥ã®ç©ºãæ ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <!-- Summary -->
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                <p class="text-sm text-indigo-700">
                    åˆè¨ˆ <span class="font-bold" x-text="filteredSlots.length"></span> ä»¶ã®ç©ºãæ 
                    <span x-show="selectedMunicipality || selectedGround" class="ml-2">(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)</span>
                </p>
            </div>
        </div>

        <!-- Watch Conditions -->
        <div x-show="tab === 'conditions'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">ç›£è¦–æ¡ä»¶</h2>
                <button @click="showConditionModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">æ–°è¦è¿½åŠ </button>
            </div>
            <div class="space-y-3">
                <template x-for="c in conditions" :key="c.id">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium" x-text="getGroundName(c.facility_id)"></p>
                                <p class="text-sm text-gray-500">
                                    <span x-text="formatDays(c.days_of_week)"></span>
                                    <span x-text="c.time_from + ' - ' + c.time_to"></span>
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs rounded" :class="c.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100'" x-text="c.enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'"></span>
                                <button @click="deleteCondition(c.id)" class="text-red-500 hover:text-red-700 text-sm">å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="conditions.length === 0" class="text-gray-500 text-center py-8">ç›£è¦–æ¡ä»¶ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <!-- Notifications -->
        <div x-show="tab === 'notifications'">
            <h2 class="text-lg font-bold mb-4">é€šçŸ¥å±¥æ­´</h2>
            <div class="space-y-3">
                <template x-for="n in notifications" :key="n.id">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium" x-text="n.facility_name || 'æ–½è¨­'"></p>
                                <p class="text-sm text-gray-500" x-text="n.slot_date + ' ' + n.slot_time"></p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded" :class="{'bg-green-100 text-green-800': n.status === 'sent', 'bg-yellow-100': n.status === 'pending', 'bg-red-100 text-red-800': n.status === 'failed'}" x-text="n.status"></span>
                        </div>
                    </div>
                </template>
                <p x-show="notifications.length === 0" class="text-gray-500 text-center py-8">é€šçŸ¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>

        <!-- Settings -->
        <div x-show="tab === 'settings'">
            <h2 class="text-lg font-bold mb-4">è¨­å®š</h2>
            
            <!-- Account Settings -->
            <div class="bg-white rounded-lg shadow p-6 space-y-4 mb-6">
                <h3 class="font-semibold text-gray-900">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ãƒãƒ¼ãƒ å</label>
                    <input type="text" x-model="team.name" class="mt-1 block w-full border rounded px-3 py-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" x-model="team.email" class="mt-1 block w-full border rounded px-3 py-2" disabled>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="bg-white rounded-lg shadow p-6 space-y-4 mb-6">
                <h3 class="font-semibold text-gray-900">é€šçŸ¥è¨­å®š</h3>
                <p class="text-sm text-gray-600">ç©ºããŒè¦‹ã¤ã‹ã£ãŸã‚‰é€šçŸ¥ã‚’å—ã‘å–ã‚‹æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                
                <div class="space-y-3">
                    <!-- Email -->
                    <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50" :class="notificationSettings.email ? 'border-indigo-600 bg-indigo-50' : ''">
                        <input type="checkbox" x-model="notificationSettings.email" class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</p>
                            <p class="text-sm text-gray-500" x-text="team?.email"></p>
                        </div>
                    </label>

                    <!-- LINE (future) -->
                    <label class="flex items-center p-3 border rounded cursor-not-allowed opacity-50">
                        <input type="checkbox" disabled class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium">ğŸ—¨ï¸ LINEé€šçŸ¥</p>
                            <p class="text-sm text-gray-500">è¿‘æ—¥å¯¾å¿œäºˆå®š</p>
                        </div>
                    </label>

                    <!-- Slack (future) -->
                    <label class="flex items-center p-3 border rounded cursor-not-allowed opacity-50">
                        <input type="checkbox" disabled class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium">ğŸ’¬ Slacké€šçŸ¥</p>
                            <p class="text-sm text-gray-500">è¿‘æ—¥å¯¾å¿œäºˆå®š</p>
                        </div>
                    </label>
                </div>

                <button @click="saveNotificationSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">
                    é€šçŸ¥è¨­å®šã‚’ä¿å­˜
                </button>
            </div>

            <!-- Plan -->
            <div class="bg-white rounded-lg shadow p-6 space-y-4 mb-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-gray-900">ãƒ—ãƒ©ãƒ³</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">æœˆæ‰•ã„</span>
                        <button @click="billingInterval = billingInterval === 'monthly' ? 'yearly' : 'monthly'" 
                                class="relative w-12 h-6 rounded-full transition-colors" 
                                :class="billingInterval === 'yearly' ? 'bg-indigo-600' : 'bg-gray-300'">
                            <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform" 
                                  :class="billingInterval === 'yearly' ? 'translate-x-6' : ''"></span>
                        </button>
                        <span class="text-sm text-gray-500">å¹´æ‰•ã„</span>
                        <span x-show="billingInterval === 'yearly'" class="text-xs text-green-600 font-medium">20%ã‚ªãƒ•</span>
                    </div>
                </div>
                
                <!-- Current Plan Info -->
                <div class="bg-gray-50 rounded p-3 text-sm">
                    <div class="flex justify-between">
                        <span>ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³:</span>
                        <span class="font-medium" x-text="team?.plan?.charAt(0).toUpperCase() + team?.plan?.slice(1)"></span>
                    </div>
                    <div x-show="team?.billing_interval" class="flex justify-between mt-1">
                        <span>è«‹æ±‚ã‚µã‚¤ã‚¯ãƒ«:</span>
                        <span x-text="team?.billing_interval === 'yearly' ? 'å¹´æ‰•ã„' : 'æœˆæ‰•ã„'"></span>
                    </div>
                    <div x-show="team?.current_period_end" class="flex justify-between mt-1">
                        <span>æ¬¡å›æ›´æ–°æ—¥:</span>
                        <span x-text="new Date(team?.current_period_end).toLocaleDateString('ja-JP')"></span>
                    </div>
                </div>

                <!-- Plan Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <template x-for="p in plans" :key="p.id">
                        <div class="border rounded-lg p-4" 
                             :class="team?.plan === p.id ? 'border-indigo-600 bg-indigo-50 ring-2 ring-indigo-600' : 'hover:border-gray-400'">
                            <p class="font-semibold text-lg" x-text="p.name"></p>
                            <div class="mt-2">
                                <p class="text-2xl font-bold">
                                    <span x-text="'Â¥' + (billingInterval === 'yearly' ? p.yearly_price : p.monthly_price).toLocaleString()"></span>
                                    <span class="text-sm font-normal text-gray-500" x-text="billingInterval === 'yearly' ? '/å¹´' : '/æœˆ'"></span>
                                </p>
                                <p x-show="billingInterval === 'yearly' && p.yearly_savings > 0" class="text-xs text-green-600">
                                    å¹´é–“ Â¥<span x-text="p.yearly_savings.toLocaleString()"></span> ãŠå¾—
                                </p>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                <span x-text="p.max_facilities === -1 ? 'ç„¡åˆ¶é™' : p.max_facilities + 'æ–½è¨­ã¾ã§'"></span>
                            </p>
                            <button x-show="team?.plan !== p.id && p.id !== 'free'" 
                                    @click="selectedPlan = p.id; showUpgradeModal = true"
                                    class="mt-3 w-full bg-indigo-600 text-white py-2 rounded text-sm hover:bg-indigo-700">
                                ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                            </button>
                            <span x-show="team?.plan === p.id" class="mt-3 block text-center text-indigo-600 font-medium text-sm">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</span>
                        </div>
                    </template>
                </div>

                <!-- Billing Portal Button -->
                <div x-show="team?.stripe_subscription_id" class="pt-4 border-t">
                    <button @click="openBillingPortal()" class="text-indigo-600 hover:underline text-sm">
                        è«‹æ±‚æƒ…å ±ãƒ»æ”¯æ‰•ã„å±¥æ­´ã‚’ç®¡ç† â†’
                    </button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold text-red-600 mb-4">ãƒ‡ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¾ãƒ¼ãƒ³</h3>
                <button @click="logout()" class="text-red-500 hover:underline text-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div x-show="showUpgradeModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">ãƒ—ãƒ©ãƒ³ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 rounded p-4">
                    <p class="text-sm text-gray-600">é¸æŠä¸­ã®ãƒ—ãƒ©ãƒ³</p>
                    <p class="text-xl font-bold" x-text="plans.find(p => p.id === selectedPlan)?.name"></p>
                    <p class="text-2xl font-bold text-indigo-600 mt-1">
                        Â¥<span x-text="(billingInterval === 'yearly' ? plans.find(p => p.id === selectedPlan)?.yearly_price : plans.find(p => p.id === selectedPlan)?.monthly_price)?.toLocaleString()"></span>
                        <span class="text-sm font-normal text-gray-500" x-text="billingInterval === 'yearly' ? '/å¹´' : '/æœˆ'"></span>
                    </p>
                </div>
                
                <!-- Promo Code -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ­ãƒ¢ã‚³ãƒ¼ãƒ‰ï¼ˆãŠæŒã¡ã®å ´åˆï¼‰</label>
                    <div class="flex space-x-2">
                        <input type="text" x-model="promoCode" @input="promoCodeError = ''; promoCodeValid = null" 
                               class="flex-1 border rounded px-3 py-2 uppercase" placeholder="PROMO2024">
                        <button @click="validatePromoCode()" :disabled="!promoCode || promoCodeLoading"
                                class="px-4 py-2 border rounded hover:bg-gray-50 disabled:opacity-50">
                            <span x-show="!promoCodeLoading">ç¢ºèª</span>
                            <span x-show="promoCodeLoading">...</span>
                        </button>
                    </div>
                    <p x-show="promoCodeError" class="text-red-500 text-sm mt-1" x-text="promoCodeError"></p>
                    <p x-show="promoCodeValid" class="text-green-600 text-sm mt-1">
                        âœ“ <span x-text="promoCodeValid.discount"></span> é©ç”¨ã•ã‚Œã¾ã™
                    </p>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showUpgradeModal = false; promoCode = ''; promoCodeValid = null; promoCodeError = ''" 
                        class="px-4 py-2 border rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button @click="startCheckout()" :disabled="checkoutLoading"
                        class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50">
                    <span x-show="!checkoutLoading">æ”¯æ‰•ã„ã«é€²ã‚€</span>
                    <span x-show="checkoutLoading">å‡¦ç†ä¸­...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Condition Modal -->
    <div x-show="showConditionModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">ç›£è¦–æ¡ä»¶è¿½åŠ </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">è‡ªæ²»ä½“</label>
                    <select x-model="newCondition.municipality_id" @change="newCondition.ground_id = ''" class="mt-1 block w-full border rounded px-3 py-2">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰</label>
                    <select x-model="newCondition.ground_id" class="mt-1 block w-full border rounded px-3 py-2">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <template x-for="g in groundsForSelectedMunicipality" :key="g.id">
                            <option :value="g.id" x-text="g.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ›œæ—¥</label>
                    <div class="flex flex-wrap gap-2 mt-1">
                        <template x-for="(day, i) in ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']" :key="i">
                            <button type="button" @click="toggleDay(i)" class="px-3 py-1 border rounded" :class="newCondition.days_of_week.includes(i) ? 'bg-indigo-600 text-white border-indigo-600' : ''" x-text="day"></button>
                        </template>
                    </div>
                    <p x-show="currentPlanLimit?.weekend_only" class="text-xs text-orange-600 mt-1">âš ï¸ ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯é€±æœ«ï¼ˆåœŸæ—¥ï¼‰ã®ã¿é¸æŠå¯èƒ½</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">é–‹å§‹æ™‚åˆ»</label>
                        <input type="time" x-model="newCondition.time_from" class="mt-1 block w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">çµ‚äº†æ™‚åˆ»</label>
                        <input type="time" x-model="newCondition.time_to" class="mt-1 block w-full border rounded px-3 py-2">
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showConditionModal = false" class="px-4 py-2 border rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button @click="createCondition()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
    const DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    function userApp() {
        return {
            team: null,
            tab: 'slots',
            conditions: [],
            notifications: [],
            municipalities: [],
            grounds: [],
            slots: [],
            planLimits: [],
            selectedMunicipality: '',
            selectedGround: '',
            loginEmail: '',
            loginName: '',
            loginError: '',
            loginLoading: false,
            isRegister: false,
            emailSent: false,
            debugLink: null,
            notificationSettings: { email: true },
            showConditionModal: false,
            newCondition: { municipality_id: '', ground_id: '', days_of_week: [6, 0], time_from: '09:00', time_to: '17:00' },
            // Calendar state
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            selectedDate: null,
            // Billing state
            plans: [],
            billingInterval: 'monthly',
            showUpgradeModal: false,
            selectedPlan: null,
            promoCode: '',
            promoCodeValid: null,
            promoCodeError: '',
            promoCodeLoading: false,
            checkoutLoading: false,

            async init() {
                const saved = localStorage.getItem('akigura_team');
                if (saved) {
                    this.team = JSON.parse(saved);
                    await this.loadData();
                }
                await this.loadMasterData();
            },

            // Calendar methods
            get calendarDays() {
                const days = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay();

                // Previous month days
                const prevMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const d = prevMonth.getDate() - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: false,
                        dayOfWeek: date.getDay()
                    });
                }

                // Current month days
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: true,
                        dayOfWeek: date.getDay()
                    });
                }

                // Next month days to fill the grid
                const remaining = 42 - days.length;
                for (let d = 1; d <= remaining; d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: false,
                        dayOfWeek: date.getDay()
                    });
                }

                return days;
            },

            toDateStr(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            },

            changeMonth(delta) {
                const d = new Date(this.calendarYear, this.calendarMonth + delta, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            prevMonth() { this.changeMonth(-1); },
            nextMonth() { this.changeMonth(1); },

            selectDate(dateStr) {
                this.selectedDate = this.selectedDate === dateStr ? null : dateStr;
            },

            getSlotsForDate(dateStr) {
                return this.filteredSlots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            formatDateFull(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥(${DAY_NAMES[d.getDay()]})`;
            },

            async login() {
                this.loginError = '';
                this.debugLink = null;
                if (!this.loginEmail) {
                    this.loginError = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    return;
                }
                
                this.loginLoading = true;
                try {
                    const res = await fetch('/api/auth/magic-link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: this.loginEmail, 
                            name: this.isRegister ? this.loginName : '' 
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        this.loginError = data.error || 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                        return;
                    }
                    // Show email sent screen
                    this.emailSent = true;
                    // In debug mode, show the link directly
                    if (data.debug_link) {
                        this.debugLink = data.debug_link;
                    }
                } catch (e) {
                    this.loginError = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                } finally {
                    this.loginLoading = false;
                }
            },

            logout() {
                this.team = null;
                this.emailSent = false;
                localStorage.removeItem('akigura_team');
            },

            async saveNotificationSettings() {
                // For now just show confirmation - actual save would need team update API
                alert('é€šçŸ¥è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            },

            async loadData() {
                if (!this.team) return;
                const [condRes, notifRes] = await Promise.all([
                    fetch('/api/conditions?team_id=' + this.team.id),
                    fetch('/api/notifications?team_id=' + this.team.id)
                ]);
                this.conditions = await condRes.json() || [];
                this.notifications = await notifRes.json() || [];
            },

            async loadMasterData() {
                const [munRes, groundRes, slotRes, planRes, plansRes] = await Promise.all([
                    fetch('/api/municipalities'),
                    fetch('/api/grounds'),
                    fetch('/api/slots'),
                    fetch('/api/plan-limits'),
                    fetch('/api/plans')
                ]);
                this.municipalities = await munRes.json() || [];
                this.grounds = await groundRes.json() || [];
                this.slots = await slotRes.json() || [];
                this.planLimits = await planRes.json() || [];
                this.plans = await plansRes.json() || [];
            },

            async loadSlots() {
                let url = '/api/slots';
                const params = [];
                if (this.selectedMunicipality) params.push('municipality_id=' + this.selectedMunicipality);
                if (this.selectedGround) params.push('ground_id=' + this.selectedGround);
                if (params.length) url += '?' + params.join('&');
                const res = await fetch(url);
                this.slots = await res.json() || [];
            },

            get filteredGrounds() {
                if (!this.selectedMunicipality) return this.grounds;
                return this.grounds.filter(g => g.municipality_id === this.selectedMunicipality);
            },

            get filteredSlots() {
                let result = this.slots;
                if (this.selectedMunicipality) {
                    result = result.filter(s => {
                        const ground = this.grounds.find(g => g.id === s.ground_id);
                        return ground && ground.municipality_id === this.selectedMunicipality;
                    });
                }
                if (this.selectedGround) {
                    result = result.filter(s => s.ground_id === this.selectedGround);
                }
                return result;
            },

            get groundsForSelectedMunicipality() {
                if (!this.newCondition.municipality_id) return [];
                return this.grounds.filter(g => g.municipality_id === this.newCondition.municipality_id);
            },

            get currentPlanLimit() {
                if (!this.team) return null;
                return this.planLimits.find(p => p.plan === this.team.plan);
            },

            getGroundName(id) {
                const g = this.grounds.find(g => g.id === id);
                return g ? g.name + ' (' + g.municipality_name + ')' : 'ä¸æ˜ãªæ–½è¨­';
            },

            formatDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}(${DAY_NAMES[d.getDay()]})`;
            },

            formatDays(days) {
                if (!days) return '';
                try {
                    const arr = typeof days === 'string' ? JSON.parse(days) : days;
                    if (!Array.isArray(arr)) return '';
                    return arr.map(d => DAY_NAMES[d]).join(', ');
                } catch {
                    return '';
                }
            },

            toggleDay(day) {
                const idx = this.newCondition.days_of_week.indexOf(day);
                if (idx >= 0) {
                    this.newCondition.days_of_week.splice(idx, 1);
                } else {
                    this.newCondition.days_of_week.push(day);
                }
            },

            filterSlots() {
                // Reset ground selection when municipality changes
                if (!this.selectedMunicipality) {
                    this.selectedGround = '';
                }
            },

            async createCondition() {
                if (!this.newCondition.ground_id) {
                    alert('ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                await fetch('/api/conditions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team_id: this.team.id,
                        facility_id: this.newCondition.ground_id,
                        days_of_week: JSON.stringify(this.newCondition.days_of_week),
                        time_from: this.newCondition.time_from,
                        time_to: this.newCondition.time_to
                    })
                });
                this.showConditionModal = false;
                this.newCondition = { municipality_id: '', ground_id: '', days_of_week: [6, 0], time_from: '09:00', time_to: '17:00' };
                await this.loadData();
            },

            async deleteCondition(id) {
                if (!confirm('ã“ã®ç›£è¦–æ¡ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                await fetch('/api/conditions/' + id, { method: 'DELETE' });
                await this.loadData();
            },

            // Billing methods
            async validatePromoCode() {
                if (!this.promoCode) return;
                this.promoCodeLoading = true;
                this.promoCodeError = '';
                this.promoCodeValid = null;
                try {
                    const res = await fetch('/api/billing/validate-promo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: this.promoCode,
                            team_id: this.team?.id,
                            plan: this.selectedPlan
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        this.promoCodeError = data.error || 'ãƒ—ãƒ­ãƒ¢ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™';
                        return;
                    }
                    this.promoCodeValid = data;
                } catch (e) {
                    this.promoCodeError = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                } finally {
                    this.promoCodeLoading = false;
                }
            },

            async startCheckout() {
                if (!this.team || !this.selectedPlan) return;
                this.checkoutLoading = true;
                try {
                    const res = await fetch('/api/billing/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_id: this.team.id,
                            plan: this.selectedPlan,
                            interval: this.billingInterval,
                            promo_code: this.promoCodeValid ? this.promoCode : ''
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        alert(data.error || 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } catch (e) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                } finally {
                    this.checkoutLoading = false;
                }
            },

            async openBillingPortal() {
                if (!this.team) return;
                try {
                    const res = await fetch('/api/billing/portal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ team_id: this.team.id })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        alert(data.error || 'ãƒãƒ¼ã‚¿ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }
                    window.location.href = data.url;
                } catch (e) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
        }
    }
    </script>
</body>
</html>
