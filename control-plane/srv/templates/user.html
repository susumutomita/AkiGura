<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - スポーツ施設空き状況モニター</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sumi: {
                            50: '#F5F5F5',
                            100: '#E8E8E8',
                            200: '#D1D1D1',
                            300: '#B0B0B0',
                            400: '#888888',
                            500: '#6B6B6B',
                            600: '#4A4A4A',
                            700: '#3D3D3D',
                            800: '#2C2C2C',
                            900: '#1A1A1A',
                        },
                        kinari: {
                            50: '#FEFDFB',
                            100: '#FAF8F5',
                            200: '#F5F2ED',
                        },
                        ai: {
                            50: '#E8F4F8',
                            100: '#C5E4ED',
                            200: '#9DD1E0',
                            300: '#6BB8CC',
                            400: '#4A9DB5',
                            500: '#3D8EAF',
                            600: '#1E4D6B',
                            700: '#1A4460',
                            800: '#153A52',
                            900: '#0F2C3D',
                        },
                        wakakusa: {
                            50: '#F0F5F0',
                            100: '#DCE8DC',
                            200: '#C2D9C2',
                            300: '#9EC49E',
                            400: '#7AAF7A',
                            500: '#5A8F5A',
                            600: '#4A7A4A',
                            700: '#3D653D',
                            800: '#2F4F2F',
                            900: '#223A22',
                        },
                        sango: {
                            50: '#FDF5F5',
                            100: '#F9E8E8',
                            200: '#F2D0D0',
                            300: '#E5A8A8',
                            400: '#D48080',
                            500: '#C96161',
                            600: '#B54A4A',
                            700: '#963D3D',
                            800: '#783131',
                            900: '#5A2525',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        body { font-feature-settings: "palt"; }
    </style>
</head>
<body class="bg-kinari-100 min-h-screen text-sumi-800" x-data="userApp()" x-init="init()">
    <!-- Header -->
    <header class="bg-sumi-800 text-kinari-50">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <span class="text-lg font-semibold tracking-tight">AkiGura</span>
            </div>
            <div x-show="team" class="flex items-center gap-4">
                <span class="text-sm text-kinari-100" x-text="team?.name"></span>
                <span class="px-2 py-0.5 text-xs font-medium uppercase tracking-wide bg-sumi-700 rounded" x-text="team?.plan"></span>
                <button @click="logout()" class="text-sm text-kinari-200 hover:text-kinari-50 transition-colors">ログアウト</button>
            </div>
        </div>
    </header>

    <!-- Sign In Form -->
    <div x-show="!team && !emailSent" x-cloak class="max-w-sm mx-auto mt-20 px-6">
        <div class="bg-white rounded border border-sumi-100 p-8">
            <div class="text-center mb-8">
                <h2 class="text-xl font-semibold text-sumi-800" x-text="isRegister ? 'アカウント作成' : 'ログイン'"></h2>
                <p class="text-sumi-500 mt-2 text-sm">施設の空き状況を自動でモニタリング</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-sumi-600 mb-1.5">メールアドレス</label>
                    <input type="email" x-model="loginEmail" @keyup.enter="login()"
                           class="block w-full border border-sumi-200 rounded px-3 py-2.5 text-sm focus:outline-none focus:border-ai-500 transition-colors"
                           placeholder="example@email.com">
                </div>
                <div x-show="isRegister">
                    <label class="block text-sm font-medium text-sumi-600 mb-1.5">チーム名</label>
                    <input type="text" x-model="loginName"
                           class="block w-full border border-sumi-200 rounded px-3 py-2.5 text-sm focus:outline-none focus:border-ai-500 transition-colors"
                           placeholder="チームまたは組織名">
                </div>
                <button @click="login()" :disabled="loginLoading"
                        class="w-full bg-ai-600 text-white py-2.5 rounded font-medium text-sm hover:bg-ai-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loginLoading">メールでログイン</span>
                    <span x-show="loginLoading" class="flex items-center justify-center gap-2">
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        送信中...
                    </span>
                </button>

                <!-- OAuth Divider -->
                <div x-show="oauthConfig.google_enabled" class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-sumi-200"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-3 bg-white text-sumi-400">または</span>
                    </div>
                </div>

                <!-- Google Sign In Button -->
                <a x-show="oauthConfig.google_enabled" href="/auth/google"
                   class="w-full flex items-center justify-center gap-3 border border-sumi-200 py-2.5 rounded font-medium text-sm text-sumi-700 hover:bg-sumi-50 transition-colors">
                    <svg class="w-4 h-4" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google でログイン
                </a>

                <p class="text-center text-sm text-sumi-500 pt-2">
                    <a href="#" @click.prevent="isRegister = !isRegister" class="text-ai-600 font-medium hover:text-ai-700" x-text="isRegister ? 'アカウントをお持ちの方はこちら' : '新規登録はこちら'"></a>
                </p>
                <p x-show="loginError" class="text-sango-600 text-sm bg-sango-50 p-3 rounded border border-sango-200" x-text="loginError"></p>
            </div>
        </div>
    </div>

    <!-- Email Sent Message -->
    <div x-show="!team && emailSent" x-cloak class="max-w-sm mx-auto mt-20 px-6">
        <div class="bg-white rounded border border-sumi-100 p-8 text-center">
            <h2 class="text-lg font-semibold text-sumi-800 mb-2">メールを確認してください</h2>
            <p class="text-sumi-500 text-sm mb-1">ログインリンクを送信しました</p>
            <p class="font-medium text-sumi-800 mb-4" x-text="loginEmail"></p>
            <p class="text-sm text-sumi-400 mb-6">リンクの有効期限は 15 分です</p>
            <button @click="emailSent = false" class="text-ai-600 hover:text-ai-700 text-sm font-medium">
                別のメールアドレスを使用
            </button>
            <!-- Debug link for development -->
            <div x-show="debugLink" class="mt-6 p-4 bg-kinari-200 border border-sumi-200 rounded text-left">
                <p class="text-xs font-medium text-sumi-600 mb-2">開発モード: 直接ログインリンク</p>
                <a :href="debugLink" class="text-xs text-ai-600 hover:text-ai-700 break-all font-mono" x-text="debugLink"></a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main x-show="team" x-cloak class="max-w-4xl mx-auto px-6 py-8">
        <!-- Tabs -->
        <div class="border-b border-sumi-200 mb-8">
            <nav class="flex gap-8">
                <template x-for="item in tabItems" :key="item.id">
                    <button @click="tab = item.id"
                            :class="tab === item.id ? 'border-ai-600 text-sumi-800' : 'border-transparent text-sumi-500 hover:text-sumi-700'"
                            class="pb-3 border-b-2 font-medium text-sm transition-colors"
                            x-text="item.label"></button>
                </template>
            </nav>
        </div>

        <!-- Available Slots (Calendar View) -->
        <div x-show="tab === 'slots'">
            <div class="mb-6">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                    <div>
                        <h2 class="text-xl font-semibold text-sumi-800">空き状況</h2>
                        <p class="text-sm text-sumi-500 mt-1" x-show="lastUpdate">
                            最終更新: <span x-text="lastUpdate?.time"></span>
                            <span x-show="lastUpdate?.count !== undefined" class="text-ai-600">(<span x-text="lastUpdate?.count"></span>)</span>
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <select x-model="selectedMunicipality" @change="filterSlots()"
                                class="border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                            <option value="">すべての地域</option>
                            <template x-for="m in municipalities" :key="m.id">
                                <option :value="m.id" x-text="m.name"></option>
                            </template>
                        </select>
                        <select x-model="selectedGround" @change="filterSlots()"
                                class="border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                            <option value="">すべての施設</option>
                            <template x-for="g in filteredGrounds" :key="g.id">
                                <option :value="g.id" x-text="g.name"></option>
                            </template>
                        </select>
                        <button @click="refreshSlots()" :disabled="refreshing"
                                class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
                            <svg x-show="refreshing" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span x-text="refreshing ? '更新中...' : '更新'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Availability Summary -->
            <div class="bg-white rounded border border-sumi-200 p-4 mb-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-wakakusa-600" x-text="filteredSlots.length"></p>
                            <p class="text-xs text-sumi-500">空き枠総数</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-ai-600" x-text="Object.keys(filteredSlots.reduce((acc, s) => { acc[s.slot_date.split('T')[0]] = true; return acc; }, {})).length"></p>
                            <p class="text-xs text-sumi-500">空きのある日数</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 text-xs">
                        <span class="text-sumi-500">凡例:</span>
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded bg-wakakusa-50 border border-wakakusa-200"></span>
                            <span class="text-sumi-600">1-5件</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded bg-wakakusa-100 border border-wakakusa-300"></span>
                            <span class="text-sumi-600">6-15件</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded bg-wakakusa-200 border border-wakakusa-400"></span>
                            <span class="text-sumi-600">16件以上</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Navigation -->
            <div class="flex justify-between items-center mb-4 py-3">
                <button @click="prevMonth()" class="px-4 py-2 text-sm text-sumi-600 hover:text-sumi-800 transition-colors">
                    前月
                </button>
                <h3 class="text-lg font-semibold text-sumi-800" x-text="calendarYear + '年' + (calendarMonth + 1) + '月'"></h3>
                <button @click="nextMonth()" class="px-4 py-2 text-sm text-sumi-600 hover:text-sumi-800 transition-colors">
                    翌月
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-white rounded border border-sumi-200 overflow-hidden">
                <!-- Week days header -->
                <div class="grid grid-cols-7 bg-sumi-50 border-b border-sumi-200">
                    <template x-for="(day, i) in ['日', '月', '火', '水', '木', '金', '土']" :key="day">
                        <div class="py-2.5 text-center text-xs font-medium"
                             :class="i === 0 ? 'text-sango-500' : i === 6 ? 'text-ai-500' : 'text-sumi-500'"
                             x-text="day"></div>
                    </template>
                </div>
                <!-- Calendar days -->
                <div class="grid grid-cols-7">
                    <template x-for="(day, idx) in calendarDays" :key="idx">
                        <div
                            class="min-h-[80px] border-b border-r border-sumi-100 p-1.5 cursor-pointer transition-colors relative"
                            :class="{
                                'bg-sumi-50': !day.currentMonth,
                                'hover:bg-ai-50': day.currentMonth && getSlotsForDate(day.dateStr).length === 0,
                                'bg-ai-50': selectedDate === day.dateStr,
                                'border-l border-sumi-100': idx % 7 === 0,
                                'bg-wakakusa-50': day.currentMonth && getSlotsForDate(day.dateStr).length > 0 && getSlotsForDate(day.dateStr).length <= 5 && selectedDate !== day.dateStr,
                                'bg-wakakusa-100': day.currentMonth && getSlotsForDate(day.dateStr).length > 5 && getSlotsForDate(day.dateStr).length <= 15 && selectedDate !== day.dateStr,
                                'bg-wakakusa-200': day.currentMonth && getSlotsForDate(day.dateStr).length > 15 && selectedDate !== day.dateStr
                            }"
                            @click="day.currentMonth && selectDate(day.dateStr)"
                        >
                            <div class="flex justify-between items-start">
                                <span
                                    class="text-sm font-medium"
                                    :class="{
                                        'text-sumi-300': !day.currentMonth,
                                        'text-sango-600': day.currentMonth && day.dayOfWeek === 0,
                                        'text-ai-600': day.currentMonth && day.dayOfWeek === 6,
                                        'text-sumi-700': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                    }"
                                    x-text="day.day"
                                ></span>
                                <template x-if="day.currentMonth && getSlotsForDate(day.dateStr).length > 0">
                                    <span class="px-1.5 py-0.5 text-xs font-bold rounded-full bg-wakakusa-500 text-white shadow-sm" x-text="getSlotsForDate(day.dateStr).length"></span>
                                </template>
                            </div>
                            <!-- Availability bar indicator -->
                            <template x-if="day.currentMonth && getSlotsForDate(day.dateStr).length > 0">
                                <div class="absolute bottom-0 left-0 right-0 h-1"
                                     :class="{
                                         'bg-wakakusa-300': getSlotsForDate(day.dateStr).length <= 5,
                                         'bg-wakakusa-400': getSlotsForDate(day.dateStr).length > 5 && getSlotsForDate(day.dateStr).length <= 15,
                                         'bg-wakakusa-500': getSlotsForDate(day.dateStr).length > 15
                                     }"></div>
                            </template>
                            <!-- Slot preview for large screens -->
                            <div class="hidden sm:block mt-1 space-y-0.5 overflow-hidden max-h-[50px]">
                                <template x-for="slot in getSlotsForDate(day.dateStr).slice(0, 2)" :key="slot.id">
                                    <div class="text-xs px-1 py-0.5 bg-white/70 text-wakakusa-800 rounded truncate" x-text="slot.time_from + ' ' + (slot.court_name || '').substring(0, 6)"></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Selected Date Detail -->
            <div x-show="selectedDate" class="mt-6 bg-white rounded border border-sumi-200 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-sumi-800" x-text="formatDateFull(selectedDate)"></h4>
                    <span class="text-sm text-sumi-500" x-text="getSlotsForDate(selectedDate).length + ' 件'"></span>
                </div>
                <div class="space-y-2 max-h-[300px] overflow-y-auto">
                    <template x-for="slot in getSlotsForDate(selectedDate)" :key="slot.id">
                        <div class="flex justify-between items-center p-3 bg-sumi-50 rounded">
                            <div>
                                <p class="font-medium text-sumi-800" x-text="slot.court_name || slot.ground_name"></p>
                                <p class="text-sm text-sumi-500" x-text="slot.municipality_name"></p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-sumi-800" x-text="slot.time_from + ' - ' + slot.time_to"></p>
                            </div>
                        </div>
                    </template>
                    <p x-show="getSlotsForDate(selectedDate).length === 0" class="text-sumi-400 text-center py-4">空きはありません</p>
                </div>
            </div>

            <!-- Summary -->
            <div class="mt-6 py-3 border-t border-sumi-200">
                <p class="text-sm text-sumi-500">
                    合計 <span class="font-medium text-sumi-700" x-text="filteredSlots.length"></span> 件
                    <span x-show="selectedMunicipality || selectedGround" class="ml-2 text-ai-600">(絞り込み中)</span>
                </p>
            </div>
        </div>

        <!-- Watch Conditions -->
        <div x-show="tab === 'conditions'">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-sumi-800">監視ルール</h2>
                <button @click="showConditionModal = true" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">ルールを追加</button>
            </div>
            <div class="space-y-3">
                <template x-for="c in conditions" :key="c.id">
                    <div class="bg-white rounded border border-sumi-200 p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-sumi-800" x-text="getGroundName(c.facility_id)"></p>
                                <p class="text-sm text-sumi-500 mt-1">
                                    <span x-text="formatDays(c.days_of_week)"></span>
                                    <span class="mx-1">·</span>
                                    <span x-text="c.time_from + ' - ' + c.time_to"></span>
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-2 py-0.5 text-xs rounded" :class="c.enabled ? 'bg-wakakusa-100 text-wakakusa-700' : 'bg-sumi-100 text-sumi-500'" x-text="c.enabled ? '有効' : '無効'"></span>
                                <button @click="deleteCondition(c.id)" class="text-sango-500 hover:text-sango-600 text-sm transition-colors">削除</button>
                            </div>
                        </div>
                    </div>
                </template>
                <p x-show="conditions.length === 0" class="text-sumi-400 text-center py-12">監視ルールが設定されていません</p>
            </div>
        </div>

        <!-- Notifications -->
        <div x-show="tab === 'notifications'">
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">通知履歴</h2>
            <div class="space-y-3">
                <template x-for="n in notifications" :key="n.id">
                    <div class="bg-white rounded border border-sumi-200 p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium text-sumi-800" x-text="n.facility_name || '施設'"></p>
                                <p class="text-sm text-sumi-500" x-text="n.slot_date + ' ' + n.slot_time"></p>
                            </div>
                            <span class="px-2 py-0.5 text-xs rounded" :class="{'bg-wakakusa-100 text-wakakusa-700': n.status === 'sent', 'bg-kinari-200 text-sumi-600': n.status === 'pending', 'bg-sango-100 text-sango-700': n.status === 'failed'}" x-text="getNotificationStatus(n.status)"></span>
                        </div>
                    </div>
                </template>
                <p x-show="notifications.length === 0" class="text-sumi-400 text-center py-12">通知履歴がありません</p>
            </div>
        </div>

        <!-- Settings -->
        <div x-show="tab === 'settings'">
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">設定</h2>

            <!-- Account Settings -->
            <div class="bg-white rounded border border-sumi-200 p-6 space-y-4 mb-6">
                <h3 class="font-semibold text-sumi-800">アカウント</h3>
                <div>
                    <label class="block text-sm text-sumi-500 mb-1">チーム名</label>
                    <input type="text" x-model="team?.name" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm bg-sumi-50" disabled>
                </div>
                <div>
                    <label class="block text-sm text-sumi-500 mb-1">メールアドレス</label>
                    <input type="email" x-model="team?.email" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm bg-sumi-50" disabled>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="bg-white rounded border border-sumi-200 p-6 space-y-4 mb-6">
                <h3 class="font-semibold text-sumi-800">通知設定</h3>
                <p class="text-sm text-sumi-500">空きが見つかった時の通知方法を選択してください</p>

                <div class="space-y-3">
                    <!-- Email -->
                    <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-sumi-50 transition-colors" :class="notificationSettings.email ? 'border-ai-500 bg-ai-50' : 'border-sumi-200'">
                        <input type="checkbox" x-model="notificationSettings.email" class="mr-3 accent-ai-600">
                        <div class="flex-1">
                            <p class="font-medium text-sumi-800 text-sm">メール通知</p>
                            <p class="text-sm text-sumi-500" x-text="team?.email"></p>
                        </div>
                    </label>

                    <!-- LINE (future) -->
                    <label class="flex items-center p-3 border border-sumi-100 rounded cursor-not-allowed opacity-50">
                        <input type="checkbox" disabled class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium text-sumi-800 text-sm">LINE 通知</p>
                            <p class="text-sm text-sumi-400">近日公開予定</p>
                        </div>
                    </label>

                    <!-- Slack (future) -->
                    <label class="flex items-center p-3 border border-sumi-100 rounded cursor-not-allowed opacity-50">
                        <input type="checkbox" disabled class="mr-3">
                        <div class="flex-1">
                            <p class="font-medium text-sumi-800 text-sm">Slack 通知</p>
                            <p class="text-sm text-sumi-400">近日公開予定</p>
                        </div>
                    </label>
                </div>

                <button @click="saveNotificationSettings()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">
                    設定を保存
                </button>
            </div>

            <!-- Plan -->
            <div class="bg-white rounded border border-sumi-200 p-6 space-y-4 mb-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-sumi-800">プラン</h3>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-sumi-500">月払い</span>
                        <button @click="billingInterval = billingInterval === 'monthly' ? 'yearly' : 'monthly'"
                                class="relative w-10 h-5 rounded-full transition-colors"
                                :class="billingInterval === 'yearly' ? 'bg-ai-600' : 'bg-sumi-300'">
                            <span class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform"
                                  :class="billingInterval === 'yearly' ? 'translate-x-5' : ''"></span>
                        </button>
                        <span class="text-sumi-500">年払い</span>
                        <span x-show="billingInterval === 'yearly'" class="text-xs text-wakakusa-600 font-medium">20%OFF</span>
                    </div>
                </div>

                <!-- Current Plan Info -->
                <div class="bg-sumi-50 rounded p-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-sumi-500">現在のプラン</span>
                        <span class="font-medium text-sumi-800" x-text="team?.plan?.charAt(0).toUpperCase() + team?.plan?.slice(1)"></span>
                    </div>
                    <div x-show="team?.billing_interval" class="flex justify-between mt-1">
                        <span class="text-sumi-500">請求サイクル</span>
                        <span class="text-sumi-700" x-text="team?.billing_interval === 'yearly' ? '年払い' : '月払い'"></span>
                    </div>
                    <div x-show="team?.current_period_end" class="flex justify-between mt-1">
                        <span class="text-sumi-500">次回更新日</span>
                        <span class="text-sumi-700" x-text="new Date(team?.current_period_end).toLocaleDateString('ja-JP')"></span>
                    </div>
                </div>

                <!-- Plan Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <template x-for="p in plans" :key="p.id">
                        <div class="border rounded p-4"
                             :class="team?.plan === p.id ? 'border-ai-500 bg-ai-50' : 'border-sumi-200 hover:border-sumi-300'">
                            <p class="font-semibold text-sumi-800" x-text="p.name"></p>
                            <div class="mt-2">
                                <p class="text-xl font-bold text-sumi-800">
                                    <span x-text="'¥' + (billingInterval === 'yearly' ? p.yearly_price : p.monthly_price).toLocaleString()"></span>
                                    <span class="text-sm font-normal text-sumi-500" x-text="billingInterval === 'yearly' ? '/年' : '/月'"></span>
                                </p>
                                <p x-show="billingInterval === 'yearly' && p.yearly_savings > 0" class="text-xs text-wakakusa-600">
                                    年間 ¥<span x-text="p.yearly_savings.toLocaleString()"></span> お得
                                </p>
                            </div>
                            <p class="text-sm text-sumi-500 mt-2">
                                <span x-text="p.max_facilities === -1 ? '施設数無制限' : p.max_facilities + ' 施設まで'"></span>
                            </p>
                            <button x-show="team?.plan !== p.id && p.id !== 'free'"
                                    @click="selectedPlan = p.id; showUpgradeModal = true"
                                    class="mt-3 w-full bg-ai-600 text-white py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">
                                アップグレード
                            </button>
                            <span x-show="team?.plan === p.id" class="mt-3 block text-center text-ai-600 font-medium text-sm">現在のプラン</span>
                        </div>
                    </template>
                </div>

                <!-- Billing Portal Button -->
                <div x-show="team?.stripe_subscription_id" class="pt-4 border-t border-sumi-200">
                    <button @click="openBillingPortal()" class="text-ai-600 hover:text-ai-700 text-sm font-medium transition-colors">
                        請求管理
                    </button>
                </div>
            </div>

            <!-- Update Log -->
            <div class="bg-white rounded border border-sumi-200 p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-sumi-800">更新ログ</h3>
                    <button @click="loadJobs()" class="text-ai-600 hover:text-ai-700 text-sm font-medium transition-colors">更新</button>
                </div>
                <p class="text-sm text-sumi-500 mb-3">スロットデータの更新履歴</p>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <template x-if="jobs.length === 0">
                        <p class="text-sm text-sumi-400">更新履歴がありません</p>
                    </template>
                    <template x-for="job in jobs.slice(0, 10)" :key="job.id">
                        <div class="border-b border-sumi-100 last:border-0">
                            <div class="flex items-center justify-between text-sm py-2 cursor-pointer hover:bg-sumi-50 px-2 -mx-2 rounded"
                                 @click="job.expanded = !job.expanded">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="getJobStatusColor(job.status)"></span>
                                    <span class="text-sumi-700" x-text="job.municipality_name"></span>
                                    <svg class="w-4 h-4 text-sumi-400 transition-transform" :class="job.expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <div class="flex items-center gap-3 text-sumi-500">
                                    <span x-show="job.status === 'completed'" x-text="job.slots_found + ' 件'"></span>
                                    <span x-show="job.status === 'failed'" class="text-sango-500">エラー</span>
                                    <span x-text="formatJobTime(job.created_at)"></span>
                                </div>
                            </div>
                            <div x-show="job.expanded" class="pl-4 pb-2 text-xs space-y-1">
                                <div class="text-sumi-500">
                                    <span class="font-medium">ステータス:</span> <span x-text="job.scrape_status || job.status"></span>
                                </div>
                                <div x-show="job.error_message" class="text-sango-600">
                                    <span class="font-medium">エラー:</span> <span x-text="job.error_message"></span>
                                </div>
                                <div x-show="job.diagnostics" class="text-sumi-600">
                                    <span class="font-medium">ログ:</span>
                                    <pre class="mt-1 p-2 bg-sumi-50 rounded text-xs overflow-x-auto whitespace-pre-wrap" x-text="formatDiagnostics(job.diagnostics)"></pre>
                                </div>
                                <div class="text-sumi-400">
                                    <span x-show="job.started_at">開始: <span x-text="formatJobTime(job.started_at)"></span></span>
                                    <span x-show="job.completed_at" class="ml-2">完了: <span x-text="formatJobTime(job.completed_at)"></span></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="bg-white rounded border border-sango-200 p-6">
                <h3 class="font-semibold text-sango-600 mb-4">危険な操作</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-sumi-800 text-sm">アカウント削除</p>
                            <p class="text-sm text-sumi-500">アカウントとすべてのデータを完全に削除します</p>
                        </div>
                        <button @click="showDeleteModal = true" class="px-4 py-2 border border-sango-300 text-sango-600 rounded text-sm font-medium hover:bg-sango-50 transition-colors">アカウント削除</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div x-show="showUpgradeModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50">
        <div class="bg-white rounded border border-sumi-200 p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-sumi-800 mb-4">プランをアップグレード</h3>
            <div class="space-y-4">
                <div class="bg-sumi-50 rounded p-4">
                    <p class="text-sm text-sumi-500">選択中のプラン</p>
                    <p class="text-lg font-semibold text-sumi-800" x-text="plans.find(p => p.id === selectedPlan)?.name"></p>
                    <p class="text-xl font-bold text-ai-600 mt-1">
                        ¥<span x-text="(billingInterval === 'yearly' ? plans.find(p => p.id === selectedPlan)?.yearly_price : plans.find(p => p.id === selectedPlan)?.monthly_price)?.toLocaleString()"></span>
                        <span class="text-sm font-normal text-sumi-500" x-text="billingInterval === 'yearly' ? '/年' : '/月'"></span>
                    </p>
                </div>

                <!-- Promo Code -->
                <div>
                    <label class="block text-sm text-sumi-600 mb-1">プロモコード（任意）</label>
                    <div class="flex gap-2">
                        <input type="text" x-model="promoCode" @input="promoCodeError = ''; promoCodeValid = null"
                               class="flex-1 border border-sumi-200 rounded px-3 py-2 text-sm uppercase focus:border-ai-500 focus:outline-none" placeholder="PROMO2024">
                        <button @click="validatePromoCode()" :disabled="!promoCode || promoCodeLoading"
                                class="px-4 py-2 border border-sumi-200 rounded text-sm hover:bg-sumi-50 disabled:opacity-50 transition-colors">
                            <span x-show="!promoCodeLoading">確認</span>
                            <span x-show="promoCodeLoading">...</span>
                        </button>
                    </div>
                    <p x-show="promoCodeError" class="text-sango-500 text-sm mt-1" x-text="promoCodeError"></p>
                    <p x-show="promoCodeValid" class="text-wakakusa-600 text-sm mt-1">
                        <span x-text="promoCodeValid?.discount"></span> が適用されます
                    </p>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button @click="showUpgradeModal = false; promoCode = ''; promoCodeValid = null; promoCodeError = ''"
                        class="px-4 py-2 border border-sumi-200 rounded text-sm hover:bg-sumi-50 transition-colors">キャンセル</button>
                <button @click="startCheckout()" :disabled="checkoutLoading"
                        class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 disabled:opacity-50 transition-colors">
                    <span x-show="!checkoutLoading">お支払いへ進む</span>
                    <span x-show="checkoutLoading">処理中...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div x-show="showDeleteModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50">
        <div class="bg-white rounded border border-sumi-200 p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-sango-600 mb-4">アカウント削除</h3>
            <div class="space-y-4">
                <div class="bg-sango-50 border border-sango-200 rounded p-4">
                    <p class="text-sm text-sango-700">この操作は取り消せません。監視ルールや通知履歴を含むすべてのデータが完全に削除されます。</p>
                </div>
                <div>
                    <label class="block text-sm text-sumi-600 mb-1">確認のためメールアドレスを入力してください: <span class="font-medium" x-text="team?.email"></span></label>
                    <input type="email" x-model="deleteConfirmEmail"
                           class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:border-sango-500 focus:outline-none"
                           placeholder="your@email.com">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button @click="showDeleteModal = false; deleteConfirmEmail = ''"
                        class="px-4 py-2 border border-sumi-200 rounded text-sm hover:bg-sumi-50 transition-colors">キャンセル</button>
                <button @click="deleteAccount()" :disabled="deleteLoading || deleteConfirmEmail !== team?.email"
                        class="px-4 py-2 bg-sango-600 text-white rounded text-sm font-medium hover:bg-sango-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <span x-show="!deleteLoading">アカウント削除</span>
                    <span x-show="deleteLoading">削除中...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Condition Modal -->
    <div x-show="showConditionModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50">
        <div class="bg-white rounded border border-sumi-200 p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-sumi-800 mb-4">監視ルールを追加</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-sumi-600 mb-1">地域</label>
                    <select x-model="newCondition.municipality_id" @change="newCondition.ground_id = ''" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                        <option value="">地域を選択</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-sumi-600 mb-1">施設</label>
                    <select x-model="newCondition.ground_id" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                        <option value="">施設を選択</option>
                        <template x-for="g in groundsForSelectedMunicipality" :key="g.id">
                            <option :value="g.id" x-text="g.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-sumi-600 mb-1">曜日</label>
                    <div class="flex flex-wrap gap-2 mt-1">
                        <template x-for="(day, i) in ['日', '月', '火', '水', '木', '金', '土']" :key="i">
                            <button type="button" @click="toggleDay(i)" class="px-3 py-1.5 border rounded text-sm transition-colors" :class="newCondition.days_of_week.includes(i) ? 'bg-ai-600 text-white border-ai-600' : 'border-sumi-200 text-sumi-600 hover:border-sumi-300'" x-text="day"></button>
                        </template>
                    </div>
                    <p x-show="currentPlanLimit?.weekend_only" class="text-xs text-sango-500 mt-1">無料プラン: 週末のみ</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-sumi-600 mb-1">開始時間</label>
                        <input type="time" x-model="newCondition.time_from" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-sumi-600 mb-1">終了時間</label>
                        <input type="time" x-model="newCondition.time_to" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:border-ai-500 focus:outline-none">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button @click="showConditionModal = false" class="px-4 py-2 border border-sumi-200 rounded text-sm hover:bg-sumi-50 transition-colors">キャンセル</button>
                <button @click="createCondition()" class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">追加</button>
            </div>
        </div>
    </div>

    <script>
    const DAY_NAMES = ['日', '月', '火', '水', '木', '金', '土'];
    const TAB_ITEMS = [
        { id: 'slots', label: '空き状況' },
        { id: 'conditions', label: '監視ルール' },
        { id: 'notifications', label: '通知履歴' },
        { id: 'settings', label: '設定' }
    ];
    const JOB_STATUS_COLORS = {
        completed: 'bg-wakakusa-500',
        failed: 'bg-sango-500',
        running: 'bg-ai-500 animate-pulse',
        pending: 'bg-sumi-300'
    };

    function userApp() {
        return {
            tabItems: TAB_ITEMS,
            team: null,
            tab: 'slots',
            conditions: [],
            notifications: [],
            municipalities: [],
            grounds: [],
            slots: [],
            planLimits: [],
            selectedMunicipality: '',
            selectedGround: '',
            loginEmail: '',
            loginName: '',
            loginError: '',
            loginLoading: false,
            isRegister: false,
            emailSent: false,
            debugLink: null,
            oauthConfig: { google_enabled: false },
            notificationSettings: { email: true },
            showConditionModal: false,
            newCondition: { municipality_id: '', ground_id: '', days_of_week: [6, 0], time_from: '09:00', time_to: '17:00' },
            // Calendar state
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            selectedDate: null,
            // Update status
            lastUpdate: null,
            refreshing: false,
            jobs: [],
            // Billing state
            plans: [],
            billingInterval: 'monthly',
            showUpgradeModal: false,
            showDeleteModal: false,
            deleteConfirmEmail: '',
            deleteLoading: false,
            selectedPlan: null,
            promoCode: '',
            promoCodeValid: null,
            promoCodeError: '',
            promoCodeLoading: false,
            checkoutLoading: false,

            async init() {
                // Load OAuth config
                try {
                    const res = await fetch('/api/auth/config');
                    if (res.ok) {
                        this.oauthConfig = await res.json();
                    }
                } catch (e) {
                    console.warn('Failed to load OAuth config', e);
                }

                const saved = localStorage.getItem('akigura_team');
                if (saved) {
                    this.team = JSON.parse(saved);
                    await this.loadData();
                }
                await this.loadMasterData();
                await this.loadJobs();
                this.updateLastUpdateInfo();
            },

            // Calendar methods
            get calendarDays() {
                const days = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay();

                // Previous month days
                const prevMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const d = prevMonth.getDate() - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: false,
                        dayOfWeek: date.getDay()
                    });
                }

                // Current month days
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: true,
                        dayOfWeek: date.getDay()
                    });
                }

                // Next month days to fill the grid
                const remaining = 42 - days.length;
                for (let d = 1; d <= remaining; d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, d);
                    days.push({
                        day: d,
                        dateStr: this.toDateStr(date),
                        currentMonth: false,
                        dayOfWeek: date.getDay()
                    });
                }

                return days;
            },

            toDateStr(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            },

            changeMonth(delta) {
                const d = new Date(this.calendarYear, this.calendarMonth + delta, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            prevMonth() { this.changeMonth(-1); },
            nextMonth() { this.changeMonth(1); },

            selectDate(dateStr) {
                this.selectedDate = this.selectedDate === dateStr ? null : dateStr;
            },

            getSlotsForDate(dateStr) {
                return this.filteredSlots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            formatDateFull(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} (${DAY_NAMES[d.getDay()]})`;
            },

            async login() {
                this.loginError = '';
                this.debugLink = null;
                if (!this.loginEmail) {
                    this.loginError = 'メールアドレスを入力してください';
                    return;
                }
                if (this.isRegister && !this.loginName.trim()) {
                    this.loginError = 'チーム名を入力してください';
                    return;
                }

                this.loginLoading = true;
                try {
                    const res = await fetch('/api/auth/magic-link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: this.loginEmail,
                            name: this.isRegister ? this.loginName : ''
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        this.loginError = data.error || 'リクエストに失敗しました';
                        return;
                    }
                    // Show email sent screen
                    this.emailSent = true;
                    // In debug mode, show the link directly
                    if (data.debug_link) {
                        this.debugLink = data.debug_link;
                    }
                } catch (e) {
                    this.loginError = '接続エラー';
                } finally {
                    this.loginLoading = false;
                }
            },

            logout() {
                this.team = null;
                this.emailSent = false;
                localStorage.removeItem('akigura_team');
            },

            async saveNotificationSettings() {
                // For now just show confirmation - actual save would need team update API
                alert('通知設定を保存しました');
            },

            async loadData() {
                if (!this.team) return;
                const [condRes, notifRes] = await Promise.all([
                    fetch('/api/conditions?team_id=' + this.team.id),
                    fetch('/api/notifications?team_id=' + this.team.id)
                ]);
                this.conditions = await condRes.json() || [];
                this.notifications = await notifRes.json() || [];
            },

            async loadMasterData() {
                const [munRes, groundRes, slotRes, planRes, plansRes] = await Promise.all([
                    fetch('/api/municipalities'),
                    fetch('/api/grounds'),
                    fetch('/api/slots'),
                    fetch('/api/plan-limits'),
                    fetch('/api/plans')
                ]);
                this.municipalities = await munRes.json() || [];
                this.grounds = await groundRes.json() || [];
                this.slots = await slotRes.json() || [];
                this.planLimits = await planRes.json() || [];
                this.plans = await plansRes.json() || [];
            },

            async loadSlots() {
                let url = '/api/slots';
                const params = [];
                if (this.selectedMunicipality) params.push('municipality_id=' + this.selectedMunicipality);
                if (this.selectedGround) params.push('ground_id=' + this.selectedGround);
                if (params.length) url += '?' + params.join('&');
                const res = await fetch(url);
                this.slots = await res.json() || [];
            },

            get filteredGrounds() {
                if (!this.selectedMunicipality) return this.grounds;
                return this.grounds.filter(g => g.municipality_id === this.selectedMunicipality);
            },

            get filteredSlots() {
                let result = this.slots;
                if (this.selectedMunicipality) {
                    result = result.filter(s => {
                        const ground = this.grounds.find(g => g.id === s.ground_id);
                        return ground && ground.municipality_id === this.selectedMunicipality;
                    });
                }
                if (this.selectedGround) {
                    result = result.filter(s => s.ground_id === this.selectedGround);
                }
                return result;
            },

            get groundsForSelectedMunicipality() {
                if (!this.newCondition.municipality_id) return [];
                if (!this.grounds || this.grounds.length === 0) return [];
                return this.grounds.filter(g => g.municipality_id === this.newCondition.municipality_id);
            },

            get currentPlanLimit() {
                if (!this.team) return null;
                return this.planLimits.find(p => p.plan === this.team.plan);
            },

            getGroundName(id) {
                const g = this.grounds.find(g => g.id === id);
                return g ? g.name + ' (' + g.municipality_name + ')' : '不明な施設';
            },

            formatDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}(${DAY_NAMES[d.getDay()]})`;
            },

            formatDays(days) {
                if (!days) return '';
                try {
                    const arr = typeof days === 'string' ? JSON.parse(days) : days;
                    if (!Array.isArray(arr)) return '';
                    return arr.map(d => DAY_NAMES[d]).join(', ');
                } catch {
                    return '';
                }
            },

            toggleDay(day) {
                const idx = this.newCondition.days_of_week.indexOf(day);
                if (idx >= 0) {
                    this.newCondition.days_of_week.splice(idx, 1);
                } else {
                    this.newCondition.days_of_week.push(day);
                }
            },

            filterSlots() {
                // Reset ground selection when municipality changes
                if (!this.selectedMunicipality) {
                    this.selectedGround = '';
                }
            },

            async createCondition() {
                if (!this.newCondition.ground_id) {
                    alert('施設を選択してください');
                    return;
                }
                await fetch('/api/conditions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team_id: this.team.id,
                        facility_id: this.newCondition.ground_id,
                        days_of_week: JSON.stringify(this.newCondition.days_of_week),
                        time_from: this.newCondition.time_from,
                        time_to: this.newCondition.time_to
                    })
                });
                this.showConditionModal = false;
                this.newCondition = { municipality_id: '', ground_id: '', days_of_week: [6, 0], time_from: '09:00', time_to: '17:00' };
                await this.loadData();
            },

            async deleteCondition(id) {
                if (!confirm('この監視ルールを削除しますか？')) return;
                await fetch('/api/conditions/' + id, { method: 'DELETE' });
                await this.loadData();
            },

            // Update/Refresh methods
            async loadJobs() {
                try {
                    const res = await fetch('/api/jobs?limit=20');
                    this.jobs = await res.json() || [];
                } catch (e) {
                    console.error('Failed to load jobs', e);
                }
            },

            async refreshSlots() {
                this.refreshing = true;
                try {
                    // Trigger scrape for selected municipality or all
                    const body = this.selectedMunicipality
                        ? { municipality_id: this.selectedMunicipality }
                        : {};
                    await fetch('/api/scrape', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    // Wait a bit for scrape to complete
                    await new Promise(r => setTimeout(r, 3000));
                    // Reload data
                    await this.loadSlots();
                    await this.loadJobs();
                    this.updateLastUpdateInfo();
                } catch (e) {
                    console.error('Failed to refresh', e);
                } finally {
                    this.refreshing = false;
                }
            },

            updateLastUpdateInfo() {
                if (this.jobs.length > 0) {
                    const latest = this.jobs.find(j => j.status === 'completed');
                    if (latest) {
                        this.lastUpdate = {
                            time: this.formatJobTime(latest.completed_at || latest.created_at),
                            count: latest.slots_found
                        };
                    }
                }
            },

            formatJobTime(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                const now = new Date();
                const diff = now - d;
                if (diff < 60000) return 'たった今';
                if (diff < 3600000) return Math.floor(diff / 60000) + '分前';
                if (diff < 86400000) return Math.floor(diff / 3600000) + '時間前';
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            },

            formatDiagnostics(diag) {
                if (!diag) return '';
                try {
                    const obj = typeof diag === 'string' ? JSON.parse(diag) : diag;
                    const lines = [];
                    if (obj.search_started) lines.push(`検索開始: ${obj.search_started}`);
                    if (obj.search_completed) lines.push(`検索完了: ${obj.search_completed}`);
                    if (obj.raw_results_count !== undefined) lines.push(`取得件数: ${obj.raw_results_count}`);
                    if (obj.parsed_slots_count !== undefined) lines.push(`解析済み: ${obj.parsed_slots_count}`);
                    if (obj.note) lines.push(`備考: ${obj.note}`);
                    if (obj.parse_errors?.length > 0) lines.push(`解析エラー: ${obj.parse_errors.join(', ')}`);
                    if (obj.exception_type) lines.push(`例外: ${obj.exception_type}`);
                    if (obj.html_verification?.confirmation) lines.push(`検証: ${obj.html_verification.confirmation}`);
                    return lines.length > 0 ? lines.join('\n') : JSON.stringify(obj, null, 2);
                } catch {
                    return String(diag);
                }
            },

            getJobStatusColor(status) {
                return JOB_STATUS_COLORS[status] || JOB_STATUS_COLORS.pending;
            },

            // Billing methods
            async validatePromoCode() {
                if (!this.promoCode) return;
                this.promoCodeLoading = true;
                this.promoCodeError = '';
                this.promoCodeValid = null;
                try {
                    const res = await fetch('/api/billing/validate-promo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: this.promoCode,
                            team_id: this.team?.id,
                            plan: this.selectedPlan
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        this.promoCodeError = data.error || '無効なプロモコード';
                        return;
                    }
                    this.promoCodeValid = data;
                } catch (e) {
                    this.promoCodeError = '接続エラー';
                } finally {
                    this.promoCodeLoading = false;
                }
            },

            async startCheckout() {
                if (!this.team || !this.selectedPlan) return;
                this.checkoutLoading = true;
                try {
                    const res = await fetch('/api/billing/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_id: this.team.id,
                            plan: this.selectedPlan,
                            interval: this.billingInterval,
                            promo_code: this.promoCodeValid ? this.promoCode : ''
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        alert(data.error || '決済画面の作成に失敗しました');
                        return;
                    }
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } catch (e) {
                    alert('接続エラー');
                } finally {
                    this.checkoutLoading = false;
                }
            },

            async deleteAccount() {
                if (!this.team || this.deleteConfirmEmail !== this.team.email) return;
                this.deleteLoading = true;
                try {
                    const res = await fetch('/api/teams/' + this.team.id, {
                        method: 'DELETE'
                    });
                    if (!res.ok) {
                        const data = await res.json();
                        alert(data.error || 'アカウントの削除に失敗しました');
                        return;
                    }
                    // Clear local state and show login
                    this.team = null;
                    this.showDeleteModal = false;
                    this.deleteConfirmEmail = '';
                    localStorage.removeItem('akigura_team');
                    alert('アカウントが削除されました');
                } catch (e) {
                    alert('接続エラー');
                } finally {
                    this.deleteLoading = false;
                }
            },

            async openBillingPortal() {
                if (!this.team) return;
                try {
                    const res = await fetch('/api/billing/portal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ team_id: this.team.id })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        alert(data.error || '請求ポータルの作成に失敗しました');
                        return;
                    }
                    window.location.href = data.url;
                } catch (e) {
                    alert('接続エラー');
                }
            }
        }
    }
    </script>
</body>
</html>
