<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - „Ç∞„É©„Ç¶„É≥„ÉâÁõ£Ë¶ñSaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">üèà AkiGura Control Plane</h1>
            <nav class="flex space-x-4">
                <button @click="currentTab = 'dashboard'" :class="{'bg-indigo-700': currentTab === 'dashboard'}" class="px-3 py-2 rounded hover:bg-indigo-500">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
                <button @click="currentTab = 'teams'" :class="{'bg-indigo-700': currentTab === 'teams'}" class="px-3 py-2 rounded hover:bg-indigo-500">„ÉÅ„Éº„É†ÁÆ°ÁêÜ</button>
                <button @click="currentTab = 'facilities'" :class="{'bg-indigo-700': currentTab === 'facilities'}" class="px-3 py-2 rounded hover:bg-indigo-500">ÊñΩË®≠ÁÆ°ÁêÜ</button>
                <button @click="currentTab = 'slots'" :class="{'bg-indigo-700': currentTab === 'slots'}" class="px-3 py-2 rounded hover:bg-indigo-500">Á©∫„ÅçÁä∂Ê≥Å</button>
                <button @click="currentTab = 'support'" :class="{'bg-indigo-700': currentTab === 'support'}" class="px-3 py-2 rounded hover:bg-indigo-500">AI„Çµ„Éù„Éº„Éà</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <h2 class="text-2xl font-bold mb-6">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">ÁôªÈå≤„ÉÅ„Éº„É†Êï∞</div>
                    <div class="text-3xl font-bold text-indigo-600" x-text="dashboard.TeamCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">ÂØæÂøúÊñΩË®≠Êï∞</div>
                    <div class="text-3xl font-bold text-green-600" x-text="dashboard.FacilityCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">Áõ£Ë¶ñÊù°‰ª∂Êï∞</div>
                    <div class="text-3xl font-bold text-blue-600" x-text="dashboard.WatchConditionCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">Êú™ÂØæÂøú„ÉÅ„Ç±„ÉÉ„Éà</div>
                    <div class="text-3xl font-bold text-red-600" x-text="dashboard.OpenTicketCount">0</div>
                </div>
            </div>
            <!-- Plan Distribution -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">„Éó„É©„É≥Âà•„ÉÅ„Éº„É†Êï∞</h3>
                <div class="flex space-x-4">
                    <template x-for="plan in dashboard.TeamsByPlan" :key="plan.plan">
                        <div class="flex-1 bg-gray-50 rounded p-4 text-center">
                            <div class="text-sm text-gray-500" x-text="plan.plan"></div>
                            <div class="text-2xl font-bold" x-text="plan.count"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Teams -->
        <div x-show="currentTab === 'teams'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">„ÉÅ„Éº„É†ÁÆ°ÁêÜ</h2>
                <button @click="showTeamModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„ÉÅ„Éº„É†Âêç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„É°„Éº„É´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Éó„É©„É≥</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="team in teams" :key="team.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="team.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="team.email"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-gray-100': team.plan === 'free', 'bg-blue-100': team.plan === 'personal', 'bg-purple-100': team.plan === 'pro', 'bg-yellow-100': team.plan === 'org'}" x-text="team.plan"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-green-100 text-green-800': team.status === 'active', 'bg-red-100 text-red-800': team.status !== 'active'}" x-text="team.status"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Facilities -->
        <div x-show="currentTab === 'facilities'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ÊñΩË®≠ÁÆ°ÁêÜ</h2>
                <button @click="showFacilityModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊñΩË®≠Âêç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ëá™Ê≤ª‰Ωì</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÇØ„É¨„Ç§„Éë„Éº</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="f in facilities" :key="f.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.municipality"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.scraper_type"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-green-100 text-green-800': f.enabled, 'bg-red-100 text-red-800': !f.enabled}" x-text="f.enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Slots (Á©∫„ÅçÁä∂Ê≥Å) -->
        <div x-show="currentTab === 'slots'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Á©∫„ÅçÁä∂Ê≥Å</h2>
                <div class="flex items-center space-x-4">
                    <select x-model="slotFilter.municipalityId" @change="loadSlots()" class="border rounded px-3 py-2">
                        <option value="">ÂÖ®„Å¶„ÅÆËá™Ê≤ª‰Ωì</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                    <button @click="loadSlots()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êõ¥Êñ∞</button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div x-show="slots.length === 0" class="p-8 text-center text-gray-500">
                    <p>Á©∫„ÅçÊû†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    <p class="text-sm mt-2">„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞„ÅåÂÆüË°å„Åï„Çå„Çã„Å®„ÄÅ„Åì„Åì„Å´Á©∫„ÅçÁä∂Ê≥Å„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                </div>
                <table x-show="slots.length > 0" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Êó•‰ªò</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊñΩË®≠</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ëá™Ê≤ª‰Ωì</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç≥„Éº„Éà</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="slot in slots" :key="slot.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="formatDate(slot.slot_date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="slot.time_from + ' - ' + slot.time_to"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="slot.ground_name || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="slot.municipality_name || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="slot.court_name || '-'"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="slots.length > 0" class="mt-4 text-sm text-gray-500">
                <span x-text="slots.length"></span>‰ª∂„ÅÆÁ©∫„ÅçÊû†„ÇíË°®Á§∫‰∏≠
            </div>
        </div>

        <!-- AI Support -->
        <div x-show="currentTab === 'support'" x-cloak>
            <h2 class="text-2xl font-bold mb-6">AI„Çµ„Éù„Éº„Éà</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ü§ñ AI„ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="h-64 overflow-y-auto border rounded p-4 mb-4 bg-gray-50">
                        <template x-for="(msg, i) in chatMessages" :key="i">
                            <div class="mb-2" :class="{'text-right': msg.role === 'user'}">
                                <span class="inline-block px-3 py-2 rounded-lg" :class="{'bg-indigo-600 text-white': msg.role === 'user', 'bg-gray-200': msg.role === 'ai'}" x-text="msg.content" style="white-space: pre-wrap;"></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" x-model="chatInput" @keydown.enter.prevent="handleChatKeydown($event)" @compositionstart="isComposing = true" @compositionend="isComposing = false" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÈÄÅ‰ø°)" class="flex-1 border rounded px-4 py-2">
                        <button @click="sendChat()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ÈÄÅ‰ø°</button>
                    </div>
                </div>
                <!-- Tickets -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üéüÔ∏è „Çµ„Éù„Éº„Éà„ÉÅ„Ç±„ÉÉ„Éà</h3>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        <template x-for="ticket in tickets" :key="ticket.id">
                            <div class="border rounded p-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium" x-text="ticket.subject"></span>
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-red-100 text-red-800': ticket.status === 'open', 'bg-yellow-100': ticket.status === 'escalated', 'bg-green-100 text-green-800': ticket.status === 'resolved'}" x-text="ticket.status"></span>
                                </div>
                                <div class="text-sm text-gray-500" x-text="ticket.email"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Team Modal -->
    <div x-show="showTeamModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">„ÉÅ„Éº„É†Âêç</label>
                    <input type="text" x-model="newTeam.name" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" x-model="newTeam.email" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„Éó„É©„É≥</label>
                    <select x-model="newTeam.plan" class="mt-1 block w-full border rounded px-3 py-2">
                        <option value="free">Free</option>
                        <option value="personal">Personal</option>
                        <option value="pro">Pro</option>
                        <option value="org">Org</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showTeamModal = false" class="px-4 py-2 border rounded">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createTeam()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <!-- Facility Modal -->
    <div x-show="showFacilityModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ÊñΩË®≠Âêç</label>
                    <input type="text" x-model="newFacility.name" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ëá™Ê≤ª‰Ωì</label>
                    <input type="text" x-model="newFacility.municipality" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„Çπ„ÇØ„É¨„Ç§„Éë„Éº„Çø„Ç§„Éó</label>
                    <input type="text" x-model="newFacility.scraper_type" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">URL</label>
                    <input type="url" x-model="newFacility.url" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showFacilityModal = false" class="px-4 py-2 border rounded">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createFacility()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <script>
    function app() {
        return {
            currentTab: 'dashboard',
            dashboard: { TeamCount: 0, FacilityCount: 0, WatchConditionCount: 0, NotificationCount: 0, OpenTicketCount: 0, TeamsByPlan: [] },
            teams: [],
            facilities: [],
            slots: [],
            municipalities: [],
            slotFilter: { municipalityId: '' },
            tickets: [],
            chatMessages: [],
            chatInput: '',
            isComposing: false,
            showTeamModal: false,
            showFacilityModal: false,
            newTeam: { name: '', email: '', plan: 'free' },
            newFacility: { name: '', municipality: '', scraper_type: '', url: '' },

            async init() {
                await this.loadDashboard();
                await this.loadTeams();
                await this.loadFacilities();
                await this.loadMunicipalities();
                await this.loadSlots();
                await this.loadTickets();
            },

            async loadDashboard() {
                const res = await fetch('/api/dashboard');
                this.dashboard = await res.json();
            },

            async loadTeams() {
                const res = await fetch('/api/teams');
                this.teams = await res.json();
            },

            async loadFacilities() {
                const res = await fetch('/api/grounds');
                const grounds = await res.json();
                // Map grounds to facilities format
                this.facilities = grounds.map(g => ({
                    id: g.id,
                    name: g.name,
                    municipality: g.municipality_name,
                    scraper_type: g.court_pattern,
                    enabled: g.enabled
                }));
            },

            async loadMunicipalities() {
                const res = await fetch('/api/municipalities');
                this.municipalities = await res.json();
            },

            async loadSlots() {
                let url = '/api/slots';
                if (this.slotFilter.municipalityId) {
                    url += '?municipality_id=' + this.slotFilter.municipalityId;
                }
                const res = await fetch(url);
                this.slots = await res.json() || [];
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                const month = d.getMonth() + 1;
                const day = d.getDate();
                const dow = days[d.getDay()];
                return `${month}/${day}(${dow})`;
            },

            async loadTickets() {
                const res = await fetch('/api/tickets');
                this.tickets = await res.json();
            },

            async createTeam() {
                await fetch('/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newTeam)
                });
                this.showTeamModal = false;
                this.newTeam = { name: '', email: '', plan: 'free' };
                await this.loadTeams();
                await this.loadDashboard();
            },

            async createFacility() {
                await fetch('/api/facilities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newFacility)
                });
                this.showFacilityModal = false;
                this.newFacility = { name: '', municipality: '', scraper_type: '', url: '' };
                await this.loadFacilities();
                await this.loadDashboard();
            },

            handleChatKeydown(event) {
                // IMEÂ§âÊèõ‰∏≠„ÅØÈÄÅ‰ø°„Åó„Å™„ÅÑ
                if (this.isComposing) return;
                // Shift+Enter„ÅßÈÄÅ‰ø°
                if (event.shiftKey) {
                    this.sendChat();
                }
            },

            async sendChat() {
                if (!this.chatInput.trim()) return;
                const msg = this.chatInput;
                this.chatMessages.push({ role: 'user', content: msg });
                this.chatInput = '';
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                this.chatMessages.push({ role: 'ai', content: data.response });
            }
        }
    }
    </script>
</body>
</html>
