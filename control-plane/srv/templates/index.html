<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - 管理画面</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sumi: {
                            50: '#F5F5F5',
                            100: '#E8E8E8',
                            200: '#D1D1D1',
                            300: '#B0B0B0',
                            400: '#888888',
                            500: '#6B6B6B',
                            600: '#5A5A5A',
                            700: '#454545',
                            800: '#2C2C2C',
                            900: '#1A1A1A'
                        },
                        kinari: {
                            50: '#FEFDFB',
                            100: '#FAF8F5',
                            200: '#F5F2ED'
                        },
                        ai: {
                            50: '#E8F4F8',
                            100: '#D1E9F1',
                            200: '#A3D3E3',
                            300: '#75BDD5',
                            400: '#4BA7C7',
                            500: '#3D8EAF',
                            600: '#1E4D6B',
                            700: '#1A4259',
                            800: '#153647',
                            900: '#0F2C3D'
                        },
                        wakakusa: {
                            50: '#F0F5F0',
                            100: '#E1EBE1',
                            200: '#C3D7C3',
                            300: '#A5C3A5',
                            400: '#7DAF7D',
                            500: '#5A8F5A',
                            600: '#4A7A4A',
                            700: '#3D643D',
                            800: '#2F4D2F',
                            900: '#223722'
                        },
                        sango: {
                            50: '#FDF5F5',
                            100: '#FBEBEB',
                            200: '#F5D1D1',
                            300: '#EFB7B7',
                            400: '#E38989',
                            500: '#C96161',
                            600: '#B54545',
                            700: '#963838',
                            800: '#772C2C',
                            900: '#582121'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', '"Hiragino Kaku Gothic ProN"', 'Meiryo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }

        /* 落ち着いたスクロールバー */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1D1D1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #B0B0B0;
        }

        /* ログコンテナ専用スクロールバー */
        #log-container::-webkit-scrollbar-thumb {
            background: #454545;
        }
        #log-container::-webkit-scrollbar-thumb:hover {
            background: #5A5A5A;
        }
    </style>
</head>
<body class="bg-kinari-100 min-h-screen font-sans" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-sumi-800 text-kinari-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <!-- Mobile Header -->
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-xl font-semibold tracking-tight">AkiGura</h1>
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden p-2 hover:bg-sumi-700 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
                        <path x-show="mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <!-- Desktop Nav -->
                <nav class="hidden md:flex items-center space-x-1">
                    <template x-for="tab in navTabs" :key="tab.id">
                        <button @click="currentTab = tab.id"
                                :class="currentTab === tab.id ? 'text-kinari-50 border-b-2 border-kinari-50' : 'text-sumi-300 hover:text-kinari-50'"
                                class="px-3 py-2 text-sm font-medium transition-colors"
                                x-text="tab.label"></button>
                    </template>
                </nav>
            </div>
            <!-- Mobile Nav -->
            <nav x-show="mobileMenuOpen" x-cloak class="md:hidden mt-3 pb-2 grid grid-cols-3 gap-2">
                <template x-for="tab in navTabs" :key="tab.id">
                    <button @click="currentTab = tab.id; mobileMenuOpen = false"
                            :class="currentTab === tab.id ? 'bg-sumi-700 text-kinari-50' : 'text-sumi-300 hover:bg-sumi-700'"
                            class="px-2 py-2 rounded text-sm text-center transition-colors"
                            x-text="tab.label"></button>
                </template>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">ダッシュボード</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">登録チーム数</div>
                    <div class="text-2xl font-semibold text-ai-600" x-text="dashboard.TeamCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">対応施設数</div>
                    <div class="text-2xl font-semibold text-wakakusa-600" x-text="dashboard.FacilityCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">監視条件数</div>
                    <div class="text-2xl font-semibold text-ai-500" x-text="dashboard.WatchConditionCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">未対応チケット</div>
                    <div class="text-2xl font-semibold text-sango-500" x-text="dashboard.OpenTicketCount">0</div>
                </div>
            </div>
            <!-- Plan Distribution -->
            <div class="bg-white border border-sumi-100 rounded p-6 mb-8">
                <h3 class="text-sm font-medium text-sumi-700 mb-4">プラン別チーム数</h3>
                <div class="flex flex-wrap gap-3">
                    <template x-for="plan in dashboard.TeamsByPlan" :key="plan.plan">
                        <div class="flex-1 min-w-[100px] bg-kinari-100 rounded p-4 text-center">
                            <div class="text-xs text-sumi-500 mb-1" x-text="plan.plan"></div>
                            <div class="text-xl font-semibold text-sumi-800" x-text="plan.count"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Teams -->
        <div x-show="currentTab === 'teams'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-sumi-800">チーム管理</h2>
                <button @click="showTeamModal = true" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">新規チーム追加</button>
            </div>
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-sumi-100">
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">チーム名</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">メール</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">プラン</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ステータス</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-sumi-50">
                        <template x-for="team in teams" :key="team.id">
                            <tr class="hover:bg-kinari-50 transition-colors">
                                <td class="px-5 py-4 text-sm text-sumi-800" x-text="team.name"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="team.email"></td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded border" :class="{
                                        'border-sumi-200 text-sumi-600': team.plan === 'free',
                                        'border-ai-200 text-ai-600': team.plan === 'personal',
                                        'border-ai-300 text-ai-700': team.plan === 'pro',
                                        'border-wakakusa-200 text-wakakusa-600': team.plan === 'org'
                                    }" x-text="team.plan"></span>
                                </td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-wakakusa-50 text-wakakusa-700': team.status === 'active',
                                        'bg-sango-50 text-sango-700': team.status !== 'active'
                                    }" x-text="team.status"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Facilities -->
        <div x-show="currentTab === 'facilities'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-sumi-800">施設管理</h2>
                <button @click="showFacilityModal = true" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">新規施設追加</button>
            </div>
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-sumi-100">
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">施設名</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">自治体</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">スクレイパー</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ステータス</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-sumi-50">
                        <template x-for="f in facilities" :key="f.id">
                            <tr class="hover:bg-kinari-50 transition-colors">
                                <td class="px-5 py-4 text-sm text-sumi-800" x-text="f.name"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="f.municipality"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="f.scraper_type"></td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-wakakusa-50 text-wakakusa-700': f.enabled,
                                        'bg-sango-50 text-sango-700': !f.enabled
                                    }" x-text="f.enabled ? '有効' : '無効'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Slots (空き状況) - Calendar View -->
        <div x-show="currentTab === 'slots'" x-cloak>
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 mb-4 text-sm">
                <button @click="slotView = 'municipalities'; selectedMunicipality = null; selectedGround = null"
                        class="hover:text-ai-600 transition-colors" :class="slotView === 'municipalities' ? 'text-sumi-800 font-medium' : 'text-sumi-500'">自治体一覧</button>
                <template x-if="selectedMunicipality">
                    <span class="flex items-center gap-2">
                        <span class="text-sumi-300">/</span>
                        <button @click="slotView = 'grounds'; selectedGround = null"
                                class="hover:text-ai-600 transition-colors" :class="slotView === 'grounds' ? 'text-sumi-800 font-medium' : 'text-sumi-500'" x-text="selectedMunicipality?.name"></button>
                    </span>
                </template>
                <template x-if="selectedGround">
                    <span class="flex items-center gap-2">
                        <span class="text-sumi-300">/</span>
                        <span class="text-sumi-800 font-medium" x-text="selectedGround?.name"></span>
                    </span>
                </template>
            </div>

            <!-- 自治体一覧 -->
            <div x-show="slotView === 'municipalities'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-sumi-800">自治体別空き状況</h2>
                    <button @click="loadSlots(); loadGrounds()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">更新</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="m in municipalities" :key="m.id">
                        <div @click="selectMunicipality(m)"
                             class="bg-white border border-sumi-100 rounded p-4 cursor-pointer hover:border-ai-300 transition-colors">
                            <div class="flex justify-between items-start">
                                <h3 class="font-medium text-sumi-800" x-text="m.name"></h3>
                                <span class="px-2 py-0.5 text-xs rounded bg-wakakusa-50 text-wakakusa-700"
                                      x-text="getSlotsForMunicipality(m.id).length + '件'"></span>
                            </div>
                            <p class="text-sm text-sumi-500 mt-1" x-text="getGroundsForMunicipality(m.id).length + '施設'"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- グラウンド一覧 -->
            <div x-show="slotView === 'grounds' && selectedMunicipality">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-sumi-800" x-text="selectedMunicipality?.name + ' の施設'"></h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="g in getGroundsForMunicipality(selectedMunicipality?.id)" :key="g.id">
                        <div @click="selectGround(g)"
                             class="bg-white border border-sumi-100 rounded p-4 cursor-pointer hover:border-ai-300 transition-colors">
                            <div class="flex justify-between items-start">
                                <h3 class="font-medium text-sumi-800" x-text="g.name"></h3>
                                <span class="px-2 py-0.5 text-xs rounded bg-wakakusa-50 text-wakakusa-700"
                                      x-text="getSlotsForGround(g.id).length + '件'"></span>
                            </div>
                            <p class="text-sm text-sumi-500 mt-1" x-text="g.court_pattern || ''"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- カレンダー表示 -->
            <div x-show="slotView === 'calendar' && selectedGround">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-sumi-800" x-text="selectedGround?.name + ' の空き状況'"></h2>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button @click="prevMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">前月</button>
                    <h3 class="font-medium text-sumi-800" x-text="calendarYear + '年' + (calendarMonth + 1) + '月'"></h3>
                    <button @click="nextMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">翌月</button>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-sumi-100">
                        <template x-for="day in ['日', '月', '火', '水', '木', '金', '土']" :key="day">
                            <div class="py-2 text-center text-xs font-medium" :class="day === '日' ? 'text-sango-500' : day === '土' ? 'text-ai-500' : 'text-sumi-600'" x-text="day"></div>
                        </template>
                    </div>
                    <div class="grid grid-cols-7">
                        <template x-for="(day, idx) in calendarDays" :key="idx">
                            <div
                                class="min-h-[80px] border-b border-r border-sumi-50 p-1 cursor-pointer transition-colors"
                                :class="{
                                    'bg-sumi-50': !day.currentMonth,
                                    'hover:bg-ai-50': day.currentMonth,
                                    'bg-ai-50 border-ai-200': selectedDate === day.dateStr,
                                    'border-l border-sumi-50': idx % 7 === 0
                                }"
                                @click="day.currentMonth && selectDate(day.dateStr)"
                            >
                                <div class="flex justify-between items-start">
                                    <span class="text-sm"
                                        :class="{
                                            'text-sumi-300': !day.currentMonth,
                                            'text-sango-500': day.currentMonth && day.dayOfWeek === 0,
                                            'text-ai-500': day.currentMonth && day.dayOfWeek === 6,
                                            'text-sumi-700': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                        }"
                                        x-text="day.day"
                                    ></span>
                                    <template x-if="day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length > 0">
                                        <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-wakakusa-500 text-white"
                                              x-text="getSlotsForGroundDate(selectedGround?.id, day.dateStr).length"></span>
                                    </template>
                                </div>
                                <div class="mt-1 space-y-0.5 overflow-hidden max-h-[40px]">
                                    <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, day.dateStr).slice(0, 2)" :key="slot.id">
                                        <div class="text-xs px-1 py-0.5 bg-wakakusa-50 text-wakakusa-700 rounded truncate" x-text="slot.time_from + '-' + slot.time_to"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Selected Date Detail -->
                <div x-show="selectedDate" class="mt-6 bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-800 mb-4" x-text="formatDateFull(selectedDate) + ' の空き枠'"></h3>
                    <div x-show="getSlotsForGroundDate(selectedGround?.id, selectedDate).length === 0" class="text-sumi-500 text-center py-4 text-sm">
                        この日の空き枠はありません
                    </div>
                    <div class="space-y-2">
                        <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, selectedDate)" :key="slot.id">
                            <div class="flex items-center justify-between p-3 bg-kinari-100 rounded">
                                <div>
                                    <span class="font-medium text-sumi-800 text-sm" x-text="slot.time_from + ' - ' + slot.time_to"></span>
                                    <span class="ml-2 text-sumi-500 text-sm" x-text="slot.court_name || ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Stats -->
                <div class="mt-4 text-sm text-sumi-500">
                    <span x-text="getSlotsForGround(selectedGround?.id).length"></span>件の空き枠
                </div>
            </div>
        </div>

        <!-- Worker -->
        <div x-show="currentTab === 'worker'" x-cloak>
            <!-- Header with actions -->
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-sumi-800 mb-3">ワーカー管理</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select x-model="selectedMunicipalityForScrape" class="border border-sumi-200 rounded px-3 py-2 text-sm flex-1 bg-white text-sumi-700 focus:outline-none focus:border-ai-400">
                        <option value="">全ての自治体</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                    <div class="flex gap-2">
                        <button @click="triggerScrape()" :disabled="scrapeRunning" class="flex-1 sm:flex-none bg-wakakusa-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-wakakusa-700 disabled:opacity-50 transition-colors">
                            <span x-show="!scrapeRunning">スクレイピング</span>
                            <span x-show="scrapeRunning">実行中...</span>
                        </button>
                        <button @click="loadJobs()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">更新</button>
                    </div>
                </div>
            </div>

            <!-- Job Stats - Compact on mobile -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">実行中</div>
                    <div class="text-xl font-semibold text-sumi-600" x-text="jobs.filter(j => j.status === 'running').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">完了</div>
                    <div class="text-xl font-semibold text-wakakusa-600" x-text="jobs.filter(j => j.status === 'completed').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">失敗</div>
                    <div class="text-xl font-semibold text-sango-500" x-text="jobs.filter(j => j.status === 'failed').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">スロット</div>
                    <div class="text-xl font-semibold text-ai-600" x-text="jobs.reduce((sum, j) => sum + (j.slots_found || 0), 0)"></div>
                </div>
            </div>

            <!-- Recent Jobs - Card layout for mobile -->
            <div class="bg-white border border-sumi-100 rounded mb-4">
                <div class="px-4 py-3 border-b border-sumi-100">
                    <h3 class="font-medium text-sumi-700 text-sm">最近のジョブ</h3>
                </div>

                <!-- Mobile: Card view -->
                <div class="md:hidden divide-y divide-sumi-50">
                    <template x-for="job in jobs" :key="job.id">
                        <div class="p-3" @click="showJobDetails(job)">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm text-sumi-800" x-text="job.municipality_name || job.municipality_id"></span>
                                <span class="px-2 py-0.5 text-xs rounded" :class="{
                                    'bg-wakakusa-50 text-wakakusa-700': job.scrape_status === 'success',
                                    'bg-ai-50 text-ai-700': job.scrape_status === 'success_no_slots',
                                    'bg-sango-50 text-sango-700': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                    'bg-sumi-100 text-sumi-600': job.status === 'running',
                                    'bg-sumi-50 text-sumi-500': !job.scrape_status && job.status !== 'running'
                                }" x-text="job.status === 'running' ? '実行中' : formatScrapeStatus(job.scrape_status)"></span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-sumi-500">
                                <span x-text="job.slots_found ? job.slots_found + '件の空き' : '空きなし'"></span>
                                <span x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at) || '-'"></span>
                            </div>
                            <div x-show="job.error_message" class="mt-1 text-xs text-sango-600 truncate" x-text="job.error_message"></div>
                        </div>
                    </template>
                    <div x-show="jobs.length === 0" class="p-4 text-center text-sumi-500 text-sm">ジョブはありません</div>
                </div>

                <!-- Desktop: Table view -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-sumi-100">
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">自治体</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ステータス</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">結果</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">スロット</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">時刻</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">詳細</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-sumi-50">
                            <template x-for="job in jobs" :key="job.id">
                                <tr class="hover:bg-kinari-50 transition-colors">
                                    <td class="px-4 py-3 text-sm text-sumi-800" x-text="job.municipality_name || job.municipality_id"></td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-0.5 text-xs rounded" :class="{
                                            'bg-sumi-100 text-sumi-600': job.status === 'running',
                                            'bg-wakakusa-50 text-wakakusa-700': job.status === 'completed',
                                            'bg-sango-50 text-sango-700': job.status === 'failed',
                                            'bg-sumi-50 text-sumi-500': job.status === 'pending'
                                        }" x-text="job.status"></span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-0.5 text-xs rounded" :class="{
                                            'bg-wakakusa-50 text-wakakusa-700': job.scrape_status === 'success',
                                            'bg-ai-50 text-ai-700': job.scrape_status === 'success_no_slots',
                                            'bg-sango-50 text-sango-700': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                            'bg-sumi-50 text-sumi-500': !job.scrape_status
                                        }" x-text="formatScrapeStatus(job.scrape_status)"></span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-sumi-700" x-text="job.slots_found || 0"></td>
                                    <td class="px-4 py-3 text-sm text-sumi-500" x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at)"></td>
                                    <td class="px-4 py-3">
                                        <button @click="showJobDetails(job)" class="text-ai-600 hover:text-ai-700 text-sm transition-colors" x-show="job.error_message || job.diagnostics">詳細</button>
                                        <span x-show="!job.error_message && !job.diagnostics" class="text-sumi-300">-</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Logs - Collapsible on mobile -->
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <div class="px-4 py-3 border-b border-sumi-100 flex justify-between items-center cursor-pointer" @click="showLogs = !showLogs">
                    <h3 class="font-medium text-sumi-700 text-sm">ログ</h3>
                    <div class="flex items-center space-x-2">
                        <label class="hidden sm:flex items-center text-sm text-sumi-600" @click.stop>
                            <input type="checkbox" x-model="autoScrollLogs" class="mr-1"> 自動スクロール
                        </label>
                        <button @click.stop="clearLogs()" class="text-sm text-sumi-500 hover:text-sumi-700 transition-colors">クリア</button>
                        <svg class="w-5 h-5 text-sumi-400 md:hidden transition-transform" :class="{'rotate-180': showLogs}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div x-show="showLogs" x-cloak class="md:block h-40 md:h-64 overflow-y-auto bg-sumi-900 text-sumi-100 p-3 font-mono text-xs" id="log-container">
                    <template x-for="(log, idx) in workerLogs" :key="idx">
                        <div :class="{
                            'text-sango-400': log.level === 'error',
                            'text-yellow-400': log.level === 'warn',
                            'text-wakakusa-400': log.level === 'info',
                            'text-sumi-400': log.level === 'debug'
                        }">
                            <span class="text-sumi-500" x-text="log.time"></span>
                            <span class="ml-1" x-text="'[' + log.level.toUpperCase() + ']'"></span>
                            <span class="ml-1" x-text="log.message"></span>
                        </div>
                    </template>
                    <div x-show="workerLogs.length === 0" class="text-sumi-500">ログはありません</div>
                </div>
            </div>
        </div>

        <!-- AI Support -->
        <div x-show="currentTab === 'support'" x-cloak>
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">AI サポート</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat -->
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-700 mb-4">AI チャット</h3>
                    <div class="h-64 overflow-y-auto border border-sumi-100 rounded p-4 mb-4 bg-kinari-50">
                        <template x-for="(msg, i) in chatMessages" :key="i">
                            <div class="mb-2" :class="{'text-right': msg.role === 'user'}">
                                <span class="inline-block px-3 py-2 rounded text-sm" :class="msg.role === 'user' ? 'bg-ai-600 text-white' : 'bg-sumi-100 text-sumi-800'" x-text="msg.content" style="white-space: pre-wrap;"></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" x-model="chatInput" @keydown.enter.prevent="handleChatKeydown($event)" @compositionstart="isComposing = true" @compositionend="isComposing = false" placeholder="質問を入力... (Shift+Enterで送信)" class="flex-1 border border-sumi-200 rounded px-4 py-2 text-sm focus:outline-none focus:border-ai-400">
                        <button @click="sendChat()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">送信</button>
                    </div>
                </div>
                <!-- Tickets -->
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-700 mb-4">サポートチケット</h3>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        <template x-for="ticket in tickets" :key="ticket.id">
                            <div class="border border-sumi-100 rounded p-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-sumi-800 text-sm" x-text="ticket.subject"></span>
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-sango-50 text-sango-700': ticket.status === 'open',
                                        'bg-sumi-100 text-sumi-600': ticket.status === 'escalated',
                                        'bg-wakakusa-50 text-wakakusa-700': ticket.status === 'resolved'
                                    }" x-text="ticket.status"></span>
                                </div>
                                <div class="text-sm text-sumi-500 mt-1" x-text="ticket.email"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Team Modal -->
    <div x-show="showTeamModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded p-6 w-full max-w-md" @click.away="showTeamModal = false">
            <h3 class="font-semibold text-sumi-800 mb-4">新規チーム追加</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">チーム名</label>
                    <input type="text" x-model="newTeam.name" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">メールアドレス</label>
                    <input type="email" x-model="newTeam.email" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">プラン</label>
                    <select x-model="newTeam.plan" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400 bg-white">
                        <option value="free">Free</option>
                        <option value="personal">Personal</option>
                        <option value="pro">Pro</option>
                        <option value="org">Org</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showTeamModal = false" class="px-4 py-2 border border-sumi-200 rounded text-sm text-sumi-600 hover:bg-kinari-100 transition-colors">キャンセル</button>
                <button @click="createTeam()" class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">追加</button>
            </div>
        </div>
    </div>

    <!-- Facility Modal -->
    <div x-show="showFacilityModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded p-6 w-full max-w-md" @click.away="showFacilityModal = false">
            <h3 class="font-semibold text-sumi-800 mb-4">新規施設追加</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">施設名</label>
                    <input type="text" x-model="newFacility.name" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">自治体</label>
                    <input type="text" x-model="newFacility.municipality" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">スクレイパータイプ</label>
                    <input type="text" x-model="newFacility.scraper_type" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">URL</label>
                    <input type="url" x-model="newFacility.url" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showFacilityModal = false" class="px-4 py-2 border border-sumi-200 rounded text-sm text-sumi-600 hover:bg-kinari-100 transition-colors">キャンセル</button>
                <button @click="createFacility()" class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">追加</button>
            </div>
        </div>
    </div>

    <script>
    const NAV_TABS = [
        { id: 'dashboard', label: 'ダッシュボード' },
        { id: 'teams', label: 'チーム' },
        { id: 'facilities', label: '施設' },
        { id: 'slots', label: '空き状況' },
        { id: 'worker', label: 'ワーカー' },
        { id: 'support', label: 'AI' }
    ];

    const SCRAPE_STATUS_MAP = {
        'success': '空きあり',
        'success_no_slots': '空きなし',
        'parse_error': '解析エラー',
        'network_error': '通信エラー',
        'no_table_found': 'テーブルなし',
        'unknown_facility': '不明な施設',
        'scraper_unavailable': 'スクレイパー利用不可',
        'execution_error': '実行エラー'
    };

    const DAY_NAMES = ['日', '月', '火', '水', '木', '金', '土'];

    function app() {
        return {
            navTabs: NAV_TABS,
            currentTab: 'dashboard',
            mobileMenuOpen: false,
            dashboard: { TeamCount: 0, FacilityCount: 0, WatchConditionCount: 0, NotificationCount: 0, OpenTicketCount: 0, TeamsByPlan: [] },
            teams: [],
            facilities: [],
            grounds: [],
            slots: [],
            municipalities: [],
            slotView: 'municipalities',
            selectedMunicipality: null,
            selectedGround: null,
            slotFilter: { municipalityId: '' },
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            selectedDate: null,
            showLogs: window.innerWidth >= 768,
            jobs: [],
            workerLogs: [],
            scrapeRunning: false,
            selectedMunicipalityForScrape: '',
            autoScrollLogs: true,
            tickets: [],
            chatMessages: [],
            chatInput: '',
            isComposing: false,
            showTeamModal: false,
            showFacilityModal: false,
            newTeam: { name: '', email: '', plan: 'free' },
            newFacility: { name: '', municipality: '', scraper_type: '', url: '' },

            async init() {
                await this.loadDashboard();
                await this.loadTeams();
                await this.loadFacilities();
                await this.loadMunicipalities();
                await this.loadGrounds();
                await this.loadSlots();
                await this.loadJobs();
                await this.loadTickets();
            },

            async loadDashboard() {
                const res = await fetch('/admin/api/dashboard');
                this.dashboard = await res.json();
            },

            async loadTeams() {
                const res = await fetch('/admin/api/teams');
                this.teams = await res.json() || [];
            },

            async loadFacilities() {
                const res = await fetch('/admin/api/grounds');
                const grounds = await res.json();
                // Map grounds to facilities format
                this.facilities = (grounds || []).map(g => ({
                    id: g.id,
                    name: g.name,
                    municipality: g.municipality_name,
                    scraper_type: g.court_pattern,
                    enabled: g.enabled
                }));
            },

            async loadMunicipalities() {
                const res = await fetch('/admin/api/municipalities');
                this.municipalities = await res.json() || [];
            },

            async loadGrounds() {
                const res = await fetch('/admin/api/grounds');
                this.grounds = await res.json() || [];
            },

            async loadSlots() {
                // Load all slots (increased limit needed in API)
                const res = await fetch('/admin/api/slots?limit=5000');
                this.slots = await res.json() || [];
            },

            // Calendar methods
            get calendarDays() {
                const days = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay();

                const prevMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const d = prevMonth.getDate() - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: true, dayOfWeek: date.getDay() });
                }

                const remaining = 42 - days.length;
                for (let d = 1; d <= remaining; d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }
                return days;
            },

            toDateStr(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            },

            changeMonth(delta) {
                const d = new Date(this.calendarYear, this.calendarMonth + delta, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            prevMonth() { this.changeMonth(-1); },
            nextMonth() { this.changeMonth(1); },

            selectDate(dateStr) {
                this.selectedDate = this.selectedDate === dateStr ? null : dateStr;
            },

            getSlotsForDate(dateStr) {
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            // Drilldown methods
            getGroundsForMunicipality(municipalityId) {
                return this.grounds.filter(g => g.municipality_id === municipalityId);
            },

            getSlotsForMunicipality(municipalityId) {
                return this.slots.filter(s => s.municipality_id === municipalityId);
            },

            getSlotsForGround(groundId) {
                if (!groundId) return [];
                return this.slots.filter(s => s.ground_id === groundId);
            },

            getSlotsForGroundDate(groundId, dateStr) {
                if (!groundId) return [];
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return s.ground_id === groundId && slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            selectMunicipality(m) {
                this.selectedMunicipality = m;
                this.selectedGround = null;
                this.slotView = 'grounds';
            },

            selectGround(g) {
                this.selectedGround = g;
                this.selectedDate = null;
                this.slotView = 'calendar';
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}(${DAY_NAMES[d.getDay()]})`;
            },

            formatDateFull(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日(${DAY_NAMES[d.getDay()]})`;
            },

            formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            },

            formatScrapeStatus(status) {
                return SCRAPE_STATUS_MAP[status] || status || '-';
            },

            showJobDetails(job) {
                let details = '';
                if (job.error_message) {
                    details += `エラー: ${job.error_message}\n\n`;
                }
                if (job.diagnostics) {
                    try {
                        const diag = JSON.parse(job.diagnostics);
                        details += '診断情報:\n';
                        if (diag.note) details += `  メモ: ${diag.note}\n`;
                        if (diag.html_verification) {
                            const v = diag.html_verification;
                            if (v.server_message) details += `  サーバー回答: ${v.server_message}\n`;
                            if (v.confirmation) details += `  確認: ${v.confirmation}\n`;
                        }
                        if (diag.raw_results_count !== undefined) details += `  生結果数: ${diag.raw_results_count}\n`;
                        if (diag.parsed_slots_count !== undefined) details += `  解析済み: ${diag.parsed_slots_count}\n`;
                        if (diag.parse_errors) details += `  解析エラー: ${diag.parse_errors}\n`;
                    } catch (e) {
                        details += `診断情報: ${job.diagnostics}`;
                    }
                }
                if (details) {
                    alert(details);
                }
            },

            // Worker methods
            async loadJobs() {
                const res = await fetch('/admin/api/jobs');
                const data = await res.json();
                this.jobs = data || [];
            },

            async triggerScrape() {
                this.scrapeRunning = true;
                this.addLog('info', 'スクレイピングを開始します...');
                try {
                    const url = this.selectedMunicipalityForScrape
                        ? `/api/scrape?municipality_id=${this.selectedMunicipalityForScrape}`
                        : '/api/scrape';
                    const res = await fetch(url, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        this.addLog('info', `スクレイピング完了: ${data.message}`);
                    } else {
                        this.addLog('error', `エラー: ${data.error}`);
                    }
                } catch (e) {
                    this.addLog('error', `リクエスト失敗: ${e.message}`);
                } finally {
                    this.scrapeRunning = false;
                    await this.loadJobs();
                    await this.loadSlots();
                }
            },

            addLog(level, message) {
                const now = new Date();
                const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                this.workerLogs.push({ level, message, time });
                if (this.workerLogs.length > 500) this.workerLogs.shift();
                if (this.autoScrollLogs) {
                    this.$nextTick(() => {
                        const container = document.getElementById('log-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                }
            },

            clearLogs() {
                this.workerLogs = [];
            },

            async loadTickets() {
                const res = await fetch('/admin/api/tickets');
                this.tickets = await res.json();
            },

            async createTeam() {
                await fetch('/admin/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newTeam)
                });
                this.showTeamModal = false;
                this.newTeam = { name: '', email: '', plan: 'free' };
                await this.loadTeams();
                await this.loadDashboard();
            },

            async createFacility() {
                await fetch('/admin/api/facilities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newFacility)
                });
                this.showFacilityModal = false;
                this.newFacility = { name: '', municipality: '', scraper_type: '', url: '' };
                await this.loadFacilities();
                await this.loadDashboard();
            },

            handleChatKeydown(event) {
                // IME変換中は送信しない
                if (this.isComposing) return;
                // Shift+Enterで送信
                if (event.shiftKey) {
                    this.sendChat();
                }
            },

            async sendChat() {
                if (!this.chatInput.trim()) return;
                const msg = this.chatInput;
                this.chatMessages.push({ role: 'user', content: msg });
                this.chatInput = '';
                const res = await fetch('/admin/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                this.chatMessages.push({ role: 'ai', content: data.response });
            }
        }
    }
    </script>
</body>
</html>
