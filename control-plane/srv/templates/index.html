<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - ÁÆ°ÁêÜÁîªÈù¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sumi: {
                            50: '#F5F5F5',
                            100: '#E8E8E8',
                            200: '#D1D1D1',
                            300: '#B0B0B0',
                            400: '#888888',
                            500: '#6B6B6B',
                            600: '#5A5A5A',
                            700: '#454545',
                            800: '#2C2C2C',
                            900: '#1A1A1A'
                        },
                        kinari: {
                            50: '#FEFDFB',
                            100: '#FAF8F5',
                            200: '#F5F2ED'
                        },
                        ai: {
                            50: '#E8F4F8',
                            100: '#D1E9F1',
                            200: '#A3D3E3',
                            300: '#75BDD5',
                            400: '#4BA7C7',
                            500: '#3D8EAF',
                            600: '#1E4D6B',
                            700: '#1A4259',
                            800: '#153647',
                            900: '#0F2C3D'
                        },
                        wakakusa: {
                            50: '#F0F5F0',
                            100: '#E1EBE1',
                            200: '#C3D7C3',
                            300: '#A5C3A5',
                            400: '#7DAF7D',
                            500: '#5A8F5A',
                            600: '#4A7A4A',
                            700: '#3D643D',
                            800: '#2F4D2F',
                            900: '#223722'
                        },
                        sango: {
                            50: '#FDF5F5',
                            100: '#FBEBEB',
                            200: '#F5D1D1',
                            300: '#EFB7B7',
                            400: '#E38989',
                            500: '#C96161',
                            600: '#B54545',
                            700: '#963838',
                            800: '#772C2C',
                            900: '#582121'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', '"Hiragino Sans"', '"Hiragino Kaku Gothic ProN"', 'Meiryo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }

        /* ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #D1D1D1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #B0B0B0;
        }

        /* „É≠„Ç∞„Ç≥„É≥„ÉÜ„ÉäÂ∞ÇÁî®„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        #log-container::-webkit-scrollbar-thumb {
            background: #454545;
        }
        #log-container::-webkit-scrollbar-thumb:hover {
            background: #5A5A5A;
        }
    </style>
</head>
<body class="bg-kinari-100 min-h-screen font-sans" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-sumi-800 text-kinari-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <!-- Mobile Header -->
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-xl font-semibold tracking-tight">AkiGura</h1>
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden p-2 hover:bg-sumi-700 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
                        <path x-show="mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <!-- Desktop Nav -->
                <nav class="hidden md:flex items-center space-x-1">
                    <template x-for="tab in navTabs" :key="tab.id">
                        <button @click="currentTab = tab.id"
                                :class="currentTab === tab.id ? 'text-kinari-50 border-b-2 border-kinari-50' : 'text-sumi-300 hover:text-kinari-50'"
                                class="px-3 py-2 text-sm font-medium transition-colors"
                                x-text="tab.label"></button>
                    </template>
                </nav>
            </div>
            <!-- Mobile Nav -->
            <nav x-show="mobileMenuOpen" x-cloak class="md:hidden mt-3 pb-2 grid grid-cols-3 gap-2">
                <template x-for="tab in navTabs" :key="tab.id">
                    <button @click="currentTab = tab.id; mobileMenuOpen = false"
                            :class="currentTab === tab.id ? 'bg-sumi-700 text-kinari-50' : 'text-sumi-300 hover:bg-sumi-700'"
                            class="px-2 py-2 rounded text-sm text-center transition-colors"
                            x-text="tab.label"></button>
                </template>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">ÁôªÈå≤„ÉÅ„Éº„É†Êï∞</div>
                    <div class="text-2xl font-semibold text-ai-600" x-text="dashboard.TeamCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">ÂØæÂøúÊñΩË®≠Êï∞</div>
                    <div class="text-2xl font-semibold text-wakakusa-600" x-text="dashboard.FacilityCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">Áõ£Ë¶ñÊù°‰ª∂Êï∞</div>
                    <div class="text-2xl font-semibold text-ai-500" x-text="dashboard.WatchConditionCount">0</div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <div class="text-sumi-500 text-xs mb-1">Êú™ÂØæÂøú„ÉÅ„Ç±„ÉÉ„Éà</div>
                    <div class="text-2xl font-semibold text-sango-500" x-text="dashboard.OpenTicketCount">0</div>
                </div>
            </div>
            <!-- Plan Distribution -->
            <div class="bg-white border border-sumi-100 rounded p-6 mb-8">
                <h3 class="text-sm font-medium text-sumi-700 mb-4">„Éó„É©„É≥Âà•„ÉÅ„Éº„É†Êï∞</h3>
                <div class="flex flex-wrap gap-3">
                    <template x-for="plan in dashboard.TeamsByPlan" :key="plan.plan">
                        <div class="flex-1 min-w-[100px] bg-kinari-100 rounded p-4 text-center">
                            <div class="text-xs text-sumi-500 mb-1" x-text="plan.plan"></div>
                            <div class="text-xl font-semibold text-sumi-800" x-text="plan.count"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Teams -->
        <div x-show="currentTab === 'teams'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-sumi-800">„ÉÅ„Éº„É†ÁÆ°ÁêÜ</h2>
                <button @click="showTeamModal = true" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</button>
            </div>
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-sumi-100">
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„ÉÅ„Éº„É†Âêç</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„É°„Éº„É´</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Éó„É©„É≥</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-sumi-50">
                        <template x-for="team in teams" :key="team.id">
                            <tr class="hover:bg-kinari-50 transition-colors">
                                <td class="px-5 py-4 text-sm text-sumi-800" x-text="team.name"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="team.email"></td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded border" :class="{
                                        'border-sumi-200 text-sumi-600': team.plan === 'free',
                                        'border-ai-200 text-ai-600': team.plan === 'personal',
                                        'border-ai-300 text-ai-700': team.plan === 'pro',
                                        'border-wakakusa-200 text-wakakusa-600': team.plan === 'org'
                                    }" x-text="team.plan"></span>
                                </td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-wakakusa-50 text-wakakusa-700': team.status === 'active',
                                        'bg-sango-50 text-sango-700': team.status !== 'active'
                                    }" x-text="team.status"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Facilities -->
        <div x-show="currentTab === 'facilities'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-sumi-800">ÊñΩË®≠ÁÆ°ÁêÜ</h2>
                <button @click="showFacilityModal = true" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</button>
            </div>
            <!-- Filter Controls -->
            <div class="bg-white border border-sumi-100 rounded p-4 mb-4">
                <div class="flex flex-wrap gap-4 items-end">
                    <!-- Search -->
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs font-medium text-sumi-500 mb-1">Ê§úÁ¥¢</label>
                        <input type="text" x-model="facilityFilter.search" placeholder="ÊñΩË®≠Âêç„ÉªËá™Ê≤ª‰Ωì„ÅßÊ§úÁ¥¢..."
                               class="w-full px-3 py-2 border border-sumi-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-ai-500 focus:border-ai-500">
                    </div>
                    <!-- Municipality Filter -->
                    <div class="min-w-[180px]">
                        <label class="block text-xs font-medium text-sumi-500 mb-1">Ëá™Ê≤ª‰Ωì</label>
                        <select x-model="facilityFilter.municipality"
                                class="w-full px-3 py-2 border border-sumi-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-ai-500 focus:border-ai-500">
                            <option value="">„Åô„Åπ„Å¶</option>
                            <template x-for="m in uniqueFacilityMunicipalities" :key="m">
                                <option :value="m" x-text="m"></option>
                            </template>
                        </select>
                    </div>
                    <!-- Status Filter -->
                    <div class="min-w-[140px]">
                        <label class="block text-xs font-medium text-sumi-500 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select x-model="facilityFilter.status"
                                class="w-full px-3 py-2 border border-sumi-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-ai-500 focus:border-ai-500">
                            <option value="">„Åô„Åπ„Å¶</option>
                            <option value="enabled">ÊúâÂäπ</option>
                            <option value="disabled">ÁÑ°Âäπ</option>
                        </select>
                    </div>
                    <!-- Clear Filters -->
                    <button @click="clearFacilityFilters()" 
                            x-show="facilityFilter.search || facilityFilter.municipality || facilityFilter.status"
                            class="px-3 py-2 text-sm text-sumi-600 hover:text-sumi-800 hover:bg-sumi-100 rounded transition-colors">
                        „ÇØ„É™„Ç¢
                    </button>
                </div>
                <!-- Result Count -->
                <div class="mt-3 text-sm text-sumi-500">
                    <span x-text="filteredFacilities.length"></span>‰ª∂
                    <span x-show="filteredFacilities.length !== facilities.length">
                        (ÂÖ®<span x-text="facilities.length"></span>‰ª∂‰∏≠)
                    </span>
                </div>
            </div>
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-sumi-100">
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ÊñΩË®≠Âêç</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">Ëá™Ê≤ª‰Ωì</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Çπ„ÇØ„É¨„Ç§„Éë„Éº</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-sumi-50">
                        <template x-for="f in filteredFacilities" :key="f.id">
                            <tr class="hover:bg-kinari-50 transition-colors">
                                <td class="px-5 py-4 text-sm text-sumi-800" x-text="f.name"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="f.municipality"></td>
                                <td class="px-5 py-4 text-sm text-sumi-600" x-text="f.scraper_type"></td>
                                <td class="px-5 py-4">
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-wakakusa-50 text-wakakusa-700': f.enabled,
                                        'bg-sango-50 text-sango-700': !f.enabled
                                    }" x-text="f.enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Slots (Á©∫„ÅçÁä∂Ê≥Å) - Calendar View -->
        <div x-show="currentTab === 'slots'" x-cloak>
            <!-- View Toggle Tabs -->
            <div class="flex items-center gap-1 mb-4 border-b border-sumi-200">
                <button @click="slotView = 'all-calendar'; selectedMunicipality = null; selectedGround = null"
                        class="px-4 py-2 text-sm font-medium transition-colors border-b-2 -mb-px"
                        :class="slotView === 'all-calendar' ? 'text-ai-600 border-ai-600' : 'text-sumi-500 border-transparent hover:text-sumi-700'">üìÖ ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº</button>
                <button @click="slotView = 'trends'; selectedMunicipality = null; selectedGround = null"
                        class="px-4 py-2 text-sm font-medium transition-colors border-b-2 -mb-px"
                        :class="slotView === 'trends' ? 'text-ai-600 border-ai-600' : 'text-sumi-500 border-transparent hover:text-sumi-700'">üìä Áãô„ÅÑÁõÆÂàÜÊûê</button>
                <button @click="slotView = 'municipalities'; selectedMunicipality = null; selectedGround = null"
                        class="px-4 py-2 text-sm font-medium transition-colors border-b-2 -mb-px"
                        :class="slotView === 'municipalities' || slotView === 'grounds' || slotView === 'calendar' ? 'text-ai-600 border-ai-600' : 'text-sumi-500 border-transparent hover:text-sumi-700'">üè¢ Ëá™Ê≤ª‰ΩìÂà•</button>
            </div>

            <!-- Breadcrumb (Ëá™Ê≤ª‰ΩìÂà•„Éì„É•„ÉºÁî®) -->
            <div x-show="slotView === 'municipalities' || slotView === 'grounds' || slotView === 'calendar'" class="flex items-center gap-2 mb-4 text-sm">
                <button @click="slotView = 'municipalities'; selectedMunicipality = null; selectedGround = null"
                        class="hover:text-ai-600 transition-colors" :class="slotView === 'municipalities' ? 'text-sumi-800 font-medium' : 'text-sumi-500'">Ëá™Ê≤ª‰Ωì‰∏ÄË¶ß</button>
                <template x-if="selectedMunicipality">
                    <span class="flex items-center gap-2">
                        <span class="text-sumi-300">/</span>
                        <button @click="slotView = 'grounds'; selectedGround = null"
                                class="hover:text-ai-600 transition-colors" :class="slotView === 'grounds' ? 'text-sumi-800 font-medium' : 'text-sumi-500'" x-text="selectedMunicipality?.name"></button>
                    </span>
                </template>
                <template x-if="selectedGround">
                    <span class="flex items-center gap-2">
                        <span class="text-sumi-300">/</span>
                        <span class="text-sumi-800 font-medium" x-text="selectedGround?.name"></span>
                    </span>
                </template>
            </div>

            <!-- ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„Éº -->
            <div x-show="slotView === 'all-calendar'">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-sumi-800">ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº</h2>
                    <button @click="loadSlots(); loadGrounds()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êõ¥Êñ∞</button>
                </div>

                <!-- „Çµ„Éû„É™„Éº -->
                <div class="bg-white border border-sumi-100 rounded p-4 mb-4">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-6">
                            <div>
                                <span class="text-sumi-500 text-xs">Á∑èÁ©∫„ÅçÊû†Êï∞</span>
                                <div class="text-2xl font-semibold text-wakakusa-600" x-text="slots.length"></div>
                            </div>
                            <div>
                                <span class="text-sumi-500 text-xs">Á©∫„Åç„ÅÆ„ÅÇ„ÇãËá™Ê≤ª‰Ωì</span>
                                <div class="text-2xl font-semibold text-ai-600" x-text="getGroundsWithSlots().length + '/' + municipalities.length"></div>
                            </div>
                            <div>
                                <span class="text-sumi-500 text-xs">Á©∫„Åç„ÅÆ„ÅÇ„ÇãÊó•Êï∞</span>
                                <div class="text-2xl font-semibold text-wakakusa-500" x-text="getUniqueDatesAll()"></div>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center text-xs">
                            <span class="text-sumi-500">Âá°‰æã:</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-50 text-wakakusa-700">1-2Ëá™Ê≤ª‰Ωì</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-100 text-wakakusa-700">3-5Ëá™Ê≤ª‰Ωì</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-200 text-wakakusa-800">6Ëá™Ê≤ª‰Ωì‰ª•‰∏ä</span>
                        </div>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button @click="prevMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">ÂâçÊúà</button>
                    <h3 class="font-medium text-sumi-800" x-text="calendarYear + 'Âπ¥' + (calendarMonth + 1) + 'Êúà'"></h3>
                    <button @click="nextMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">ÁøåÊúà</button>
                </div>

                <!-- All-Facilities Calendar Grid -->
                <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-sumi-100">
                        <template x-for="day in ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']" :key="day">
                            <div class="py-2 text-center text-xs font-medium" :class="day === 'Êó•' ? 'text-sango-500' : day === 'Âúü' ? 'text-ai-500' : 'text-sumi-600'" x-text="day"></div>
                        </template>
                    </div>
                    <div class="grid grid-cols-7">
                        <template x-for="(day, idx) in calendarDays" :key="idx">
                            <div
                                class="min-h-[90px] border-b border-r border-sumi-50 p-1 cursor-pointer transition-colors relative"
                                :class="{
                                    'bg-sumi-50': !day.currentMonth,
                                    'bg-wakakusa-200': day.currentMonth && getGroundsWithSlotsForDate(day.dateStr).length >= 6,
                                    'bg-wakakusa-100': day.currentMonth && getGroundsWithSlotsForDate(day.dateStr).length >= 3 && getGroundsWithSlotsForDate(day.dateStr).length < 6,
                                    'bg-wakakusa-50': day.currentMonth && getGroundsWithSlotsForDate(day.dateStr).length > 0 && getGroundsWithSlotsForDate(day.dateStr).length < 3,
                                    'bg-white hover:bg-ai-50': day.currentMonth && getGroundsWithSlotsForDate(day.dateStr).length === 0,
                                    'ring-2 ring-ai-400 ring-inset': allCalendarSelectedDate === day.dateStr,
                                    'border-l border-sumi-50': idx % 7 === 0
                                }"
                                @click="day.currentMonth && selectAllCalendarDate(day.dateStr)"
                            >
                                <div class="flex justify-between items-start">
                                    <span class="text-sm font-medium"
                                        :class="{
                                            'text-sumi-300': !day.currentMonth,
                                            'text-sango-600': day.currentMonth && day.dayOfWeek === 0,
                                            'text-ai-600': day.currentMonth && day.dayOfWeek === 6,
                                            'text-sumi-800': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                        }"
                                        x-text="day.day"
                                    ></span>
                                    <template x-if="day.currentMonth && getSlotsForDate(day.dateStr).length > 0">
                                        <span class="px-1.5 py-0.5 text-xs font-bold rounded bg-wakakusa-500 text-white"
                                              x-text="getSlotsForDate(day.dateStr).length + 'Êû†'"></span>
                                    </template>
                                </div>
                                <!-- Ëá™Ê≤ª‰ΩìÊï∞Ë°®Á§∫ -->
                                <template x-if="day.currentMonth && getGroundsWithSlotsForDate(day.dateStr).length > 0">
                                    <div class="mt-1 text-xs text-wakakusa-700 font-medium" x-text="getGroundsWithSlotsForDate(day.dateStr).length + 'Ëá™Ê≤ª‰Ωì'"></div>
                                </template>
                                <!-- Ëá™Ê≤ª‰ΩìÂêç„Éó„É¨„Éì„É•„Éº (ÊúÄÂ§ß3„Å§) -->
                                <div class="mt-1 space-y-0.5 overflow-hidden max-h-[36px]">
                                    <template x-for="municipality in getGroundsWithSlotsForDate(day.dateStr).slice(0, 3)" :key="municipality.id">
                                        <div class="text-xs px-1 py-0.5 bg-wakakusa-500/20 text-wakakusa-800 rounded truncate" x-text="municipality.name"></div>
                                    </template>
                                </div>
                                <!-- Á©∫„ÅçÊû†„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Éê„Éº -->
                                <div x-show="day.currentMonth && getSlotsForDate(day.dateStr).length > 0" class="absolute bottom-0 left-0 right-0 h-1 bg-wakakusa-300">
                                    <div class="h-full bg-wakakusa-600" :style="'width: ' + Math.min(100, getSlotsForDate(day.dateStr).length * 2) + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Selected Date Detail (ÂÖ®ÊñΩË®≠) -->
                <div x-show="allCalendarSelectedDate" class="mt-6 bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-800 mb-4" x-text="formatDateFull(allCalendarSelectedDate) + ' „ÅÆÁ©∫„ÅçÁä∂Ê≥Å'"></h3>
                    <div x-show="getSlotsForDate(allCalendarSelectedDate).length === 0" class="text-sumi-500 text-center py-4 text-sm">
                        „Åì„ÅÆÊó•„ÅÆÁ©∫„ÅçÊû†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                    <!-- Ëá™Ê≤ª‰ΩìÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶Ë°®Á§∫ -->
                    <div class="space-y-4">
                        <template x-for="municipality in getGroundsWithSlotsForDate(allCalendarSelectedDate)" :key="municipality.id">
                            <div class="border border-sumi-100 rounded p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-sumi-800 text-sm" x-text="municipality.name"></h4>
                                    <span class="px-2 py-0.5 text-xs rounded bg-wakakusa-100 text-wakakusa-700"
                                          x-text="getSlotsForMunicipalityDate(municipality.id, allCalendarSelectedDate).length + 'Êû†'"></span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="slot in getSlotsForMunicipalityDate(municipality.id, allCalendarSelectedDate)" :key="slot.id">
                                        <span class="px-2 py-1 bg-wakakusa-50 text-wakakusa-800 text-xs rounded"
                                              x-text="slot.time_from + '-' + slot.time_to + (slot.court_name ? ' (' + slot.court_name + ')' : '')"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Áãô„ÅÑÁõÆÂàÜÊûê„Éì„É•„Éº -->
            <div x-show="slotView === 'trends'">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-sumi-800">Áãô„ÅÑÁõÆÂàÜÊûê</h2>
                    <button @click="loadSlots()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êõ¥Êñ∞</button>
                </div>

                <!-- ÂàÜÊûê„Çµ„Éû„É™„Éº -->
                <div class="bg-gradient-to-r from-ai-50 to-wakakusa-50 border border-ai-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">üéØ</span>
                        <h3 class="font-semibold text-sumi-800">ÊäΩÈÅ∏„ÅÆÁãô„ÅÑÁõÆ</h3>
                    </div>
                    <p class="text-sm text-sumi-600">ÈÅéÂéª„ÅÆÁ©∫„ÅçÁä∂Ê≥Å„Éá„Éº„Çø„Åã„Çâ„ÄÅÁ©∫„Åç„ÅåÂá∫„ÇÑ„Åô„ÅÑÊõúÊó•„ÉªÊôÇÈñìÂ∏Ø„ÉªËá™Ê≤ª‰Ωì„ÇíÂàÜÊûê„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ÊõúÊó•Âà•Á©∫„ÅçÁä∂Ê≥Å -->
                    <div class="bg-white border border-sumi-100 rounded-lg p-5">
                        <h3 class="font-semibold text-sumi-800 mb-4 flex items-center gap-2">
                            <span>üìÜ</span> ÊõúÊó•Âà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
                        </h3>
                        <div class="space-y-3">
                            <template x-for="(day, idx) in getSlotsByDayOfWeek()" :key="idx">
                                <div class="flex items-center gap-3">
                                    <span class="w-8 text-sm font-medium" :class="{
                                        'text-sango-600': idx === 0,
                                        'text-ai-600': idx === 6,
                                        'text-sumi-700': idx > 0 && idx < 6
                                    }" x-text="['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][idx]"></span>
                                    <div class="flex-1 bg-sumi-100 rounded-full h-6 relative overflow-hidden">
                                        <div class="h-full rounded-full transition-all"
                                             :class="day.count > 0 ? 'bg-wakakusa-500' : 'bg-sumi-200'"
                                             :style="'width: ' + (day.percentage || 0) + '%'"></div>
                                        <span class="absolute inset-0 flex items-center justify-center text-xs font-medium"
                                              :class="day.percentage > 50 ? 'text-white' : 'text-sumi-700'"
                                              x-text="day.count + 'Êû†'"></span>
                                    </div>
                                    <span x-show="day.isHot" class="text-xs px-2 py-0.5 bg-sango-100 text-sango-700 rounded font-medium">Áãô„ÅÑÁõÆÔºÅ</span>
                                </div>
                            </template>
                        </div>
                        <p class="mt-4 text-xs text-sumi-500">‚Äª ÈªíÈà¥„ÅåÁ©∫„Åç„Å´„Å™„Çä„ÇÑ„Åô„ÅÑÊõúÊó•„Åå„ÄåÁãô„ÅÑÁõÆ„Äç„Åß„Åô</p>
                    </div>

                    <!-- ÊôÇÈñìÂ∏ØÂà•Á©∫„ÅçÁä∂Ê≥Å -->
                    <div class="bg-white border border-sumi-100 rounded-lg p-5">
                        <h3 class="font-semibold text-sumi-800 mb-4 flex items-center gap-2">
                            <span>‚è∞</span> ÊôÇÈñìÂ∏ØÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
                        </h3>
                        <div class="space-y-2">
                            <template x-for="slot in getSlotsByTimeRange()" :key="slot.range">
                                <div class="flex items-center gap-3">
                                    <span class="w-24 text-sm text-sumi-600" x-text="slot.range"></span>
                                    <div class="flex-1 bg-sumi-100 rounded-full h-5 relative overflow-hidden">
                                        <div class="h-full bg-ai-500 rounded-full transition-all"
                                             :style="'width: ' + (slot.percentage || 0) + '%'"></div>
                                        <span class="absolute inset-0 flex items-center justify-center text-xs font-medium"
                                              :class="slot.percentage > 50 ? 'text-white' : 'text-sumi-700'"
                                              x-text="slot.count + 'Êû†'"></span>
                                    </div>
                                    <span x-show="slot.isHot" class="text-xs px-2 py-0.5 bg-sango-100 text-sango-700 rounded font-medium">Áãô„ÅÑÁõÆÔºÅ</span>
                                </div>
                            </template>
                        </div>
                        <p class="mt-4 text-xs text-sumi-500">‚Äª Á´∂‰∫â„ÅåÂ∞ë„Å™„ÅèÁ©∫„Åç„ÅåÂá∫„ÇÑ„Åô„ÅÑÊôÇÈñìÂ∏Ø„Åå„ÄåÁãô„ÅÑÁõÆ„Äç„Åß„Åô</p>
                    </div>

                    <!-- Ëá™Ê≤ª‰ΩìÂà•Á©∫„ÅçÁä∂Ê≥Å -->
                    <div class="bg-white border border-sumi-100 rounded-lg p-5">
                        <h3 class="font-semibold text-sumi-800 mb-4 flex items-center gap-2">
                            <span>üè¢</span> Ëá™Ê≤ª‰ΩìÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
                        </h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            <template x-for="muni in getSlotsByMunicipality()" :key="muni.id">
                                <div class="flex items-center gap-3">
                                    <span class="w-20 text-sm text-sumi-700 truncate" x-text="muni.name"></span>
                                    <div class="flex-1 bg-sumi-100 rounded-full h-5 relative overflow-hidden">
                                        <div class="h-full bg-wakakusa-500 rounded-full transition-all"
                                             :style="'width: ' + (muni.percentage || 0) + '%'"></div>
                                        <span class="absolute inset-0 flex items-center justify-center text-xs font-medium"
                                              :class="muni.percentage > 50 ? 'text-white' : 'text-sumi-700'"
                                              x-text="muni.count + 'Êû†'"></span>
                                    </div>
                                    <span x-show="muni.isHot" class="text-xs px-2 py-0.5 bg-sango-100 text-sango-700 rounded font-medium">Áãô„ÅÑÁõÆÔºÅ</span>
                                </div>
                            </template>
                        </div>
                        <p class="mt-4 text-xs text-sumi-500">‚Äª Á©∫„ÅçÊû†„ÅåÂ§ö„ÅÑËá™Ê≤ª‰Ωì„Åå„ÄåÁãô„ÅÑÁõÆ„Äç„Åß„Åô</p>
                    </div>

                    <!-- „Ç≥„Éº„ÉàÂà•Á©∫„ÅçÁä∂Ê≥Å -->
                    <div class="bg-white border border-sumi-100 rounded-lg p-5">
                        <h3 class="font-semibold text-sumi-800 mb-4 flex items-center gap-2">
                            <span>‚öæ</span> „Ç≥„Éº„ÉàÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å TOP10
                        </h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            <template x-for="(court, idx) in getSlotsByCourt().slice(0, 10)" :key="court.name">
                                <div class="flex items-center gap-3">
                                    <span class="w-6 text-sm font-medium text-sumi-400" x-text="idx + 1"></span>
                                    <span class="flex-1 text-sm text-sumi-700 truncate" x-text="court.name"></span>
                                    <span class="text-sm font-medium" :class="court.count > 20 ? 'text-wakakusa-600' : 'text-sumi-600'" x-text="court.count + 'Êû†'"></span>
                                </div>
                            </template>
                        </div>
                        <p class="mt-4 text-xs text-sumi-500">‚Äª Á©∫„Åç„ÅÆÂá∫„ÇÑ„Åô„ÅÑ„Ç≥„Éº„Éà„É©„É≥„Ç≠„É≥„Ç∞„Åß„Åô</p>
                    </div>
                </div>

                <!-- ÊõúÊó•√óÊôÇÈñìÂ∏Ø„Éí„Éº„Éà„Éû„ÉÉ„Éó -->
                <div class="bg-white border border-sumi-100 rounded-lg p-5 mt-6">
                    <h3 class="font-semibold text-sumi-800 mb-4 flex items-center gap-2">
                        <span>üó∫Ô∏è</span> ÊõúÊó•√óÊôÇÈñìÂ∏Ø „Éí„Éº„Éà„Éû„ÉÉ„Éó
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="p-2 text-left text-sumi-500"></th>
                                    <template x-for="(day, idx) in ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']" :key="day">
                                        <th class="p-2 text-center font-medium" :class="{
                                            'text-sango-600': idx === 0,
                                            'text-ai-600': idx === 6,
                                            'text-sumi-600': idx > 0 && idx < 6
                                        }" x-text="day"></th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="timeRange in getTimeRangesForHeatmap()" :key="timeRange">
                                    <tr>
                                        <td class="p-2 text-sumi-600 whitespace-nowrap" x-text="timeRange"></td>
                                        <template x-for="dayIdx in [0, 1, 2, 3, 4, 5, 6]" :key="dayIdx">
                                            <td class="p-1">
                                                <div class="w-full h-8 rounded flex items-center justify-center text-xs font-medium"
                                                     :class="getHeatmapCellClass(dayIdx, timeRange)"
                                                     x-text="getHeatmapValue(dayIdx, timeRange)"></div>
                                            </td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex items-center gap-4 mt-4 text-xs text-sumi-500">
                        <span>Âá°‰æã:</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-sumi-100"></span> 0</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-wakakusa-100"></span> 1-5</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-wakakusa-300"></span> 6-15</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-wakakusa-500"></span> 16+</span>
                    </div>
                </div>
            </div>

            <!-- Ëá™Ê≤ª‰Ωì‰∏ÄË¶ß -->
            <div x-show="slotView === 'municipalities'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-sumi-800">Ëá™Ê≤ª‰ΩìÂà•Á©∫„ÅçÁä∂Ê≥Å</h2>
                    <button @click="loadSlots(); loadGrounds()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êõ¥Êñ∞</button>
                </div>

                <!-- Á©∫„ÅçÁä∂Ê≥Å„Çµ„Éû„É™„Éº -->
                <div class="bg-white border border-sumi-100 rounded p-4 mb-6">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-6">
                            <div>
                                <span class="text-sumi-500 text-xs">Á∑èÁ©∫„ÅçÊû†Êï∞</span>
                                <div class="text-2xl font-semibold text-wakakusa-600" x-text="slots.length"></div>
                            </div>
                            <div>
                                <span class="text-sumi-500 text-xs">Á©∫„Åç„ÅÆ„ÅÇ„ÇãËá™Ê≤ª‰Ωì</span>
                                <div class="text-2xl font-semibold text-ai-600" x-text="municipalities.filter(m => getSlotsForMunicipality(m.id).length > 0).length + '/' + municipalities.length"></div>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center text-xs">
                            <span class="text-sumi-500">Âá°‰æã:</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-50 text-wakakusa-700">1-10‰ª∂</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-100 text-wakakusa-700">11-50‰ª∂</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-200 text-wakakusa-800">51‰ª∂‰ª•‰∏ä</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="m in municipalities" :key="m.id">
                        <div @click="selectMunicipality(m)"
                             class="border rounded p-4 cursor-pointer hover:border-ai-300 transition-colors relative overflow-hidden"
                             :class="{
                                 'bg-wakakusa-200 border-wakakusa-300': getSlotsForMunicipality(m.id).length > 50,
                                 'bg-wakakusa-100 border-wakakusa-200': getSlotsForMunicipality(m.id).length > 10 && getSlotsForMunicipality(m.id).length <= 50,
                                 'bg-wakakusa-50 border-wakakusa-100': getSlotsForMunicipality(m.id).length > 0 && getSlotsForMunicipality(m.id).length <= 10,
                                 'bg-white border-sumi-100': getSlotsForMunicipality(m.id).length === 0
                             }">
                            <div class="flex justify-between items-start">
                                <h3 class="font-medium text-sumi-800" x-text="m.name"></h3>
                                <span class="px-2 py-0.5 text-xs rounded font-medium"
                                      :class="getSlotsForMunicipality(m.id).length > 0 ? 'bg-wakakusa-500 text-white' : 'bg-sumi-100 text-sumi-500'"
                                      x-text="getSlotsForMunicipality(m.id).length + '‰ª∂'"></span>
                            </div>
                            <p class="text-sm text-sumi-500 mt-1" x-text="getGroundsForMunicipality(m.id).length + 'ÊñΩË®≠'"></p>
                            <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                            <div x-show="getSlotsForMunicipality(m.id).length > 0" class="absolute bottom-0 left-0 right-0 h-1 bg-wakakusa-200">
                                <div class="h-full bg-wakakusa-500" :style="'width: ' + Math.min(100, getSlotsForMunicipality(m.id).length / 2) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- „Ç∞„É©„Ç¶„É≥„Éâ‰∏ÄË¶ß -->
            <div x-show="slotView === 'grounds' && selectedMunicipality">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-sumi-800" x-text="selectedMunicipality?.name + ' „ÅÆÊñΩË®≠'"></h2>
                </div>

                <!-- „Ç∞„É©„Ç¶„É≥„Éâ„Çµ„Éû„É™„Éº -->
                <div class="bg-white border border-sumi-100 rounded p-4 mb-6">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-6">
                            <div>
                                <span class="text-sumi-500 text-xs">„Åì„ÅÆËá™Ê≤ª‰Ωì„ÅÆÁ©∫„ÅçÊû†</span>
                                <div class="text-2xl font-semibold text-wakakusa-600" x-text="getSlotsForMunicipality(selectedMunicipality?.id).length"></div>
                            </div>
                            <div>
                                <span class="text-sumi-500 text-xs">Á©∫„Åç„ÅÆ„ÅÇ„ÇãÊñΩË®≠</span>
                                <div class="text-2xl font-semibold text-ai-600" x-text="getGroundsForMunicipality(selectedMunicipality?.id).filter(g => getSlotsForGround(g.id).length > 0).length + '/' + getGroundsForMunicipality(selectedMunicipality?.id).length"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="g in getGroundsForMunicipality(selectedMunicipality?.id)" :key="g.id">
                        <div @click="selectGround(g)"
                             class="border rounded p-4 cursor-pointer hover:border-ai-300 transition-colors relative overflow-hidden"
                             :class="{
                                 'bg-wakakusa-200 border-wakakusa-300': getSlotsForGround(g.id).length > 20,
                                 'bg-wakakusa-100 border-wakakusa-200': getSlotsForGround(g.id).length > 5 && getSlotsForGround(g.id).length <= 20,
                                 'bg-wakakusa-50 border-wakakusa-100': getSlotsForGround(g.id).length > 0 && getSlotsForGround(g.id).length <= 5,
                                 'bg-white border-sumi-100': getSlotsForGround(g.id).length === 0
                             }">
                            <div class="flex justify-between items-start">
                                <h3 class="font-medium text-sumi-800" x-text="g.name"></h3>
                                <span class="px-2 py-0.5 text-xs rounded font-medium"
                                      :class="getSlotsForGround(g.id).length > 0 ? 'bg-wakakusa-500 text-white' : 'bg-sumi-100 text-sumi-500'"
                                      x-text="getSlotsForGround(g.id).length + '‰ª∂'"></span>
                            </div>
                            <p class="text-sm text-sumi-500 mt-1" x-text="g.court_pattern || ''"></p>
                            <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                            <div x-show="getSlotsForGround(g.id).length > 0" class="absolute bottom-0 left-0 right-0 h-1 bg-wakakusa-200">
                                <div class="h-full bg-wakakusa-500" :style="'width: ' + Math.min(100, getSlotsForGround(g.id).length * 5) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫ -->
            <div x-show="slotView === 'calendar' && selectedGround">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-sumi-800" x-text="selectedGround?.name + ' „ÅÆÁ©∫„ÅçÁä∂Ê≥Å'"></h2>
                </div>

                <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çµ„Éû„É™„Éº -->
                <div class="bg-white border border-sumi-100 rounded p-4 mb-4">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-6">
                            <div>
                                <span class="text-sumi-500 text-xs">„Åì„ÅÆÊñΩË®≠„ÅÆÁ©∫„ÅçÊû†</span>
                                <div class="text-2xl font-semibold text-wakakusa-600" x-text="getSlotsForGround(selectedGround?.id).length"></div>
                            </div>
                            <div>
                                <span class="text-sumi-500 text-xs">Á©∫„Åç„ÅÆ„ÅÇ„ÇãÊó•Êï∞</span>
                                <div class="text-2xl font-semibold text-ai-600" x-text="getUniqueDatesForGround(selectedGround?.id)"></div>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center text-xs">
                            <span class="text-sumi-500">Âá°‰æã:</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-50 text-wakakusa-700">1-2‰ª∂</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-100 text-wakakusa-700">3-5‰ª∂</span>
                            <span class="px-2 py-0.5 rounded bg-wakakusa-200 text-wakakusa-800">6‰ª∂‰ª•‰∏ä</span>
                        </div>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button @click="prevMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">ÂâçÊúà</button>
                    <h3 class="font-medium text-sumi-800" x-text="calendarYear + 'Âπ¥' + (calendarMonth + 1) + 'Êúà'"></h3>
                    <button @click="nextMonth()" class="px-4 py-2 text-sumi-600 hover:text-sumi-800 hover:bg-kinari-200 rounded transition-colors text-sm">ÁøåÊúà</button>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-sumi-100">
                        <template x-for="day in ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']" :key="day">
                            <div class="py-2 text-center text-xs font-medium" :class="day === 'Êó•' ? 'text-sango-500' : day === 'Âúü' ? 'text-ai-500' : 'text-sumi-600'" x-text="day"></div>
                        </template>
                    </div>
                    <div class="grid grid-cols-7">
                        <template x-for="(day, idx) in calendarDays" :key="idx">
                            <div
                                class="min-h-[80px] border-b border-r border-sumi-50 p-1 cursor-pointer transition-colors relative"
                                :class="{
                                    'bg-sumi-50': !day.currentMonth,
                                    'bg-wakakusa-200': day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length >= 6,
                                    'bg-wakakusa-100': day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length >= 3 && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length < 6,
                                    'bg-wakakusa-50': day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length > 0 && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length < 3,
                                    'bg-white hover:bg-ai-50': day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length === 0,
                                    'ring-2 ring-ai-400 ring-inset': selectedDate === day.dateStr,
                                    'border-l border-sumi-50': idx % 7 === 0
                                }"
                                @click="day.currentMonth && selectDate(day.dateStr)"
                            >
                                <div class="flex justify-between items-start">
                                    <span class="text-sm font-medium"
                                        :class="{
                                            'text-sumi-300': !day.currentMonth,
                                            'text-sango-600': day.currentMonth && day.dayOfWeek === 0,
                                            'text-ai-600': day.currentMonth && day.dayOfWeek === 6,
                                            'text-sumi-800': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                        }"
                                        x-text="day.day"
                                    ></span>
                                    <template x-if="day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length > 0">
                                        <span class="px-1.5 py-0.5 text-xs font-bold rounded bg-wakakusa-500 text-white"
                                              x-text="getSlotsForGroundDate(selectedGround?.id, day.dateStr).length"></span>
                                    </template>
                                </div>
                                <div class="mt-1 space-y-0.5 overflow-hidden max-h-[40px]">
                                    <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, day.dateStr).slice(0, 2)" :key="slot.id">
                                        <div class="text-xs px-1 py-0.5 bg-wakakusa-500/20 text-wakakusa-800 rounded truncate font-medium" x-text="slot.time_from + '-' + slot.time_to"></div>
                                    </template>
                                </div>
                                <!-- Á©∫„ÅçÊû†„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Éê„Éº -->
                                <div x-show="day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length > 0" class="absolute bottom-0 left-0 right-0 h-1 bg-wakakusa-300">
                                    <div class="h-full bg-wakakusa-600" :style="'width: ' + Math.min(100, getSlotsForGroundDate(selectedGround?.id, day.dateStr).length * 15) + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Selected Date Detail -->
                <div x-show="selectedDate" class="mt-6 bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-800 mb-4" x-text="formatDateFull(selectedDate) + ' „ÅÆÁ©∫„ÅçÊû†'"></h3>
                    <div x-show="getSlotsForGroundDate(selectedGround?.id, selectedDate).length === 0" class="text-sumi-500 text-center py-4 text-sm">
                        „Åì„ÅÆÊó•„ÅÆÁ©∫„ÅçÊû†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                    <div class="space-y-2">
                        <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, selectedDate)" :key="slot.id">
                            <div class="flex items-center justify-between p-3 bg-kinari-100 rounded">
                                <div>
                                    <span class="font-medium text-sumi-800 text-sm" x-text="slot.time_from + ' - ' + slot.time_to"></span>
                                    <span class="ml-2 text-sumi-500 text-sm" x-text="slot.court_name || ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Stats -->
                <div class="mt-4 text-sm text-sumi-500">
                    <span x-text="getSlotsForGround(selectedGround?.id).length"></span>‰ª∂„ÅÆÁ©∫„ÅçÊû†
                </div>
            </div>
        </div>

        <!-- Worker -->
        <div x-show="currentTab === 'worker'" x-cloak>
            <!-- Header with actions -->
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-sumi-800 mb-3">„ÉØ„Éº„Ç´„ÉºÁÆ°ÁêÜ</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select x-model="selectedMunicipalityForScrape" class="border border-sumi-200 rounded px-3 py-2 text-sm flex-1 bg-white text-sumi-700 focus:outline-none focus:border-ai-400">
                        <option value="">ÂÖ®„Å¶„ÅÆËá™Ê≤ª‰Ωì</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                    <div class="flex gap-2">
                        <button @click="triggerScrape()" :disabled="scrapeRunning" class="flex-1 sm:flex-none bg-wakakusa-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-wakakusa-700 disabled:opacity-50 transition-colors">
                            <span x-show="!scrapeRunning">„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞</span>
                            <span x-show="scrapeRunning">ÂÆüË°å‰∏≠...</span>
                        </button>
                        <button @click="loadJobs()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">Êõ¥Êñ∞</button>
                    </div>
                </div>
            </div>

            <!-- Job Stats - Compact on mobile -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">ÂÆüË°å‰∏≠</div>
                    <div class="text-xl font-semibold text-sumi-600" x-text="jobs.filter(j => j.status === 'running').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">ÂÆå‰∫Ü</div>
                    <div class="text-xl font-semibold text-wakakusa-600" x-text="jobs.filter(j => j.status === 'completed').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">Â§±Êïó</div>
                    <div class="text-xl font-semibold text-sango-500" x-text="jobs.filter(j => j.status === 'failed').length"></div>
                </div>
                <div class="bg-white border border-sumi-100 rounded p-3 text-center">
                    <div class="text-sumi-500 text-xs">„Çπ„É≠„ÉÉ„Éà</div>
                    <div class="text-xl font-semibold text-ai-600" x-text="jobs.reduce((sum, j) => sum + (j.slots_found || 0), 0)"></div>
                </div>
            </div>

            <!-- Recent Jobs - Card layout for mobile -->
            <div class="bg-white border border-sumi-100 rounded mb-4">
                <div class="px-4 py-3 border-b border-sumi-100">
                    <h3 class="font-medium text-sumi-700 text-sm">ÊúÄËøë„ÅÆ„Ç∏„Éß„Éñ</h3>
                </div>

                <!-- Mobile: Card view -->
                <div class="md:hidden divide-y divide-sumi-50">
                    <template x-for="job in jobs" :key="job.id">
                        <div class="p-3" @click="showJobDetails(job)">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm text-sumi-800" x-text="job.municipality_name || job.municipality_id"></span>
                                <span class="px-2 py-0.5 text-xs rounded" :class="{
                                    'bg-wakakusa-50 text-wakakusa-700': job.scrape_status === 'success',
                                    'bg-ai-50 text-ai-700': job.scrape_status === 'success_no_slots',
                                    'bg-sango-50 text-sango-700': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                    'bg-sumi-100 text-sumi-600': job.status === 'running',
                                    'bg-sumi-50 text-sumi-500': !job.scrape_status && job.status !== 'running'
                                }" x-text="job.status === 'running' ? 'ÂÆüË°å‰∏≠' : formatScrapeStatus(job.scrape_status)"></span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-sumi-500">
                                <span x-text="job.slots_found ? job.slots_found + '‰ª∂„ÅÆÁ©∫„Åç' : 'Á©∫„Åç„Å™„Åó'"></span>
                                <span x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at) || '-'"></span>
                            </div>
                            <div x-show="job.error_message" class="mt-1 text-xs text-sango-600 truncate" x-text="job.error_message"></div>
                        </div>
                    </template>
                    <div x-show="jobs.length === 0" class="p-4 text-center text-sumi-500 text-sm">„Ç∏„Éß„Éñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>

                <!-- Desktop: Table view -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-sumi-100">
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">Ëá™Ê≤ª‰Ωì</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ÁµêÊûú</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">„Çπ„É≠„ÉÉ„Éà</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">ÊôÇÂàª</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-sumi-500 uppercase tracking-wide">Ë©≥Á¥∞</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-sumi-50">
                            <template x-for="job in jobs" :key="job.id">
                                <tr class="hover:bg-kinari-50 transition-colors">
                                    <td class="px-4 py-3 text-sm text-sumi-800" x-text="job.municipality_name || job.municipality_id"></td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-0.5 text-xs rounded" :class="{
                                            'bg-sumi-100 text-sumi-600': job.status === 'running',
                                            'bg-wakakusa-50 text-wakakusa-700': job.status === 'completed',
                                            'bg-sango-50 text-sango-700': job.status === 'failed',
                                            'bg-sumi-50 text-sumi-500': job.status === 'pending'
                                        }" x-text="job.status"></span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-0.5 text-xs rounded" :class="{
                                            'bg-wakakusa-50 text-wakakusa-700': job.scrape_status === 'success',
                                            'bg-ai-50 text-ai-700': job.scrape_status === 'success_no_slots',
                                            'bg-sango-50 text-sango-700': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                            'bg-sumi-50 text-sumi-500': !job.scrape_status
                                        }" x-text="formatScrapeStatus(job.scrape_status)"></span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-sumi-700" x-text="job.slots_found || 0"></td>
                                    <td class="px-4 py-3 text-sm text-sumi-500" x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at)"></td>
                                    <td class="px-4 py-3">
                                        <button @click="showJobDetails(job)" class="text-ai-600 hover:text-ai-700 text-sm transition-colors" x-show="job.error_message || job.diagnostics">Ë©≥Á¥∞</button>
                                        <span x-show="!job.error_message && !job.diagnostics" class="text-sumi-300">-</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Logs - Collapsible on mobile -->
            <div class="bg-white border border-sumi-100 rounded overflow-hidden">
                <div class="px-4 py-3 border-b border-sumi-100 flex justify-between items-center cursor-pointer" @click="showLogs = !showLogs">
                    <h3 class="font-medium text-sumi-700 text-sm">„É≠„Ç∞</h3>
                    <div class="flex items-center space-x-2">
                        <label class="hidden sm:flex items-center text-sm text-sumi-600" @click.stop>
                            <input type="checkbox" x-model="autoScrollLogs" class="mr-1"> Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                        </label>
                        <button @click.stop="clearLogs()" class="text-sm text-sumi-500 hover:text-sumi-700 transition-colors">„ÇØ„É™„Ç¢</button>
                        <svg class="w-5 h-5 text-sumi-400 md:hidden transition-transform" :class="{'rotate-180': showLogs}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div x-show="showLogs" x-cloak class="md:block h-40 md:h-64 overflow-y-auto bg-sumi-900 text-sumi-100 p-3 font-mono text-xs" id="log-container">
                    <template x-for="(log, idx) in workerLogs" :key="idx">
                        <div :class="{
                            'text-sango-400': log.level === 'error',
                            'text-yellow-400': log.level === 'warn',
                            'text-wakakusa-400': log.level === 'info',
                            'text-sumi-400': log.level === 'debug'
                        }">
                            <span class="text-sumi-500" x-text="log.time"></span>
                            <span class="ml-1" x-text="'[' + log.level.toUpperCase() + ']'"></span>
                            <span class="ml-1" x-text="log.message"></span>
                        </div>
                    </template>
                    <div x-show="workerLogs.length === 0" class="text-sumi-500">„É≠„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>
            </div>
        </div>

        <!-- AI Support -->
        <div x-show="currentTab === 'support'" x-cloak>
            <h2 class="text-xl font-semibold text-sumi-800 mb-6">AI „Çµ„Éù„Éº„Éà</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat -->
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-700 mb-4">AI „ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="h-64 overflow-y-auto border border-sumi-100 rounded p-4 mb-4 bg-kinari-50">
                        <template x-for="(msg, i) in chatMessages" :key="i">
                            <div class="mb-2" :class="{'text-right': msg.role === 'user'}">
                                <span class="inline-block px-3 py-2 rounded text-sm" :class="msg.role === 'user' ? 'bg-ai-600 text-white' : 'bg-sumi-100 text-sumi-800'" x-text="msg.content" style="white-space: pre-wrap;"></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" x-model="chatInput" @keydown.enter.prevent="handleChatKeydown($event)" @compositionstart="isComposing = true" @compositionend="isComposing = false" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÈÄÅ‰ø°)" class="flex-1 border border-sumi-200 rounded px-4 py-2 text-sm focus:outline-none focus:border-ai-400">
                        <button @click="sendChat()" class="bg-ai-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-ai-700 transition-colors">ÈÄÅ‰ø°</button>
                    </div>
                </div>
                <!-- Tickets -->
                <div class="bg-white border border-sumi-100 rounded p-5">
                    <h3 class="font-medium text-sumi-700 mb-4">„Çµ„Éù„Éº„Éà„ÉÅ„Ç±„ÉÉ„Éà</h3>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        <template x-for="ticket in tickets" :key="ticket.id">
                            <div class="border border-sumi-100 rounded p-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-sumi-800 text-sm" x-text="ticket.subject"></span>
                                    <span class="px-2 py-0.5 text-xs rounded" :class="{
                                        'bg-sango-50 text-sango-700': ticket.status === 'open',
                                        'bg-sumi-100 text-sumi-600': ticket.status === 'escalated',
                                        'bg-wakakusa-50 text-wakakusa-700': ticket.status === 'resolved'
                                    }" x-text="ticket.status"></span>
                                </div>
                                <div class="text-sm text-sumi-500 mt-1" x-text="ticket.email"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Team Modal -->
    <div x-show="showTeamModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded p-6 w-full max-w-md" @click.away="showTeamModal = false">
            <h3 class="font-semibold text-sumi-800 mb-4">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">„ÉÅ„Éº„É†Âêç</label>
                    <input type="text" x-model="newTeam.name" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" x-model="newTeam.email" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">„Éó„É©„É≥</label>
                    <select x-model="newTeam.plan" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400 bg-white">
                        <option value="free">Free</option>
                        <option value="personal">Personal</option>
                        <option value="pro">Pro</option>
                        <option value="org">Org</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showTeamModal = false" class="px-4 py-2 border border-sumi-200 rounded text-sm text-sumi-600 hover:bg-kinari-100 transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createTeam()" class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <!-- Date Detail Modal -->
    <div x-show="showDateDetailModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50 p-4" @click.self="showDateDetailModal = false">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-sumi-100 flex justify-between items-center">
                <h3 class="font-semibold text-sumi-800" x-text="formatDateFull(allCalendarSelectedDate) + ' „ÅÆÁ©∫„ÅçÁä∂Ê≥Å'"></h3>
                <button @click="showDateDetailModal = false" class="text-sumi-400 hover:text-sumi-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div x-show="getSlotsForDate(allCalendarSelectedDate).length === 0" class="text-sumi-500 text-center py-8">
                    „Åì„ÅÆÊó•„ÅÆÁ©∫„ÅçÊû†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                </div>
                <!-- „Çµ„Éû„É™„Éº -->
                <div x-show="getSlotsForDate(allCalendarSelectedDate).length > 0" class="mb-4 p-3 bg-wakakusa-50 rounded-lg">
                    <div class="flex gap-4">
                        <div>
                            <span class="text-xs text-sumi-500">Á∑èÁ©∫„ÅçÊû†</span>
                            <div class="text-xl font-semibold text-wakakusa-700" x-text="getSlotsForDate(allCalendarSelectedDate).length + 'Êû†'"></div>
                        </div>
                        <div>
                            <span class="text-xs text-sumi-500">Ëá™Ê≤ª‰ΩìÊï∞</span>
                            <div class="text-xl font-semibold text-ai-600" x-text="getGroundsWithSlotsForDate(allCalendarSelectedDate).length"></div>
                        </div>
                    </div>
                </div>
                <!-- Ëá™Ê≤ª‰ΩìÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶Ë°®Á§∫ -->
                <div class="space-y-4">
                    <template x-for="municipality in getGroundsWithSlotsForDate(allCalendarSelectedDate)" :key="municipality.id">
                        <div class="border border-sumi-100 rounded-lg overflow-hidden">
                            <div class="flex justify-between items-center p-3 bg-sumi-50">
                                <h4 class="font-medium text-sumi-800" x-text="municipality.name"></h4>
                                <span class="px-2 py-0.5 text-xs rounded bg-wakakusa-500 text-white font-medium"
                                      x-text="getSlotsForMunicipalityDate(municipality.id, allCalendarSelectedDate).length + 'Êû†'"></span>
                            </div>
                            <div class="p-3">
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="slot in getSlotsForMunicipalityDate(municipality.id, allCalendarSelectedDate)" :key="slot.id">
                                        <span class="px-2 py-1 bg-wakakusa-50 text-wakakusa-800 text-xs rounded border border-wakakusa-200"
                                              x-text="slot.time_from + '-' + slot.time_to + (slot.court_name ? ' (' + slot.court_name + ')' : '')"></span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="p-4 border-t border-sumi-100 bg-sumi-50">
                <button @click="showDateDetailModal = false" class="w-full px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <!-- Facility Modal -->
    <div x-show="showFacilityModal" x-cloak class="fixed inset-0 bg-sumi-900/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded p-6 w-full max-w-md" @click.away="showFacilityModal = false">
            <h3 class="font-semibold text-sumi-800 mb-4">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">ÊñΩË®≠Âêç</label>
                    <input type="text" x-model="newFacility.name" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">Ëá™Ê≤ª‰Ωì</label>
                    <input type="text" x-model="newFacility.municipality" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">„Çπ„ÇØ„É¨„Ç§„Éë„Éº„Çø„Ç§„Éó</label>
                    <input type="text" x-model="newFacility.scraper_type" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-sumi-700 mb-1">URL</label>
                    <input type="url" x-model="newFacility.url" class="block w-full border border-sumi-200 rounded px-3 py-2 text-sm focus:outline-none focus:border-ai-400">
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showFacilityModal = false" class="px-4 py-2 border border-sumi-200 rounded text-sm text-sumi-600 hover:bg-kinari-100 transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createFacility()" class="px-4 py-2 bg-ai-600 text-white rounded text-sm font-medium hover:bg-ai-700 transition-colors">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <script>
    const NAV_TABS = [
        { id: 'dashboard', label: '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ' },
        { id: 'teams', label: '„ÉÅ„Éº„É†' },
        { id: 'facilities', label: 'ÊñΩË®≠' },
        { id: 'slots', label: 'Á©∫„ÅçÁä∂Ê≥Å' },
        { id: 'worker', label: '„ÉØ„Éº„Ç´„Éº' },
        { id: 'support', label: 'AI' }
    ];

    const SCRAPE_STATUS_MAP = {
        'success': 'Á©∫„Åç„ÅÇ„Çä',
        'success_no_slots': 'Á©∫„Åç„Å™„Åó',
        'parse_error': 'Ëß£Êûê„Ç®„É©„Éº',
        'network_error': 'ÈÄö‰ø°„Ç®„É©„Éº',
        'no_table_found': '„ÉÜ„Éº„Éñ„É´„Å™„Åó',
        'unknown_facility': '‰∏çÊòé„Å™ÊñΩË®≠',
        'scraper_unavailable': '„Çπ„ÇØ„É¨„Ç§„Éë„ÉºÂà©Áî®‰∏çÂèØ',
        'execution_error': 'ÂÆüË°å„Ç®„É©„Éº'
    };

    const DAY_NAMES = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];

    function app() {
        return {
            navTabs: NAV_TABS,
            currentTab: 'dashboard',
            mobileMenuOpen: false,
            dashboard: { TeamCount: 0, FacilityCount: 0, WatchConditionCount: 0, NotificationCount: 0, OpenTicketCount: 0, TeamsByPlan: [] },
            teams: [],
            facilities: [],
            grounds: [],
            slots: [],
            municipalities: [],
            slotView: 'all-calendar',
            selectedMunicipality: null,
            selectedGround: null,
            slotFilter: { municipalityId: '' },
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            selectedDate: null,
            allCalendarSelectedDate: null,
            showDateDetailModal: false,
            showLogs: window.innerWidth >= 768,
            jobs: [],
            workerLogs: [],
            scrapeRunning: false,
            selectedMunicipalityForScrape: '',
            autoScrollLogs: true,
            tickets: [],
            chatMessages: [],
            chatInput: '',
            isComposing: false,
            showTeamModal: false,
            showFacilityModal: false,
            newTeam: { name: '', email: '', plan: 'free' },
            newFacility: { name: '', municipality: '', scraper_type: '', url: '' },
            facilityFilter: { search: '', municipality: '', status: '' },

            async init() {
                await this.loadDashboard();
                await this.loadTeams();
                await this.loadFacilities();
                await this.loadMunicipalities();
                await this.loadGrounds();
                await this.loadSlots();
                await this.loadJobs();
                await this.loadTickets();
            },

            async loadDashboard() {
                const res = await fetch('/admin/api/dashboard');
                this.dashboard = await res.json();
            },

            async loadTeams() {
                const res = await fetch('/admin/api/teams');
                this.teams = await res.json() || [];
            },

            async loadFacilities() {
                const res = await fetch('/admin/api/grounds');
                const grounds = await res.json();
                // Map grounds to facilities format
                this.facilities = (grounds || []).map(g => ({
                    id: g.id,
                    name: g.name,
                    municipality: g.municipality_name,
                    scraper_type: g.court_pattern,
                    enabled: g.enabled
                }));
            },

            async loadMunicipalities() {
                const res = await fetch('/admin/api/municipalities');
                this.municipalities = await res.json() || [];
            },

            async loadGrounds() {
                const res = await fetch('/admin/api/grounds');
                this.grounds = await res.json() || [];
            },

            async loadSlots() {
                // Load all slots (increased limit needed in API)
                const res = await fetch('/admin/api/slots?limit=5000');
                this.slots = await res.json() || [];
            },

            // Calendar methods
            get calendarDays() {
                const days = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay();

                const prevMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const d = prevMonth.getDate() - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: true, dayOfWeek: date.getDay() });
                }

                const remaining = 42 - days.length;
                for (let d = 1; d <= remaining; d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }
                return days;
            },

            toDateStr(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            },

            changeMonth(delta) {
                const d = new Date(this.calendarYear, this.calendarMonth + delta, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            prevMonth() { this.changeMonth(-1); },
            nextMonth() { this.changeMonth(1); },

            selectDate(dateStr) {
                this.selectedDate = this.selectedDate === dateStr ? null : dateStr;
            },

            selectAllCalendarDate(dateStr) {
                this.allCalendarSelectedDate = dateStr;
                if (this.getSlotsForDate(dateStr).length > 0) {
                    this.showDateDetailModal = true;
                }
            },

            getSlotsForDate(dateStr) {
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            // ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºÁî®: Á©∫„Åç„ÅÆ„ÅÇ„ÇãËá™Ê≤ª‰Ωì‰∏ÄË¶ß„ÇíÂèñÂæó
            getGroundsWithSlots() {
                const municipalityIds = new Set(this.slots.map(s => s.municipality_id));
                return this.municipalities.filter(m => municipalityIds.has(m.id));
            },

            // ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºÁî®: ÂÖ®‰Ωì„ÅÆÁ©∫„Åç„ÅÆ„ÅÇ„ÇãÊó•Êï∞„ÇíÂèñÂæó
            getUniqueDatesAll() {
                const dates = new Set();
                this.slots.forEach(s => {
                    dates.add(s.slot_date.split('T')[0]);
                });
                return dates.size;
            },

            // ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºÁî®: ÊåáÂÆöÊó•„Å´Á©∫„Åç„ÅÆ„ÅÇ„ÇãËá™Ê≤ª‰Ωì‰∏ÄË¶ßÔºà„É¶„Éã„Éº„ÇØ„Å™ court_name „Åß„Ç´„Ç¶„É≥„ÉàÔºâ
            getGroundsWithSlotsForDate(dateStr) {
                const municipalities = {};
                this.slots.forEach(s => {
                    if (s.slot_date.split('T')[0] === dateStr) {
                        if (!municipalities[s.municipality_id]) {
                            municipalities[s.municipality_id] = {
                                id: s.municipality_id,
                                name: s.municipality_name || '‰∏çÊòé',
                                municipality_name: s.municipality_name || '‰∏çÊòé',
                                courtNames: new Set()
                            };
                        }
                        municipalities[s.municipality_id].courtNames.add(s.court_name);
                    }
                });
                return Object.values(municipalities).map(m => ({
                    ...m,
                    slotCount: m.courtNames.size
                }));
            },

            // ÂÖ®ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºÁî®: ÊåáÂÆöÊó•„ÉªËá™Ê≤ª‰Ωì„ÅÆ„Çπ„É≠„ÉÉ„Éà‰∏ÄË¶ß
            getSlotsForMunicipalityDate(municipalityId, dateStr) {
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return s.municipality_id === municipalityId && slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: ÊõúÊó•Âà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
            getSlotsByDayOfWeek() {
                const days = [0, 1, 2, 3, 4, 5, 6].map(() => ({ count: 0 }));
                this.slots.forEach(s => {
                    const date = new Date(s.slot_date);
                    const dayOfWeek = date.getDay();
                    days[dayOfWeek].count++;
                });
                const maxCount = Math.max(...days.map(d => d.count), 1);
                const avgCount = days.reduce((sum, d) => sum + d.count, 0) / 7;
                return days.map((d, idx) => ({
                    ...d,
                    percentage: Math.round((d.count / maxCount) * 100),
                    isHot: d.count > avgCount * 1.2
                }));
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: ÊôÇÈñìÂ∏ØÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
            getSlotsByTimeRange() {
                const ranges = [
                    { range: '06:00-08:00', start: 6, end: 8, count: 0 },
                    { range: '08:00-10:00', start: 8, end: 10, count: 0 },
                    { range: '10:00-12:00', start: 10, end: 12, count: 0 },
                    { range: '12:00-14:00', start: 12, end: 14, count: 0 },
                    { range: '14:00-16:00', start: 14, end: 16, count: 0 },
                    { range: '16:00-18:00', start: 16, end: 18, count: 0 },
                    { range: '18:00-20:00', start: 18, end: 20, count: 0 },
                    { range: '20:00-22:00', start: 20, end: 22, count: 0 }
                ];
                this.slots.forEach(s => {
                    const hour = parseInt(s.time_from.split(':')[0]);
                    const range = ranges.find(r => hour >= r.start && hour < r.end);
                    if (range) range.count++;
                });
                const maxCount = Math.max(...ranges.map(r => r.count), 1);
                const avgCount = ranges.reduce((sum, r) => sum + r.count, 0) / ranges.length;
                return ranges.map(r => ({
                    ...r,
                    percentage: Math.round((r.count / maxCount) * 100),
                    isHot: r.count > avgCount * 1.2
                }));
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: Ëá™Ê≤ª‰ΩìÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
            getSlotsByMunicipality() {
                const muniMap = {};
                this.slots.forEach(s => {
                    const key = s.municipality_id;
                    if (!muniMap[key]) {
                        muniMap[key] = { id: key, name: s.municipality_name || '‰∏çÊòé', count: 0 };
                    }
                    muniMap[key].count++;
                });
                const munis = Object.values(muniMap).sort((a, b) => b.count - a.count);
                const maxCount = Math.max(...munis.map(m => m.count), 1);
                const avgCount = munis.reduce((sum, m) => sum + m.count, 0) / Math.max(munis.length, 1);
                return munis.map(m => ({
                    ...m,
                    percentage: Math.round((m.count / maxCount) * 100),
                    isHot: m.count > avgCount * 1.2
                }));
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: „Ç≥„Éº„ÉàÂà•„ÅÆÁ©∫„ÅçÁä∂Ê≥Å
            getSlotsByCourt() {
                const courtMap = {};
                this.slots.forEach(s => {
                    const name = s.court_name || '‰∏çÊòé';
                    if (!courtMap[name]) {
                        courtMap[name] = { name, count: 0 };
                    }
                    courtMap[name].count++;
                });
                return Object.values(courtMap).sort((a, b) => b.count - a.count);
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: „Éí„Éº„Éà„Éû„ÉÉ„ÉóÁî®„ÅÆÊôÇÈñìÂ∏Ø‰∏ÄË¶ß
            getTimeRangesForHeatmap() {
                return ['06:00-08:00', '08:00-10:00', '10:00-12:00', '12:00-14:00', '14:00-16:00', '16:00-18:00', '18:00-20:00', '20:00-22:00'];
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆÂÄ§„ÇíÂèñÂæó
            getHeatmapValue(dayOfWeek, timeRange) {
                const [startStr] = timeRange.split('-');
                const startHour = parseInt(startStr.split(':')[0]);
                const endHour = startHour + 2;
                return this.slots.filter(s => {
                    const date = new Date(s.slot_date);
                    const slotDayOfWeek = date.getDay();
                    const hour = parseInt(s.time_from.split(':')[0]);
                    return slotDayOfWeek === dayOfWeek && hour >= startHour && hour < endHour;
                }).length;
            },

            // Áãô„ÅÑÁõÆÂàÜÊûê: „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÅÆ„Çª„É´„ÅÆ„ÇØ„É©„Çπ„ÇíÂèñÂæó
            getHeatmapCellClass(dayOfWeek, timeRange) {
                const value = this.getHeatmapValue(dayOfWeek, timeRange);
                if (value === 0) return 'bg-sumi-100 text-sumi-400';
                if (value <= 5) return 'bg-wakakusa-100 text-wakakusa-800';
                if (value <= 15) return 'bg-wakakusa-300 text-wakakusa-900';
                return 'bg-wakakusa-500 text-white';
            },

            // Filtered facilities for facility management tab
            get filteredFacilities() {
                return this.facilities.filter(f => {
                    // Search filter (name or municipality)
                    if (this.facilityFilter.search) {
                        const search = this.facilityFilter.search.toLowerCase();
                        if (!f.name.toLowerCase().includes(search) && 
                            !f.municipality?.toLowerCase().includes(search)) {
                            return false;
                        }
                    }
                    // Municipality filter
                    if (this.facilityFilter.municipality && f.municipality !== this.facilityFilter.municipality) {
                        return false;
                    }
                    // Status filter
                    if (this.facilityFilter.status !== '') {
                        const isEnabled = this.facilityFilter.status === 'enabled';
                        if (f.enabled !== isEnabled) {
                            return false;
                        }
                    }
                    return true;
                });
            },

            // Unique municipalities from facilities
            get uniqueFacilityMunicipalities() {
                const munis = [...new Set(this.facilities.map(f => f.municipality).filter(Boolean))];
                return munis.sort();
            },

            clearFacilityFilters() {
                this.facilityFilter = { search: '', municipality: '', status: '' };
            },

            // Drilldown methods
            getGroundsForMunicipality(municipalityId) {
                return this.grounds.filter(g => g.municipality_id === municipalityId);
            },

            getSlotsForMunicipality(municipalityId) {
                return this.slots.filter(s => s.municipality_id === municipalityId);
            },

            getSlotsForGround(groundId) {
                if (!groundId) return [];
                return this.slots.filter(s => s.ground_id === groundId);
            },

            getSlotsForGroundDate(groundId, dateStr) {
                if (!groundId) return [];
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return s.ground_id === groundId && slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            getUniqueDatesForGround(groundId) {
                if (!groundId) return 0;
                const dates = new Set();
                this.slots.filter(s => s.ground_id === groundId).forEach(s => {
                    dates.add(s.slot_date.split('T')[0]);
                });
                return dates.size;
            },

            selectMunicipality(m) {
                this.selectedMunicipality = m;
                this.selectedGround = null;
                this.slotView = 'grounds';
            },

            selectGround(g) {
                this.selectedGround = g;
                this.selectedDate = null;
                this.slotView = 'calendar';
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}(${DAY_NAMES[d.getDay()]})`;
            },

            formatDateFull(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•(${DAY_NAMES[d.getDay()]})`;
            },

            formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            },

            formatScrapeStatus(status) {
                return SCRAPE_STATUS_MAP[status] || status || '-';
            },

            showJobDetails(job) {
                let details = '';
                if (job.error_message) {
                    details += `„Ç®„É©„Éº: ${job.error_message}\n\n`;
                }
                if (job.diagnostics) {
                    try {
                        const diag = JSON.parse(job.diagnostics);
                        details += 'Ë®∫Êñ≠ÊÉÖÂ†±:\n';
                        if (diag.note) details += `  „É°„É¢: ${diag.note}\n`;
                        if (diag.html_verification) {
                            const v = diag.html_verification;
                            if (v.server_message) details += `  „Çµ„Éº„Éê„ÉºÂõûÁ≠î: ${v.server_message}\n`;
                            if (v.confirmation) details += `  Á¢∫Ë™ç: ${v.confirmation}\n`;
                        }
                        if (diag.raw_results_count !== undefined) details += `  ÁîüÁµêÊûúÊï∞: ${diag.raw_results_count}\n`;
                        if (diag.parsed_slots_count !== undefined) details += `  Ëß£ÊûêÊ∏à„Åø: ${diag.parsed_slots_count}\n`;
                        if (diag.parse_errors) details += `  Ëß£Êûê„Ç®„É©„Éº: ${diag.parse_errors}\n`;
                    } catch (e) {
                        details += `Ë®∫Êñ≠ÊÉÖÂ†±: ${job.diagnostics}`;
                    }
                }
                if (details) {
                    alert(details);
                }
            },

            // Worker methods
            async loadJobs() {
                const res = await fetch('/admin/api/jobs');
                const data = await res.json();
                this.jobs = data || [];
            },

            async triggerScrape() {
                this.scrapeRunning = true;
                this.addLog('info', '„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                try {
                    const url = this.selectedMunicipalityForScrape
                        ? `/api/scrape?municipality_id=${this.selectedMunicipalityForScrape}`
                        : '/api/scrape';
                    const res = await fetch(url, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        this.addLog('info', `„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞ÂÆå‰∫Ü: ${data.message}`);
                    } else {
                        this.addLog('error', `„Ç®„É©„Éº: ${data.error}`);
                    }
                } catch (e) {
                    this.addLog('error', `„É™„ÇØ„Ç®„Çπ„ÉàÂ§±Êïó: ${e.message}`);
                } finally {
                    this.scrapeRunning = false;
                    await this.loadJobs();
                    await this.loadSlots();
                }
            },

            addLog(level, message) {
                const now = new Date();
                const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                this.workerLogs.push({ level, message, time });
                if (this.workerLogs.length > 500) this.workerLogs.shift();
                if (this.autoScrollLogs) {
                    this.$nextTick(() => {
                        const container = document.getElementById('log-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                }
            },

            clearLogs() {
                this.workerLogs = [];
            },

            async loadTickets() {
                const res = await fetch('/admin/api/tickets');
                this.tickets = await res.json();
            },

            async createTeam() {
                await fetch('/admin/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newTeam)
                });
                this.showTeamModal = false;
                this.newTeam = { name: '', email: '', plan: 'free' };
                await this.loadTeams();
                await this.loadDashboard();
            },

            async createFacility() {
                await fetch('/admin/api/facilities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newFacility)
                });
                this.showFacilityModal = false;
                this.newFacility = { name: '', municipality: '', scraper_type: '', url: '' };
                await this.loadFacilities();
                await this.loadDashboard();
            },

            handleChatKeydown(event) {
                // IMEÂ§âÊèõ‰∏≠„ÅØÈÄÅ‰ø°„Åó„Å™„ÅÑ
                if (this.isComposing) return;
                // Shift+Enter„ÅßÈÄÅ‰ø°
                if (event.shiftKey) {
                    this.sendChat();
                }
            },

            async sendChat() {
                if (!this.chatInput.trim()) return;
                const msg = this.chatInput;
                this.chatMessages.push({ role: 'user', content: msg });
                this.chatInput = '';
                const res = await fetch('/admin/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                this.chatMessages.push({ role: 'ai', content: data.response });
            }
        }
    }
    </script>
</body>
</html>
