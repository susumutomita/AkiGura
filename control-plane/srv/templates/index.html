<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkiGura - „Ç∞„É©„Ç¶„É≥„ÉâÁõ£Ë¶ñSaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <!-- Mobile Header -->
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">üèà AkiGura</h1>
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        <path x-show="mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <!-- Desktop Nav -->
                <nav class="hidden md:flex space-x-2">
                    <button @click="currentTab = 'dashboard'" :class="{'bg-indigo-700': currentTab === 'dashboard'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
                    <button @click="currentTab = 'teams'" :class="{'bg-indigo-700': currentTab === 'teams'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">„ÉÅ„Éº„É†</button>
                    <button @click="currentTab = 'facilities'" :class="{'bg-indigo-700': currentTab === 'facilities'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">ÊñΩË®≠</button>
                    <button @click="currentTab = 'slots'" :class="{'bg-indigo-700': currentTab === 'slots'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">Á©∫„ÅçÁä∂Ê≥Å</button>
                    <button @click="currentTab = 'worker'" :class="{'bg-indigo-700': currentTab === 'worker'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">„ÉØ„Éº„Ç´„Éº</button>
                    <button @click="currentTab = 'support'" :class="{'bg-indigo-700': currentTab === 'support'}" class="px-3 py-2 rounded hover:bg-indigo-500 text-sm">AI</button>
                </nav>
            </div>
            <!-- Mobile Nav -->
            <nav x-show="mobileMenuOpen" x-cloak class="md:hidden mt-3 pb-2 grid grid-cols-3 gap-2">
                <button @click="currentTab = 'dashboard'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'dashboard'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
                <button @click="currentTab = 'teams'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'teams'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">„ÉÅ„Éº„É†</button>
                <button @click="currentTab = 'facilities'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'facilities'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">ÊñΩË®≠</button>
                <button @click="currentTab = 'slots'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'slots'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">Á©∫„ÅçÁä∂Ê≥Å</button>
                <button @click="currentTab = 'worker'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'worker'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">„ÉØ„Éº„Ç´„Éº</button>
                <button @click="currentTab = 'support'; mobileMenuOpen = false" :class="{'bg-indigo-700': currentTab === 'support'}" class="px-2 py-2 rounded hover:bg-indigo-500 text-sm text-center">AI„Çµ„Éù„Éº„Éà</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <h2 class="text-2xl font-bold mb-6">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">ÁôªÈå≤„ÉÅ„Éº„É†Êï∞</div>
                    <div class="text-3xl font-bold text-indigo-600" x-text="dashboard.TeamCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">ÂØæÂøúÊñΩË®≠Êï∞</div>
                    <div class="text-3xl font-bold text-green-600" x-text="dashboard.FacilityCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">Áõ£Ë¶ñÊù°‰ª∂Êï∞</div>
                    <div class="text-3xl font-bold text-blue-600" x-text="dashboard.WatchConditionCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">Êú™ÂØæÂøú„ÉÅ„Ç±„ÉÉ„Éà</div>
                    <div class="text-3xl font-bold text-red-600" x-text="dashboard.OpenTicketCount">0</div>
                </div>
            </div>
            <!-- Plan Distribution -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">„Éó„É©„É≥Âà•„ÉÅ„Éº„É†Êï∞</h3>
                <div class="flex space-x-4">
                    <template x-for="plan in dashboard.TeamsByPlan" :key="plan.plan">
                        <div class="flex-1 bg-gray-50 rounded p-4 text-center">
                            <div class="text-sm text-gray-500" x-text="plan.plan"></div>
                            <div class="text-2xl font-bold" x-text="plan.count"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Teams -->
        <div x-show="currentTab === 'teams'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">„ÉÅ„Éº„É†ÁÆ°ÁêÜ</h2>
                <button @click="showTeamModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„ÉÅ„Éº„É†Âêç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„É°„Éº„É´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Éó„É©„É≥</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="team in teams" :key="team.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="team.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="team.email"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-gray-100': team.plan === 'free', 'bg-blue-100': team.plan === 'personal', 'bg-purple-100': team.plan === 'pro', 'bg-yellow-100': team.plan === 'org'}" x-text="team.plan"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-green-100 text-green-800': team.status === 'active', 'bg-red-100 text-red-800': team.status !== 'active'}" x-text="team.status"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Facilities -->
        <div x-show="currentTab === 'facilities'" x-cloak>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ÊñΩË®≠ÁÆ°ÁêÜ</h2>
                <button @click="showFacilityModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊñΩË®≠Âêç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ëá™Ê≤ª‰Ωì</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÇØ„É¨„Ç§„Éë„Éº</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="f in facilities" :key="f.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.municipality"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="f.scraper_type"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-green-100 text-green-800': f.enabled, 'bg-red-100 text-red-800': !f.enabled}" x-text="f.enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Slots (Á©∫„ÅçÁä∂Ê≥Å) - Calendar View -->
        <div x-show="currentTab === 'slots'" x-cloak>
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 mb-4 text-sm">
                <button @click="slotView = 'municipalities'; selectedMunicipality = null; selectedGround = null" 
                        class="text-indigo-600 hover:underline" :class="{'font-bold': slotView === 'municipalities'}">Ëá™Ê≤ª‰Ωì‰∏ÄË¶ß</button>
                <template x-if="selectedMunicipality">
                    <span class="flex items-center gap-2">
                        <span class="text-gray-400">/</span>
                        <button @click="slotView = 'grounds'; selectedGround = null" 
                                class="text-indigo-600 hover:underline" :class="{'font-bold': slotView === 'grounds'}" x-text="selectedMunicipality?.name"></button>
                    </span>
                </template>
                <template x-if="selectedGround">
                    <span class="flex items-center gap-2">
                        <span class="text-gray-400">/</span>
                        <span class="font-bold" x-text="selectedGround?.name"></span>
                    </span>
                </template>
            </div>

            <!-- Ëá™Ê≤ª‰Ωì‰∏ÄË¶ß -->
            <div x-show="slotView === 'municipalities'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Ëá™Ê≤ª‰ΩìÂà•Á©∫„ÅçÁä∂Ê≥Å</h2>
                    <button @click="loadSlots(); loadGrounds()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Êõ¥Êñ∞</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="m in municipalities" :key="m.id">
                        <div @click="selectMunicipality(m)" 
                             class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-semibold" x-text="m.name"></h3>
                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800" 
                                      x-text="getSlotsForMunicipality(m.id).length + '‰ª∂'"></span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1" x-text="getGroundsForMunicipality(m.id).length + 'ÊñΩË®≠'"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- „Ç∞„É©„Ç¶„É≥„Éâ‰∏ÄË¶ß -->
            <div x-show="slotView === 'grounds' && selectedMunicipality">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" x-text="selectedMunicipality?.name + ' „ÅÆÊñΩË®≠'"></h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="g in getGroundsForMunicipality(selectedMunicipality?.id)" :key="g.id">
                        <div @click="selectGround(g)" 
                             class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-semibold" x-text="g.name"></h3>
                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800" 
                                      x-text="getSlotsForGround(g.id).length + '‰ª∂'"></span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1" x-text="g.court_pattern || ''"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫ -->
            <div x-show="slotView === 'calendar' && selectedGround">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" x-text="selectedGround?.name + ' „ÅÆÁ©∫„ÅçÁä∂Ê≥Å'"></h2>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button @click="prevMonth()" class="px-4 py-2 hover:bg-gray-100 rounded">&larr; ÂâçÊúà</button>
                    <h3 class="text-lg font-semibold" x-text="calendarYear + 'Âπ¥' + (calendarMonth + 1) + 'Êúà'"></h3>
                    <button @click="nextMonth()" class="px-4 py-2 hover:bg-gray-100 rounded">ÁøåÊúà &rarr;</button>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="grid grid-cols-7 bg-gray-50 border-b">
                        <template x-for="day in ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']" :key="day">
                            <div class="py-2 text-center text-sm font-medium" :class="day === 'Êó•' ? 'text-red-500' : day === 'Âúü' ? 'text-blue-500' : 'text-gray-700'" x-text="day"></div>
                        </template>
                    </div>
                    <div class="grid grid-cols-7">
                        <template x-for="(day, idx) in calendarDays" :key="idx">
                            <div
                                class="min-h-[80px] border-b border-r p-1 cursor-pointer transition-colors"
                                :class="{
                                    'bg-gray-50': !day.currentMonth,
                                    'hover:bg-indigo-50': day.currentMonth,
                                    'bg-indigo-100': selectedDate === day.dateStr,
                                    'border-l': idx % 7 === 0
                                }"
                                @click="day.currentMonth && selectDate(day.dateStr)"
                            >
                                <div class="flex justify-between items-start">
                                    <span class="text-sm font-medium"
                                        :class="{
                                            'text-gray-400': !day.currentMonth,
                                            'text-red-500': day.currentMonth && day.dayOfWeek === 0,
                                            'text-blue-500': day.currentMonth && day.dayOfWeek === 6,
                                            'text-gray-900': day.currentMonth && day.dayOfWeek > 0 && day.dayOfWeek < 6
                                        }"
                                        x-text="day.day"
                                    ></span>
                                    <template x-if="day.currentMonth && getSlotsForGroundDate(selectedGround?.id, day.dateStr).length > 0">
                                        <span class="px-1.5 py-0.5 text-xs font-bold rounded-full bg-green-500 text-white" 
                                              x-text="getSlotsForGroundDate(selectedGround?.id, day.dateStr).length"></span>
                                    </template>
                                </div>
                                <div class="mt-1 space-y-0.5 overflow-hidden max-h-[40px]">
                                    <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, day.dateStr).slice(0, 2)" :key="slot.id">
                                        <div class="text-xs px-1 py-0.5 bg-green-100 text-green-800 rounded truncate" x-text="slot.time_from + '-' + slot.time_to"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Selected Date Detail -->
                <div x-show="selectedDate" class="mt-6 bg-white rounded-lg shadow p-4">
                    <h3 class="text-lg font-bold mb-4" x-text="formatDateFull(selectedDate) + ' „ÅÆÁ©∫„ÅçÊû†'"></h3>
                    <div x-show="getSlotsForGroundDate(selectedGround?.id, selectedDate).length === 0" class="text-gray-500 text-center py-4">
                        „Åì„ÅÆÊó•„ÅÆÁ©∫„ÅçÊû†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                    <div class="space-y-2">
                        <template x-for="slot in getSlotsForGroundDate(selectedGround?.id, selectedDate)" :key="slot.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                <div>
                                    <span class="font-medium" x-text="slot.time_from + ' - ' + slot.time_to"></span>
                                    <span class="ml-2 text-gray-600" x-text="slot.court_name || ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Stats -->
                <div class="mt-4 text-sm text-gray-500">
                    <span x-text="getSlotsForGround(selectedGround?.id).length"></span>‰ª∂„ÅÆÁ©∫„ÅçÊû†
                </div>
            </div>
        </div>

        <!-- Worker -->
        <div x-show="currentTab === 'worker'" x-cloak>
            <!-- Header with actions -->
            <div class="mb-4">
                <h2 class="text-xl md:text-2xl font-bold mb-3">„ÉØ„Éº„Ç´„ÉºÁÆ°ÁêÜ</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select x-model="selectedMunicipalityForScrape" class="border rounded px-3 py-2 text-sm flex-1">
                        <option value="">ÂÖ®„Å¶„ÅÆËá™Ê≤ª‰Ωì</option>
                        <template x-for="m in municipalities" :key="m.id">
                            <option :value="m.id" x-text="m.name"></option>
                        </template>
                    </select>
                    <div class="flex gap-2">
                        <button @click="triggerScrape()" :disabled="scrapeRunning" class="flex-1 sm:flex-none bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50 text-sm">
                            <span x-show="!scrapeRunning">„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞</span>
                            <span x-show="scrapeRunning">ÂÆüË°å‰∏≠...</span>
                        </button>
                        <button @click="loadJobs()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">Êõ¥Êñ∞</button>
                    </div>
                </div>
            </div>

            <!-- Job Stats - Compact on mobile -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white rounded-lg shadow p-3 text-center">
                    <div class="text-gray-500 text-xs">ÂÆüË°å‰∏≠</div>
                    <div class="text-xl font-bold text-yellow-600" x-text="jobs.filter(j => j.status === 'running').length"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 text-center">
                    <div class="text-gray-500 text-xs">ÂÆå‰∫Ü</div>
                    <div class="text-xl font-bold text-green-600" x-text="jobs.filter(j => j.status === 'completed').length"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 text-center">
                    <div class="text-gray-500 text-xs">Â§±Êïó</div>
                    <div class="text-xl font-bold text-red-600" x-text="jobs.filter(j => j.status === 'failed').length"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 text-center">
                    <div class="text-gray-500 text-xs">„Çπ„É≠„ÉÉ„Éà</div>
                    <div class="text-xl font-bold text-indigo-600" x-text="jobs.reduce((sum, j) => sum + (j.slots_found || 0), 0)"></div>
                </div>
            </div>

            <!-- Recent Jobs - Card layout for mobile -->
            <div class="bg-white rounded-lg shadow mb-4">
                <div class="px-4 py-3 bg-gray-50 border-b">
                    <h3 class="font-semibold text-sm">ÊúÄËøë„ÅÆ„Ç∏„Éß„Éñ</h3>
                </div>
                
                <!-- Mobile: Card view -->
                <div class="md:hidden divide-y">
                    <template x-for="job in jobs" :key="job.id">
                        <div class="p-3" @click="showJobDetails(job)">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm" x-text="job.municipality_name || job.municipality_id"></span>
                                <span class="px-2 py-0.5 text-xs rounded" :class="{
                                    'bg-green-100 text-green-800': job.scrape_status === 'success',
                                    'bg-blue-100 text-blue-800': job.scrape_status === 'success_no_slots',
                                    'bg-red-100 text-red-800': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                    'bg-yellow-100 text-yellow-800': job.status === 'running',
                                    'bg-gray-100 text-gray-800': !job.scrape_status && job.status !== 'running'
                                }" x-text="job.status === 'running' ? 'ÂÆüË°å‰∏≠' : formatScrapeStatus(job.scrape_status)"></span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span x-text="job.slots_found ? job.slots_found + '‰ª∂„ÅÆÁ©∫„Åç' : 'Á©∫„Åç„Å™„Åó'"></span>
                                <span x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at) || '-'"></span>
                            </div>
                            <div x-show="job.error_message" class="mt-1 text-xs text-red-600 truncate" x-text="job.error_message"></div>
                        </div>
                    </template>
                    <div x-show="jobs.length === 0" class="p-4 text-center text-gray-500 text-sm">„Ç∏„Éß„Éñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>

                <!-- Desktop: Table view -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ëá™Ê≤ª‰Ωì</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÁµêÊûú</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„É≠„ÉÉ„Éà</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÂàª</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ë©≥Á¥∞</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="job in jobs" :key="job.id">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm" x-text="job.municipality_name || job.municipality_id"></td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs rounded" :class="{
                                            'bg-yellow-100 text-yellow-800': job.status === 'running',
                                            'bg-green-100 text-green-800': job.status === 'completed',
                                            'bg-red-100 text-red-800': job.status === 'failed',
                                            'bg-gray-100 text-gray-800': job.status === 'pending'
                                        }" x-text="job.status"></span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs rounded" :class="{
                                            'bg-green-100 text-green-800': job.scrape_status === 'success',
                                            'bg-blue-100 text-blue-800': job.scrape_status === 'success_no_slots',
                                            'bg-red-100 text-red-800': job.scrape_status === 'parse_error' || job.scrape_status === 'network_error',
                                            'bg-gray-100 text-gray-800': !job.scrape_status
                                        }" x-text="formatScrapeStatus(job.scrape_status)"></span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm" x-text="job.slots_found || 0"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="formatDateTime(job.completed_at) || formatDateTime(job.started_at)"></td>
                                    <td class="px-4 py-3">
                                        <button @click="showJobDetails(job)" class="text-indigo-600 hover:text-indigo-800 text-sm" x-show="job.error_message || job.diagnostics">Ë©≥Á¥∞</button>
                                        <span x-show="!job.error_message && !job.diagnostics" class="text-gray-400">-</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Logs - Collapsible on mobile -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center" @click="showLogs = !showLogs">
                    <h3 class="font-semibold text-sm">„É≠„Ç∞</h3>
                    <div class="flex items-center space-x-2">
                        <label class="hidden sm:flex items-center text-sm" @click.stop>
                            <input type="checkbox" x-model="autoScrollLogs" class="mr-1"> Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                        </label>
                        <button @click.stop="clearLogs()" class="text-sm text-gray-500 hover:text-gray-700">„ÇØ„É™„Ç¢</button>
                        <svg class="w-5 h-5 md:hidden transition-transform" :class="{'rotate-180': showLogs}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div x-show="showLogs" x-cloak class="md:block" id="log-container" :class="{'h-40': true, 'md:h-64': true}" class="overflow-y-auto bg-gray-900 text-gray-100 p-3 font-mono text-xs">
                    <template x-for="(log, idx) in workerLogs" :key="idx">
                        <div :class="{
                            'text-red-400': log.level === 'error',
                            'text-yellow-400': log.level === 'warn',
                            'text-green-400': log.level === 'info',
                            'text-gray-400': log.level === 'debug'
                        }">
                            <span class="text-gray-500" x-text="log.time"></span>
                            <span class="ml-1" x-text="'[' + log.level.toUpperCase() + ']'"></span>
                            <span class="ml-1" x-text="log.message"></span>
                        </div>
                    </template>
                    <div x-show="workerLogs.length === 0" class="text-gray-500">„É≠„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>
            </div>
        </div>

        <!-- AI Support -->
        <div x-show="currentTab === 'support'" x-cloak>
            <h2 class="text-2xl font-bold mb-6">AI„Çµ„Éù„Éº„Éà</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ü§ñ AI„ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="h-64 overflow-y-auto border rounded p-4 mb-4 bg-gray-50">
                        <template x-for="(msg, i) in chatMessages" :key="i">
                            <div class="mb-2" :class="{'text-right': msg.role === 'user'}">
                                <span class="inline-block px-3 py-2 rounded-lg" :class="{'bg-indigo-600 text-white': msg.role === 'user', 'bg-gray-200': msg.role === 'ai'}" x-text="msg.content" style="white-space: pre-wrap;"></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" x-model="chatInput" @keydown.enter.prevent="handleChatKeydown($event)" @compositionstart="isComposing = true" @compositionend="isComposing = false" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ... (Shift+Enter„ÅßÈÄÅ‰ø°)" class="flex-1 border rounded px-4 py-2">
                        <button @click="sendChat()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ÈÄÅ‰ø°</button>
                    </div>
                </div>
                <!-- Tickets -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üéüÔ∏è „Çµ„Éù„Éº„Éà„ÉÅ„Ç±„ÉÉ„Éà</h3>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        <template x-for="ticket in tickets" :key="ticket.id">
                            <div class="border rounded p-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium" x-text="ticket.subject"></span>
                                    <span class="px-2 py-1 text-xs rounded" :class="{'bg-red-100 text-red-800': ticket.status === 'open', 'bg-yellow-100': ticket.status === 'escalated', 'bg-green-100 text-green-800': ticket.status === 'resolved'}" x-text="ticket.status"></span>
                                </div>
                                <div class="text-sm text-gray-500" x-text="ticket.email"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Team Modal -->
    <div x-show="showTeamModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Ë¶è„ÉÅ„Éº„É†ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">„ÉÅ„Éº„É†Âêç</label>
                    <input type="text" x-model="newTeam.name" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" x-model="newTeam.email" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„Éó„É©„É≥</label>
                    <select x-model="newTeam.plan" class="mt-1 block w-full border rounded px-3 py-2">
                        <option value="free">Free</option>
                        <option value="personal">Personal</option>
                        <option value="pro">Pro</option>
                        <option value="org">Org</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showTeamModal = false" class="px-4 py-2 border rounded">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createTeam()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <!-- Facility Modal -->
    <div x-show="showFacilityModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Êñ∞Ë¶èÊñΩË®≠ËøΩÂä†</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ÊñΩË®≠Âêç</label>
                    <input type="text" x-model="newFacility.name" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ëá™Ê≤ª‰Ωì</label>
                    <input type="text" x-model="newFacility.municipality" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">„Çπ„ÇØ„É¨„Ç§„Éë„Éº„Çø„Ç§„Éó</label>
                    <input type="text" x-model="newFacility.scraper_type" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">URL</label>
                    <input type="url" x-model="newFacility.url" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button @click="showFacilityModal = false" class="px-4 py-2 border rounded">„Ç≠„É£„É≥„Çª„É´</button>
                <button @click="createFacility()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <script>
    function app() {
        return {
            currentTab: 'dashboard',
            mobileMenuOpen: false,
            dashboard: { TeamCount: 0, FacilityCount: 0, WatchConditionCount: 0, NotificationCount: 0, OpenTicketCount: 0, TeamsByPlan: [] },
            teams: [],
            facilities: [],
            grounds: [],
            slots: [],
            municipalities: [],
            // Drilldown state
            slotView: 'municipalities',  // municipalities -> grounds -> calendar
            selectedMunicipality: null,
            selectedGround: null,
            slotFilter: { municipalityId: '' },
            // Calendar state
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            selectedDate: null,
            // Worker state
            showLogs: window.innerWidth >= 768,  // Show logs by default on desktop
            jobs: [],
            workerLogs: [],
            scrapeRunning: false,
            selectedMunicipalityForScrape: '',
            autoScrollLogs: true,
            // Other
            tickets: [],
            chatMessages: [],
            chatInput: '',
            isComposing: false,
            showTeamModal: false,
            showFacilityModal: false,
            newTeam: { name: '', email: '', plan: 'free' },
            newFacility: { name: '', municipality: '', scraper_type: '', url: '' },

            async init() {
                await this.loadDashboard();
                await this.loadTeams();
                await this.loadFacilities();
                await this.loadMunicipalities();
                await this.loadGrounds();
                await this.loadSlots();
                await this.loadJobs();
                await this.loadTickets();
            },

            async loadDashboard() {
                const res = await fetch('/api/dashboard');
                this.dashboard = await res.json();
            },

            async loadTeams() {
                const res = await fetch('/api/teams');
                this.teams = await res.json() || [];
            },

            async loadFacilities() {
                const res = await fetch('/api/grounds');
                const grounds = await res.json();
                // Map grounds to facilities format
                this.facilities = (grounds || []).map(g => ({
                    id: g.id,
                    name: g.name,
                    municipality: g.municipality_name,
                    scraper_type: g.court_pattern,
                    enabled: g.enabled
                }));
            },

            async loadMunicipalities() {
                const res = await fetch('/api/municipalities');
                this.municipalities = await res.json() || [];
            },

            async loadGrounds() {
                const res = await fetch('/api/grounds');
                this.grounds = await res.json() || [];
            },

            async loadSlots() {
                // Load all slots (increased limit needed in API)
                const res = await fetch('/api/slots?limit=5000');
                this.slots = await res.json() || [];
            },

            // Calendar methods
            get calendarDays() {
                const days = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay();

                const prevMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const d = prevMonth.getDate() - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: true, dayOfWeek: date.getDay() });
                }

                const remaining = 42 - days.length;
                for (let d = 1; d <= remaining; d++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, d);
                    days.push({ day: d, dateStr: this.toDateStr(date), currentMonth: false, dayOfWeek: date.getDay() });
                }
                return days;
            },

            toDateStr(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            },

            prevMonth() {
                const d = new Date(this.calendarYear, this.calendarMonth - 1, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            nextMonth() {
                const d = new Date(this.calendarYear, this.calendarMonth + 1, 1);
                this.calendarYear = d.getFullYear();
                this.calendarMonth = d.getMonth();
                this.selectedDate = null;
            },

            selectDate(dateStr) {
                this.selectedDate = this.selectedDate === dateStr ? null : dateStr;
            },

            getSlotsForDate(dateStr) {
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            // Drilldown methods
            getGroundsForMunicipality(municipalityId) {
                return this.grounds.filter(g => g.municipality_id === municipalityId);
            },

            getSlotsForMunicipality(municipalityId) {
                return this.slots.filter(s => s.municipality_id === municipalityId);
            },

            getSlotsForGround(groundId) {
                if (!groundId) return [];
                return this.slots.filter(s => s.ground_id === groundId);
            },

            getSlotsForGroundDate(groundId, dateStr) {
                if (!groundId) return [];
                return this.slots.filter(s => {
                    const slotDate = s.slot_date.split('T')[0];
                    return s.ground_id === groundId && slotDate === dateStr;
                }).sort((a, b) => a.time_from.localeCompare(b.time_from));
            },

            selectMunicipality(m) {
                this.selectedMunicipality = m;
                this.selectedGround = null;
                this.slotView = 'grounds';
            },

            selectGround(g) {
                this.selectedGround = g;
                this.selectedDate = null;
                this.slotView = 'calendar';
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                const month = d.getMonth() + 1;
                const day = d.getDate();
                const dow = days[d.getDay()];
                return `${month}/${day}(${dow})`;
            },

            formatDateFull(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•(${days[d.getDay()]})`;
            },

            formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            },

            formatScrapeStatus(status) {
                const statusMap = {
                    'success': '‚úÖ Á©∫„Åç„ÅÇ„Çä',
                    'success_no_slots': '‚ÑπÔ∏è Á©∫„Åç„Å™„Åó',
                    'parse_error': '‚ùå Ëß£Êûê„Ç®„É©„Éº',
                    'network_error': '‚ùå ÈÄö‰ø°„Ç®„É©„Éº',
                    'no_table_found': '‚ö†Ô∏è „ÉÜ„Éº„Éñ„É´„Å™„Åó',
                    'unknown_facility': '‚ùå ‰∏çÊòé„Å™ÊñΩË®≠',
                    'scraper_unavailable': '‚ùå „Çπ„ÇØ„É¨„Ç§„Éë„ÉºÂà©Áî®‰∏çÂèØ',
                    'execution_error': '‚ùå ÂÆüË°å„Ç®„É©„Éº'
                };
                return statusMap[status] || status || '-';
            },

            showJobDetails(job) {
                let details = '';
                if (job.error_message) {
                    details += `„Ç®„É©„Éº: ${job.error_message}\n\n`;
                }
                if (job.diagnostics) {
                    try {
                        const diag = JSON.parse(job.diagnostics);
                        details += 'Ë®∫Êñ≠ÊÉÖÂ†±:\n';
                        if (diag.note) details += `  „É°„É¢: ${diag.note}\n`;
                        if (diag.html_verification) {
                            const v = diag.html_verification;
                            if (v.server_message) details += `  „Çµ„Éº„Éê„ÉºÂõûÁ≠î: ${v.server_message}\n`;
                            if (v.confirmation) details += `  Á¢∫Ë™ç: ${v.confirmation}\n`;
                        }
                        if (diag.raw_results_count !== undefined) details += `  ÁîüÁµêÊûúÊï∞: ${diag.raw_results_count}\n`;
                        if (diag.parsed_slots_count !== undefined) details += `  Ëß£ÊûêÊ∏à„Åø: ${diag.parsed_slots_count}\n`;
                        if (diag.parse_errors) details += `  Ëß£Êûê„Ç®„É©„Éº: ${diag.parse_errors}\n`;
                    } catch (e) {
                        details += `Ë®∫Êñ≠ÊÉÖÂ†±: ${job.diagnostics}`;
                    }
                }
                if (details) {
                    alert(details);
                }
            },

            // Worker methods
            async loadJobs() {
                const res = await fetch('/api/jobs');
                const data = await res.json();
                this.jobs = data || [];
            },

            async triggerScrape() {
                this.scrapeRunning = true;
                this.addLog('info', '„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞„ÇíÈñãÂßã„Åó„Åæ„Åô...');
                try {
                    const url = this.selectedMunicipalityForScrape 
                        ? `/api/scrape?municipality_id=${this.selectedMunicipalityForScrape}`
                        : '/api/scrape';
                    const res = await fetch(url, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        this.addLog('info', `„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞ÂÆå‰∫Ü: ${data.message}`);
                    } else {
                        this.addLog('error', `„Ç®„É©„Éº: ${data.error}`);
                    }
                } catch (e) {
                    this.addLog('error', `„É™„ÇØ„Ç®„Çπ„ÉàÂ§±Êïó: ${e.message}`);
                } finally {
                    this.scrapeRunning = false;
                    await this.loadJobs();
                    await this.loadSlots();
                }
            },

            addLog(level, message) {
                const now = new Date();
                const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                this.workerLogs.push({ level, message, time });
                if (this.workerLogs.length > 500) this.workerLogs.shift();
                if (this.autoScrollLogs) {
                    this.$nextTick(() => {
                        const container = document.getElementById('log-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                }
            },

            clearLogs() {
                this.workerLogs = [];
            },

            async loadTickets() {
                const res = await fetch('/api/tickets');
                this.tickets = await res.json();
            },

            async createTeam() {
                await fetch('/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newTeam)
                });
                this.showTeamModal = false;
                this.newTeam = { name: '', email: '', plan: 'free' };
                await this.loadTeams();
                await this.loadDashboard();
            },

            async createFacility() {
                await fetch('/api/facilities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newFacility)
                });
                this.showFacilityModal = false;
                this.newFacility = { name: '', municipality: '', scraper_type: '', url: '' };
                await this.loadFacilities();
                await this.loadDashboard();
            },

            handleChatKeydown(event) {
                // IMEÂ§âÊèõ‰∏≠„ÅØÈÄÅ‰ø°„Åó„Å™„ÅÑ
                if (this.isComposing) return;
                // Shift+Enter„ÅßÈÄÅ‰ø°
                if (event.shiftKey) {
                    this.sendChat();
                }
            },

            async sendChat() {
                if (!this.chatInput.trim()) return;
                const msg = this.chatInput;
                this.chatMessages.push({ role: 'user', content: msg });
                this.chatInput = '';
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                this.chatMessages.push({ role: 'ai', content: data.response });
            }
        }
    }
    </script>
</body>
</html>
